{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Aero driver packaging manifest",
  "type": "object",
  "$defs": {
    "driverRelativePath": {
      "type": "string",
      "minLength": 1,
      "allOf": [
        {
          "not": {
            "description": "Disallow absolute paths, drive-letter rooted paths, and UNC roots (paths must be relative to the expected root directory).",
            "pattern": "^(?:[A-Za-z]:|[\\\\/])"
          }
        },
        {
          "not": {
            "description": "Best-effort: disallow '..' segments (even if they would normalize back under the expected root directory).",
            "pattern": "(^|[\\\\/])\\.\\.([\\\\/]|$)"
          }
        }
      ]
    }
  },
  "additionalProperties": false,
  "properties": {
    "$schema": {
      "type": "string",
      "description": "Optional JSON Schema reference for editor tooling (example: \"../../ci/driver-package.schema.json\"). CI ignores this field. Update the relative path as needed if your driver directory is nested (for example, drivers/windows7/<driver>/...).",
      "minLength": 1
    },
    "infFiles": {
      "type": "array",
      "description": "Optional list of INF files (paths relative to the driver directory) to stage for this driver. If omitted, CI discovers all .inf files under the driver directory. Use this to disambiguate drivers that ship multiple INFs (e.g. optional feature variants) that should not be packaged together. If present, the list must be non-empty. Paths must be relative to the driver directory (no absolute paths / drive letters / UNC roots) and must not contain '..' segments. CI additionally validates that each path exists and has a .inf extension. CI stages selected INFs into the package root by file name; ensure INF file names are unique within the driver.",
      "minItems": 1,
      "items": {
        "allOf": [
          { "$ref": "#/$defs/driverRelativePath" },
          { "pattern": "^.+\\.[iI][nN][fF]$" }
        ]
      },
      "uniqueItems": true
    },
    "wow64Files": {
      "type": "array",
      "description": "Optional list of WOW64 payload files to copy from the x86 build output into the x64 staged package directory *before* stamping INFs and running Inf2Cat. Entries must be .dll file names only (no path separators). Intended for x64 driver packages that also need 32-bit user-mode components (WOW64 UMD DLLs). Requires x86 build outputs to be present even when generating/staging x64 packages. WOW64 payloads are copied into the x64 package root; ensure file names do not collide with 64-bit build outputs (use distinct names such as a '_x64' suffix).",
      "items": {
        "type": "string",
        "minLength": 1,
        "pattern": "^[^\\\\/:]+\\.[dD][lL][lL]$"
      },
      "uniqueItems": true
    },
    "requiredBuildOutputFiles": {
      "type": "array",
      "description": "Optional list of additional files (paths relative to the per-arch build output directory under out/drivers/<driver>/<arch>/) that must exist after building. CI will fail packaging if any listed path is missing. Intended for auxiliary build products that should ship alongside the driver (for example, in-guest debug utilities such as aerogpu_dbgctl.exe). Paths must be relative (no absolute paths / drive letters / UNC roots) and must not contain '..' segments.",
      "items": {
        "$ref": "#/$defs/driverRelativePath"
      },
      "uniqueItems": true
    },
    "additionalFiles": {
      "type": "array",
      "description": "Additional files (paths relative to the driver directory) to include in the staged driver package. Intended for non-binary files such as README/license text or install scripts. Paths must be relative to the driver directory (no absolute paths / drive letters / UNC roots), must not contain '..' segments, and must resolve under the driver directory. CI refuses to include common binary extensions via this mechanism (currently: .sys, .dll, .exe, .cat, .msi, .cab) and refuses likely secret/private key material (for example: .pfx, .pvk, .snk, .pem, .key). CI additionally validates that each path exists.",
      "items": {
        "allOf": [
          { "$ref": "#/$defs/driverRelativePath" },
          {
            "not": {
              "description": "Disallow common binary extensions in additionalFiles (CI refuses these at packaging time).",
              "pattern": "\\.([sS][yY][sS]|[dD][lL][lL]|[eE][xX][eE]|[cC][aA][tT]|[mM][sS][iI]|[cC][aA][bB])$"
            }
          },
          {
            "not": {
              "description": "Disallow likely secret/private key material in additionalFiles (CI refuses these at packaging time).",
              "pattern": "\\.([pP][fF][xX]|[pP]12|[pP][vV][kK]|[sS][nN][kK]|[kK][eE][yY]|[pP][eE][mM]|[pP]8|[pP][pP][kK]|[jJ][kK][sS]|[kK][eE][yY][sS][tT][oO][rR][eE]|[kK][dD][bB][xX]|[gG][pP][gG]|[pP][gG][pP])$"
            }
          }
        ]
      },
      "uniqueItems": true
    },
    "toolFiles": {
      "type": "array",
      "description": "Optional list of user-mode helper tool binaries (paths relative to the driver directory) to include in the staged driver package. This is the explicit opt-in mechanism for shipping .exe tools alongside the driver package without relaxing the additionalFiles non-binary policy. Paths must resolve under the driver directory (no absolute paths; cannot escape the driver directory).",
      "items": {
        "allOf": [
          { "$ref": "#/$defs/driverRelativePath" },
          { "pattern": "^.+\\.[eE][xX][eE]$" }
        ]
      },
      "uniqueItems": true
    },
    "wdfCoInstaller": {
      "type": "object",
      "description": "If present, this driver package requires a WDF coinstaller (WdfCoInstaller*.dll) for older systems. This file is a Microsoft WDK redistributable and is NOT included by default (see docs).",
      "additionalProperties": false,
      "required": ["kmdfVersion"],
      "properties": {
        "kmdfVersion": {
          "type": "string",
          "description": "KMDF version required by this driver (e.g. 1.9, 1.11, 1.15). Used to derive the default DLL name if dllName is omitted.",
          "pattern": "^\\d+\\.\\d+$"
        },
        "dllName": {
          "type": "string",
          "description": "Optional explicit DLL filename (e.g. WdfCoInstaller01011.dll). If omitted, CI derives it from kmdfVersion.",
          "pattern": "^WdfCoInstaller\\d{5}\\.dll$"
        }
      }
    }
  }
}
