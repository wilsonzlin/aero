name: IaC (Terraform + Helm/K8s)

on:
  pull_request:
    paths:
      - infra/**
      - deploy/k8s/**
      - deploy/docker-compose.yml
      - docker-compose.yml
      - compose.yaml
      - scripts/ci/check-deploy-manifests.mjs
      - .github/workflows/iac.yml
  schedule:
    # Weekly safety net: catch drift (Helm/K8s API changes, Terraform/provider updates, etc).
    - cron: "17 3 * * 1"
  workflow_dispatch:

concurrency:
  group: iac-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  terraform:
    name: Terraform (fmt + validate)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        module:
          - infra/aws-s3-cloudfront-range
    env:
      TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5
          terraform_wrapper: false

      - name: Prepare Terraform plugin cache
        shell: bash
        run: mkdir -p "$TF_PLUGIN_CACHE_DIR"

      - name: Cache Terraform plugins
        uses: actions/cache@v4
        with:
          path: ~/.terraform.d/plugin-cache
          key: ${{ runner.os }}-terraform-${{ hashFiles('infra/**/.terraform.lock.hcl') }}
          restore-keys: |
            ${{ runner.os }}-terraform-

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.53.0

      - name: Cache TFLint plugins
        uses: actions/cache@v4
        with:
          path: ~/.tflint.d/plugins
          key: ${{ runner.os }}-tflint-${{ hashFiles('infra/**/.tflint.hcl') }}
          restore-keys: |
            ${{ runner.os }}-tflint-

      - name: terraform fmt (check)
        working-directory: ${{ matrix.module }}
        run: terraform fmt -check -recursive

      - name: terraform init (backend disabled)
        working-directory: ${{ matrix.module }}
        run: terraform init -backend=false -input=false

      - name: terraform validate
        working-directory: ${{ matrix.module }}
        run: terraform validate -no-color

      - name: tflint (init)
        working-directory: ${{ matrix.module }}
        run: tflint --init

      - name: tflint
        working-directory: ${{ matrix.module }}
        run: tflint --format compact

  k8s:
    name: Helm + kubeconform
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      K8S_VERSION: "1.28.0"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Install kubeconform
        shell: bash
        run: |
          set -euo pipefail
          KUBECONFORM_VERSION="0.6.6"
          curl -sSL -o /tmp/kubeconform.tar.gz "https://github.com/yannh/kubeconform/releases/download/v${KUBECONFORM_VERSION}/kubeconform-linux-amd64.tar.gz"
          tar -C /tmp -xzf /tmp/kubeconform.tar.gz kubeconform
          sudo mv /tmp/kubeconform /usr/local/bin/kubeconform
          kubeconform -v

      - name: Cache kubeconform schemas
        uses: actions/cache@v4
        with:
          path: ~/.cache/kubeconform
          key: ${{ runner.os }}-kubeconform-${{ env.K8S_VERSION }}
          restore-keys: |
            ${{ runner.os }}-kubeconform-

      - name: helm lint (example values)
        shell: bash
        run: |
          set -euo pipefail
          CHART="deploy/k8s/chart/aero-gateway"
          helm lint "$CHART" -f "$CHART/values-dev.yaml"
          helm lint "$CHART" -f "$CHART/values-prod.yaml"
          helm lint "$CHART" -f "$CHART/values-traefik.yaml"
          helm lint "$CHART" -f "$CHART/values-prod-certmanager.yaml"
          helm lint "$CHART" -f "$CHART/values-prod-certmanager-issuer.yaml"
          helm lint "$CHART" -f "$CHART/values-prod-appheaders.yaml"

      - name: helm template + kubeconform (example values)
        shell: bash
        run: |
          set -euo pipefail
          CHART="deploy/k8s/chart/aero-gateway"
          KUBECONFORM_CACHE_DIR="$HOME/.cache/kubeconform"
          mkdir -p "$KUBECONFORM_CACHE_DIR"

          for values in \
            values-dev.yaml \
            values-prod.yaml \
            values-traefik.yaml \
            values-prod-certmanager.yaml \
            values-prod-certmanager-issuer.yaml \
            values-prod-appheaders.yaml; do
            out="/tmp/aero-gateway-${values%.yaml}.yaml"
            helm template aero-gateway "$CHART" -n aero -f "$CHART/$values" > "$out"

            kubeconform \
              -cache "$KUBECONFORM_CACHE_DIR" \
              -strict \
              -ignore-missing-schemas \
              -schema-location default \
              -schema-location "https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json" \
              -kubernetes-version "$K8S_VERSION" \
              -summary \
              "$out"

            # Ensure cross-origin isolation + CSP strategy is present in the ingress layer
            # when using ingress-level header injection.
            #
            # `values-prod-appheaders.yaml` intentionally disables ingress header injection
            # (COOP/COEP/CSP are set at the app/proxy layer instead).
            if [[ "$values" != "values-prod-appheaders.yaml" ]]; then
              python3 - "$out" <<'PY'
import json
import sys
from pathlib import Path

out_path = sys.argv[1]
text = Path(out_path).read_text(encoding="utf-8")

headers = json.loads(Path("scripts/headers.json").read_text(encoding="utf-8"))
expected = {}
expected.update(headers.get("crossOriginIsolation", {}))
expected.update(headers.get("baseline", {}))
expected.update(headers.get("contentSecurityPolicy", {}))

missing = []
for key, value in expected.items():
    # nginx snippet form:
    if f'add_header {key} "{value}"' in text:
        continue
    # Traefik middleware YAML form:
    if f'{key}: "{value}"' in text:
        continue
    missing.append(key)

if missing:
    print(f"Rendered Helm manifests missing canonical headers: {', '.join(missing)}", file=sys.stderr)
    sys.exit(1)

print("Validated ingress header strategy against scripts/headers.json")
PY
            fi
          done

      - name: kubeconform (raw manifests)
        shell: bash
        run: |
          set -euo pipefail
          KUBECONFORM_CACHE_DIR="$HOME/.cache/kubeconform"
          mkdir -p "$KUBECONFORM_CACHE_DIR"
          kubeconform -cache "$KUBECONFORM_CACHE_DIR" -strict -ignore-missing-schemas -schema-location default -schema-location "https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json" -kubernetes-version "$K8S_VERSION" -summary deploy/k8s/aero-storage-server
          kubeconform -cache "$KUBECONFORM_CACHE_DIR" -strict -ignore-missing-schemas -schema-location default -schema-location "https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json" -kubernetes-version "$K8S_VERSION" -summary deploy/k8s/examples/cert-manager

  deploy-hygiene:
    name: Deploy manifest hygiene
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc

      - name: Check deployment manifest labels
        run: node scripts/ci/check-deploy-manifests.mjs
