name: Fuzz (smoke)

on:
  push:
    paths-ignore:
      - "docs/**"
      - "**/*.md"
  pull_request:
    paths-ignore:
      - "docs/**"
      - "**/*.md"

jobs:
  fuzz:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        id: setup-rust
        uses: ./.github/actions/setup-rust
        with:
          toolchain: nightly
          locked: always

      - name: Install cargo-fuzz
        run: cargo install --locked cargo-fuzz

      - name: Verify fuzz Cargo.lock is up to date
        run: cargo metadata ${{ steps.setup-rust.outputs.cargo_locked_flag }} --format-version 1 --manifest-path fuzz/Cargo.toml >/dev/null

      - name: fuzz_mmu_translate (10s)
        run: cargo +${{ steps.setup-rust.outputs.rust_toolchain }} fuzz run fuzz_mmu_translate -- -max_total_time=10

      - name: fuzz_bus_rw (10s)
        run: cargo +${{ steps.setup-rust.outputs.rust_toolchain }} fuzz run fuzz_bus_rw -- -max_total_time=10

      - name: fuzz_aerogpu_parse (10s)
        run: cargo +${{ steps.setup-rust.outputs.rust_toolchain }} fuzz run fuzz_aerogpu_parse -- -max_total_time=10

      - name: fuzz_aerosparse_open (10s)
        run: cargo +${{ steps.setup-rust.outputs.rust_toolchain }} fuzz run fuzz_aerosparse_open -- -max_total_time=10 -dict=fuzz/fuzz_targets/fuzz_aerosparse_open.dict

      - name: fuzz_aero_storage_sparse_open (10s)
        run: cargo +${{ steps.setup-rust.outputs.rust_toolchain }} fuzz run fuzz_aero_storage_sparse_open -- -max_total_time=10 -dict=fuzz/fuzz_targets/fuzz_aero_storage_sparse_open.dict

      - name: fuzz_disk_image_open_auto (10s)
        run: cargo +${{ steps.setup-rust.outputs.rust_toolchain }} fuzz run fuzz_disk_image_open_auto -- -max_total_time=10 -dict=fuzz/fuzz_targets/fuzz_disk_image_open_auto.dict

      - name: fuzz_ahci_command (10s)
        run: cargo +${{ steps.setup-rust.outputs.rust_toolchain }} fuzz run fuzz_ahci_command -- -max_total_time=10

      - name: fuzz_ide_busmaster (10s)
        run: cargo +${{ steps.setup-rust.outputs.rust_toolchain }} fuzz run fuzz_ide_busmaster -- -max_total_time=10

      - name: Ensure fuzz lockfile was not modified
        run: git diff --exit-code -- fuzz/Cargo.lock
