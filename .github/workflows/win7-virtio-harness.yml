name: Win7 virtio harness (self-hosted)

on:
  workflow_dispatch:
    inputs:
      disk_image_path:
        description: "Path on the self-hosted runner to a prepared Win7 disk image (qcow2 recommended)"
        required: true
        type: string
      timeout_seconds:
        description: "Harness timeout in seconds (PASS/FAIL marker must appear before this deadline)"
        required: false
        default: "600"
        type: string
      snapshot:
        description: "Run QEMU in snapshot mode (discard disk writes on exit)"
        required: false
        default: true
        type: boolean
      serial_log_path:
        description: "Path (relative to the workspace or absolute) for the captured guest COM1 serial log"
        required: false
        default: "out/win7-virtio-harness/win7-virtio-serial.log"
        type: string

permissions:
  contents: read
  actions: read

jobs:
  win7-virtio-harness:
    # Opt-in only: requires a self-hosted runner with QEMU installed and a prepared Win7 disk image.
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare output directory (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p out/win7-virtio-harness

      - name: Prepare output directory (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          New-Item -ItemType Directory -Force -Path 'out/win7-virtio-harness' | Out-Null

      - name: Validate prerequisites (Linux)
        if: runner.os == 'Linux'
        shell: bash
        env:
          DISK_IMAGE_PATH: ${{ inputs.disk_image_path }}
        run: |
          set -euo pipefail
          if [[ ! -f "$DISK_IMAGE_PATH" ]]; then
            echo "ERROR: disk image not found: $DISK_IMAGE_PATH" >&2
            exit 1
          fi
          command -v qemu-system-x86_64 >/dev/null || { echo "ERROR: qemu-system-x86_64 not found in PATH" >&2; exit 1; }
          command -v python3 >/dev/null || { echo "ERROR: python3 not found in PATH" >&2; exit 1; }

      - name: Validate prerequisites (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          DISK_IMAGE_PATH: ${{ inputs.disk_image_path }}
        run: |
          $ErrorActionPreference = 'Stop'
          if (!(Test-Path -LiteralPath $env:DISK_IMAGE_PATH)) {
            throw "disk image not found: $($env:DISK_IMAGE_PATH)"
          }
          if (!(Get-Command qemu-system-x86_64 -ErrorAction SilentlyContinue)) {
            throw "qemu-system-x86_64 not found in PATH"
          }

      - name: Find prebuilt selftest artifact (win7-virtio-selftest)
        id: selftest_run
        uses: actions/github-script@v7
        with:
          script: |
            const workflowName = "win7-virtio-selftest";
            const fallbackWorkflowFile = "win7-virtio-selftest.yml";
            const sha = context.sha;
            let runId = "";
            try {
              let workflowId = fallbackWorkflowFile;
              try {
                const workflows = await github.rest.actions.listRepoWorkflows({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  per_page: 100,
                });
                const byName = workflows.data.workflows.find((w) => w.name === workflowName);
                if (byName) {
                  workflowId = byName.id;
                  core.info(`Using workflow id for '${workflowName}': ${workflowId}`);
                } else {
                  core.info(
                    `Workflow '${workflowName}' not found in repo; falling back to file name: ${fallbackWorkflowFile}`,
                  );
                }
              } catch (e) {
                core.info(
                  `Unable to list repo workflows; falling back to file name ${fallbackWorkflowFile}: ${e.message}`,
                );
              }

              const res = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: workflowId,
                per_page: 20,
              });
              const match = res.data.workflow_runs.find(
                (r) => r.head_sha === sha && r.conclusion === "success",
              );
              if (match) {
                runId = String(match.id);
                core.info(`Found ${workflowName} successful run for ${sha}: ${runId}`);
              } else {
                core.info(`No ${workflowName} successful run found for ${sha}; will attempt local build.`);
              }
            } catch (e) {
              core.info(`Unable to query ${workflowName} runs (workflow may not exist yet): ${e.message}`);
            }
            core.setOutput("run_id", runId);

      - name: Download prebuilt aero-virtio-selftest.exe (if available)
        id: selftest_download
        if: steps.selftest_run.outputs.run_id != ''
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ steps.selftest_run.outputs.run_id }}
          name: aero-virtio-selftest
          path: out/win7-virtio-harness/selftest
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build aero-virtio-selftest.exe (Windows fallback)
        if: runner.os == 'Windows' && steps.selftest_download.outcome != 'success'
        continue-on-error: true
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $buildDir = Join-Path $env:GITHUB_WORKSPACE 'out\win7-virtio-harness\build-selftest'
          cmake -S 'drivers/windows7/tests/guest-selftest' -B $buildDir -G 'Visual Studio 17 2022' -A x64
          cmake --build $buildDir --config Release
          $exe = Join-Path $buildDir 'Release\aero-virtio-selftest.exe'
          if (Test-Path -LiteralPath $exe) {
            Copy-Item -LiteralPath $exe -Destination 'out\win7-virtio-harness\aero-virtio-selftest.exe' -Force
          } else {
            throw "Expected selftest binary not found: $exe"
          }

      - name: Build aero-virtio-selftest.exe (Linux fallback, mingw-w64)
        if: runner.os == 'Linux' && steps.selftest_download.outcome != 'success'
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail
          build_dir="out/win7-virtio-harness/build-selftest"
          mkdir -p "$build_dir"
          if ! command -v x86_64-w64-mingw32-g++ >/dev/null; then
            echo "mingw-w64 not installed (x86_64-w64-mingw32-g++ missing); skipping local selftest build." >&2
            exit 0
          fi
          cmake -S drivers/windows7/tests/guest-selftest -B "$build_dir" \
            -DCMAKE_SYSTEM_NAME=Windows \
            -DCMAKE_C_COMPILER=x86_64-w64-mingw32-gcc \
            -DCMAKE_CXX_COMPILER=x86_64-w64-mingw32-g++
          cmake --build "$build_dir"
          exe="$(find "$build_dir" -name 'aero-virtio-selftest.exe' -print -quit || true)"
          if [[ -n "$exe" ]]; then
            cp "$exe" out/win7-virtio-harness/aero-virtio-selftest.exe
          else
            echo "Selftest build completed but aero-virtio-selftest.exe was not found under $build_dir" >&2
          fi

      - name: Run Win7 virtio selftests (Linux, Python harness)
        if: runner.os == 'Linux'
        shell: bash
        env:
          DISK_IMAGE_PATH: ${{ inputs.disk_image_path }}
          TIMEOUT_SECONDS: ${{ inputs.timeout_seconds }}
          SERIAL_LOG_PATH: ${{ inputs.serial_log_path }}
          SNAPSHOT: ${{ inputs.snapshot }}
        run: |
          set -euo pipefail
          extra=()
          if [[ "$SNAPSHOT" == "true" ]]; then
            extra+=(--snapshot)
          fi
          python3 drivers/windows7/tests/host-harness/invoke_aero_virtio_win7_tests.py \
            --qemu-system qemu-system-x86_64 \
            --disk-image "$DISK_IMAGE_PATH" \
            --serial-log "$SERIAL_LOG_PATH" \
            --timeout-seconds "$TIMEOUT_SECONDS" \
            --follow-serial \
            "${extra[@]}" \
            2>&1 | tee out/win7-virtio-harness/harness-output.txt

      - name: Run Win7 virtio selftests (Windows, PowerShell harness)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          DISK_IMAGE_PATH: ${{ inputs.disk_image_path }}
          TIMEOUT_SECONDS: ${{ inputs.timeout_seconds }}
          SERIAL_LOG_PATH: ${{ inputs.serial_log_path }}
          SNAPSHOT: ${{ inputs.snapshot }}
        run: |
          $ErrorActionPreference = 'Stop'
          $outDir = Join-Path $env:GITHUB_WORKSPACE 'out\win7-virtio-harness'
          $harnessLog = Join-Path $outDir 'harness-output.txt'
          $args = @(
            '-QemuSystem', 'qemu-system-x86_64',
            '-DiskImagePath', $env:DISK_IMAGE_PATH,
            '-SerialLogPath', $env:SERIAL_LOG_PATH,
            '-TimeoutSeconds', $env:TIMEOUT_SECONDS,
            '-FollowSerial'
          )
          if ($env:SNAPSHOT -eq 'true') {
            $args += '-Snapshot'
          }
          & pwsh -NoProfile -ExecutionPolicy Bypass -File 'drivers/windows7/tests/host-harness/Invoke-AeroVirtioWin7Tests.ps1' @args 2>&1 | Tee-Object -FilePath $harnessLog
          exit $LASTEXITCODE

      - name: Collect logs for artifacts (Linux)
        if: always() && runner.os == 'Linux'
        shell: bash
        env:
          SERIAL_LOG_PATH: ${{ inputs.serial_log_path }}
        run: |
          set -euo pipefail
          mkdir -p out/win7-virtio-harness
          if [[ -f "$SERIAL_LOG_PATH" ]]; then
            dest="out/win7-virtio-harness/$(basename "$SERIAL_LOG_PATH")"
            src_abs="$(realpath "$SERIAL_LOG_PATH")"
            dest_abs="$(realpath -m "$dest")"
            if [[ "$src_abs" != "$dest_abs" ]]; then
              cp "$SERIAL_LOG_PATH" "$dest"
            fi
          fi

      - name: Collect logs for artifacts (Windows)
        if: always() && runner.os == 'Windows'
        shell: pwsh
        env:
          SERIAL_LOG_PATH: ${{ inputs.serial_log_path }}
        run: |
          $ErrorActionPreference = 'Continue'
          $outDir = Join-Path $env:GITHUB_WORKSPACE 'out\win7-virtio-harness'
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null
          if (Test-Path -LiteralPath $env:SERIAL_LOG_PATH) {
            $src = (Resolve-Path -LiteralPath $env:SERIAL_LOG_PATH).Path
            $dest = Join-Path $outDir (Split-Path -Leaf $src)
            if ($src -ne $dest) {
              Copy-Item -LiteralPath $src -Destination $dest -Force
            }
          }

      - name: Upload harness artifacts (serial + output)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: win7-virtio-harness
          path: out/win7-virtio-harness/
          if-no-files-found: error
