name: Win7 virtio host harness (self-hosted)

on:
  workflow_dispatch:
    inputs:
      disk_image_path:
        description: Path on the self-hosted runner to a prepared Win7 qcow2/vhdx disk image (required)
        required: false
        default: ""
        type: string
      qemu_system:
        description: qemu-system-* binary to use on the runner
        required: false
        default: qemu-system-x86_64
        type: string
      timeout_seconds:
        description: Harness timeout in seconds
        required: false
        default: "600"
        type: string
      http_port:
        description: HTTP port on the runner for the harness file server (guest reaches it as 10.0.2.2:<port>)
        required: false
        default: "18080"
        type: string
      snapshot:
        description: Run QEMU in snapshot mode (discard disk writes)
        required: false
        default: true
        type: boolean
      follow_serial:
        description: Stream guest COM1 output to the workflow log while waiting
        required: false
        default: false
        type: boolean
      qemu_preflight_pci:
        description: Run a QMP query-pci preflight to validate QEMU-emitted virtio PCI IDs (VEN/DEV/REV) before waiting for guest results
        required: false
        default: false
        type: boolean
      force_intx:
        description: Force virtio devices to expose no MSI-X capability (vectors=0) so the guest uses INTx
        required: false
        default: false
        type: boolean
      with_virtio_input_events:
        description: Inject deterministic virtio-input events via QMP (keyboard + mouse) and require virtio-input-events to PASS (requires a guest image provisioned with --test-input-events)
        required: false
        default: false
        type: boolean
      with_virtio_input_wheel:
        description: Inject deterministic virtio-input wheel events via QMP and require virtio-input-wheel to PASS (implies virtio-input-events; requires a guest image provisioned with --test-input-events)
        required: false
        default: false
        type: boolean
      with_virtio_input_media_keys:
        description: Inject deterministic virtio-input Consumer Control (media key) events via QMP and require virtio-input-media-keys to PASS (requires a guest image provisioned with --test-input-media-keys)
        required: false
        default: false
        type: boolean
      with_virtio_input_led:
        description: Require virtio-input-led (keyboard LED/statusq) to PASS (requires a guest image provisioned with --test-input-led)
        required: false
        default: false
        type: boolean
      require_virtio_input_binding:
        description: Require virtio-input-binding (PCI driver service validation) to PASS
        required: false
        default: false
        type: boolean
      with_virtio_input_events_extended:
        description: Inject extended virtio-input events via QMP (modifiers/buttons/wheel) and require virtio-input-events-* markers to PASS (requires a guest image provisioned with --test-input-events and --test-input-events-extended)
        required: false
        default: false
        type: boolean
      with_virtio_input_tablet_events:
        description: Inject deterministic virtio-input tablet events via QMP (absolute pointer) and require virtio-input-tablet-events to PASS (requires a guest image provisioned with --test-input-tablet-events/--test-tablet-events)
        required: false
        default: false
        type: boolean
      with_blk_resize:
        description: Trigger virtio-blk runtime resize via QMP and require virtio-blk-resize to PASS (requires a guest image provisioned with --test-blk-resize)
        required: false
        default: false
        type: boolean
      blk_resize_delta_mib:
        description: Delta in MiB to grow the virtio-blk backing device when with_blk_resize is enabled (default 64)
        required: false
        default: ""
        type: string
      with_blk_reset:
        description: Require virtio-blk-reset to PASS (requires a guest image provisioned with --test-blk-reset)
        required: false
        default: false
        type: boolean
      with_net_link_flap:
        description: Flap virtio-net link via QMP (set_link) and require virtio-net-link-flap to PASS (requires a guest image provisioned with --test-net-link-flap)
        required: false
        default: false
        type: boolean
      require_net_csum_offload:
        description: Require at least one checksum-offloaded packet from the virtio-net driver (fails if tx_csum=0)
        required: false
        default: false
        type: boolean
      # virtio-snd testing requires modern-only virtio-pci enumeration (disable-legacy=on, x-pci-revision=0x01).
      # Using the wav backend keeps the runner headless and produces an artifact for debugging regressions.
      with_virtio_snd:
        description: Attach virtio-snd and require the guest virtio-snd playback + capture + duplex selftests to PASS (guest selftest must run capture/duplex smoke tests; newer aero-virtio-selftest binaries do this automatically when virtio-snd is present, older images need --test-snd-capture or AERO_VIRTIO_SELFTEST_TEST_SND_CAPTURE=1)
        required: false
        default: false
        type: boolean
      with_snd_buffer_limits:
        description: Require virtio-snd-buffer-limits to PASS (requires with_virtio_snd and a guest image provisioned with --test-snd-buffer-limits)
        required: false
        default: false
        type: boolean
      virtio_snd_audio_backend:
        description: Audio backend to use when virtio-snd is enabled
        required: false
        default: wav
        type: choice
        options:
          - none
          - wav
      virtio_snd_verify_wav:
        description: When using the wav backend, fail if the captured audio is silent
        required: false
        default: true
        type: boolean
      virtio_snd_wav_peak_threshold:
        description: Optional override for wav non-silence peak threshold (default is harness default)
        required: false
        default: ""
        type: string
      virtio_snd_wav_rms_threshold:
        description: Optional override for wav non-silence RMS threshold (default is harness default)
        required: false
        default: ""
        type: string

concurrency:
  # QEMU uses fixed ports and shared images; overlapping runs will conflict.
  group: win7-virtio-harness
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  win7-virtio-harness:
    runs-on: [self-hosted, aero-win7-harness]
    # Guard against a wedged self-hosted runner (the harness itself has its own timeout too).
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Win7 virtio host harness (QEMU)
        id: harness
        shell: bash
        run: |
          set -euo pipefail

          log_dir="out/win7-virtio-harness-logs"
          rm -rf "${log_dir}"
          mkdir -p "${log_dir}"

          serial_log="${log_dir}/win7-virtio-serial.log"
          http_log="${log_dir}/http.log"
          harness_log="${log_dir}/harness.log"
          virtio_snd_wav_path="${log_dir}/virtio-snd.wav"

          : >"${serial_log}"
          : >"${http_log}"
          : >"${harness_log}"

          set +e
          (
            set -euo pipefail
            echo "Runner: ${RUNNER_NAME} (${RUNNER_OS})"
            echo "Inputs:"
            echo "  disk_image_path: '${{ inputs.disk_image_path }}'"
            echo "  qemu_system: '${{ inputs.qemu_system }}'"
            echo "  timeout_seconds: '${{ inputs.timeout_seconds }}'"
            echo "  http_port: '${{ inputs.http_port }}'"
            echo "  snapshot: '${{ inputs.snapshot }}'"
            echo "  follow_serial: '${{ inputs.follow_serial }}'"
            echo "  qemu_preflight_pci: '${{ inputs.qemu_preflight_pci }}'"
            echo "  force_intx: '${{ inputs.force_intx }}'"
            echo "  with_virtio_input_events: '${{ inputs.with_virtio_input_events }}'"
            echo "  with_virtio_input_wheel: '${{ inputs.with_virtio_input_wheel }}'"
            echo "  with_virtio_input_media_keys: '${{ inputs.with_virtio_input_media_keys }}'"
            echo "  with_virtio_input_led: '${{ inputs.with_virtio_input_led }}'"
            echo "  require_virtio_input_binding: '${{ inputs.require_virtio_input_binding }}'"
            echo "  with_virtio_input_events_extended: '${{ inputs.with_virtio_input_events_extended }}'"
            echo "  with_virtio_input_tablet_events: '${{ inputs.with_virtio_input_tablet_events }}'"
            echo "  with_blk_resize: '${{ inputs.with_blk_resize }}'"
            echo "  blk_resize_delta_mib: '${{ inputs.blk_resize_delta_mib }}'"
            echo "  with_blk_reset: '${{ inputs.with_blk_reset }}'"
            echo "  with_net_link_flap: '${{ inputs.with_net_link_flap }}'"
            echo "  require_net_csum_offload: '${{ inputs.require_net_csum_offload }}'"
            echo "  with_virtio_snd: '${{ inputs.with_virtio_snd }}'"
            echo "  with_snd_buffer_limits: '${{ inputs.with_snd_buffer_limits }}'"
            echo "  virtio_snd_audio_backend: '${{ inputs.virtio_snd_audio_backend }}'"
            echo "  virtio_snd_verify_wav: '${{ inputs.virtio_snd_verify_wav }}'"
            echo "  virtio_snd_wav_peak_threshold: '${{ inputs.virtio_snd_wav_peak_threshold }}'"
            echo "  virtio_snd_wav_rms_threshold: '${{ inputs.virtio_snd_wav_rms_threshold }}'"
            echo

            disk_image_path="${{ inputs.disk_image_path }}"
            qemu_system="${{ inputs.qemu_system }}"
            timeout_seconds="${{ inputs.timeout_seconds }}"
            http_port="${{ inputs.http_port }}"

            if [[ -z "${disk_image_path}" ]]; then
              echo "ERROR: workflow input 'disk_image_path' is empty."
              echo "Provide a path on the self-hosted runner to a prepared Windows 7 image (qcow2/vhdx)."
              exit 1
            fi

            if [[ ! -e "${disk_image_path}" ]]; then
              echo "ERROR: disk image path does not exist on the runner: ${disk_image_path}"
              exit 1
            fi

            if ! command -v "${qemu_system}" >/dev/null 2>&1; then
              echo "ERROR: qemu system binary not found/executable: ${qemu_system}"
              exit 1
            fi

            if ! command -v python3 >/dev/null 2>&1; then
              echo "ERROR: python3 not found in PATH"
              exit 1
            fi

            if [[ -z "${timeout_seconds}" || ! "${timeout_seconds}" =~ ^[0-9]+$ ]]; then
              echo "ERROR: workflow input 'timeout_seconds' must be an integer number of seconds, got: '${timeout_seconds}'"
              exit 1
            fi
            if [[ -z "${http_port}" || ! "${http_port}" =~ ^[0-9]+$ ]]; then
              echo "ERROR: workflow input 'http_port' must be an integer TCP port, got: '${http_port}'"
              exit 1
            fi
            if (( http_port < 1 || http_port > 65535 )); then
              echo "ERROR: workflow input 'http_port' must be in range 1..65535, got: '${http_port}'"
              exit 1
            fi

            echo "python3: $(python3 --version 2>&1 || true)"
            echo "qemu: $(\"${qemu_system}\" --version 2>&1 | head -n 1 || true)"
            echo

            echo "Running host-harness unit tests..."
            python3 -m unittest discover -s drivers/windows7/tests/host-harness/tests
            echo

            with_virtio_snd="${{ inputs.with_virtio_snd }}"
            virtio_snd_audio_backend="${{ inputs.virtio_snd_audio_backend }}"
            virtio_snd_verify_wav="${{ inputs.virtio_snd_verify_wav }}"
            virtio_snd_wav_peak_threshold="${{ inputs.virtio_snd_wav_peak_threshold }}"
            virtio_snd_wav_rms_threshold="${{ inputs.virtio_snd_wav_rms_threshold }}"
            force_intx="${{ inputs.force_intx }}"
            with_virtio_input_events="${{ inputs.with_virtio_input_events }}"
            with_virtio_input_wheel="${{ inputs.with_virtio_input_wheel }}"
            with_virtio_input_media_keys="${{ inputs.with_virtio_input_media_keys }}"
            with_virtio_input_led="${{ inputs.with_virtio_input_led }}"
            require_virtio_input_binding="${{ inputs.require_virtio_input_binding }}"
            with_virtio_input_events_extended="${{ inputs.with_virtio_input_events_extended }}"
            with_virtio_input_tablet_events="${{ inputs.with_virtio_input_tablet_events }}"
            with_blk_resize="${{ inputs.with_blk_resize }}"
            blk_resize_delta_mib="${{ inputs.blk_resize_delta_mib }}"
            with_blk_reset="${{ inputs.with_blk_reset }}"
            with_net_link_flap="${{ inputs.with_net_link_flap }}"
            require_net_csum_offload="${{ inputs.require_net_csum_offload }}"
            with_snd_buffer_limits="${{ inputs.with_snd_buffer_limits }}"

            # Remove stale output from previous runs (self-hosted runners persist state).
            rm -f "${virtio_snd_wav_path}"

            args=(
              python3 -u drivers/windows7/tests/host-harness/invoke_aero_virtio_win7_tests.py
              --qemu-system "${qemu_system}"
              --disk-image "${disk_image_path}"
              --serial-log "${serial_log}"
              --http-log "${http_log}"
              --http-port "${http_port}"
              --timeout-seconds "${timeout_seconds}"
            )
            if [[ "${{ inputs.snapshot }}" == "true" ]]; then
              args+=(--snapshot)
            fi
            if [[ "${{ inputs.follow_serial }}" == "true" ]]; then
              args+=(--follow-serial)
            fi
            if [[ "${{ inputs.qemu_preflight_pci }}" == "true" ]]; then
              args+=(--qemu-preflight-pci)
            fi
            if [[ "${force_intx}" == "true" ]]; then
              args+=(--force-intx)
            fi
            if [[ "${with_virtio_input_events}" == "true" ]]; then
              args+=(--with-input-events)
            fi
            if [[ "${with_virtio_input_wheel}" == "true" ]]; then
              args+=(--with-input-wheel)
            fi
            if [[ "${with_virtio_input_media_keys}" == "true" ]]; then
              args+=(--with-input-media-keys)
            fi
            if [[ "${with_virtio_input_led}" == "true" ]]; then
              args+=(--with-input-led)
            fi
            if [[ "${require_virtio_input_binding}" == "true" ]]; then
              args+=(--require-virtio-input-binding)
            fi
            if [[ "${with_virtio_input_events_extended}" == "true" ]]; then
              args+=(--with-input-events-extended)
            fi
            if [[ "${with_virtio_input_tablet_events}" == "true" ]]; then
              args+=(--with-tablet-events)
            fi
            if [[ "${with_blk_resize}" == "true" ]]; then
              args+=(--with-blk-resize)
              if [[ -n "${blk_resize_delta_mib}" ]]; then
                if [[ ! "${blk_resize_delta_mib}" =~ ^[0-9]+$ ]]; then
                  echo "ERROR: workflow input blk_resize_delta_mib must be an integer (MiB), got: '${blk_resize_delta_mib}'" >&2
                  exit 1
                fi
                if (( blk_resize_delta_mib <= 0 )); then
                  echo "ERROR: workflow input blk_resize_delta_mib must be > 0, got: '${blk_resize_delta_mib}'" >&2
                  exit 1
                fi
                args+=(--blk-resize-delta-mib "${blk_resize_delta_mib}")
              fi
            fi
            if [[ "${with_blk_reset}" == "true" ]]; then
              args+=(--with-blk-reset)
            fi
            if [[ "${with_net_link_flap}" == "true" ]]; then
              args+=(--with-net-link-flap)
            fi
            if [[ "${require_net_csum_offload}" == "true" ]]; then
              args+=(--require-net-csum-offload)
            fi
            if [[ "${with_virtio_snd}" == "true" ]]; then
              args+=(--with-virtio-snd)

              case "${virtio_snd_audio_backend}" in
                wav)
                  args+=(--virtio-snd-audio-backend=wav --virtio-snd-wav-path "${virtio_snd_wav_path}")

                  if [[ "${virtio_snd_verify_wav}" == "true" ]]; then
                    args+=(--virtio-snd-verify-wav)
                  fi

                  if [[ -n "${virtio_snd_wav_peak_threshold}" ]]; then
                    args+=(--virtio-snd-wav-peak-threshold "${virtio_snd_wav_peak_threshold}")
                  fi
                  if [[ -n "${virtio_snd_wav_rms_threshold}" ]]; then
                    args+=(--virtio-snd-wav-rms-threshold "${virtio_snd_wav_rms_threshold}")
                  fi
                  ;;
                none)
                  args+=(--virtio-snd-audio-backend=none)
                  if [[ "${virtio_snd_verify_wav}" == "true" ]]; then
                    echo "NOTE: virtio_snd_verify_wav=true is ignored because virtio_snd_audio_backend=none"
                  fi
                  ;;
                *)
                  echo "ERROR: unknown workflow input virtio_snd_audio_backend='${virtio_snd_audio_backend}'" >&2
                  exit 1
                  ;;
              esac
            fi
            if [[ "${with_snd_buffer_limits}" == "true" ]]; then
              if [[ "${with_virtio_snd}" != "true" ]]; then
                echo "ERROR: workflow input with_snd_buffer_limits=true requires with_virtio_snd=true"
                exit 1
              fi
              args+=(--with-snd-buffer-limits)
            fi

            echo "Executing harness:"
            printf '  %q' "${args[@]}"
            echo
            echo

            set +e
            "${args[@]}"
            harness_exit=$?
            set -e

            # If QEMU fails very early, the harness may not create a serial log. Always upload *something*
            # so the artifact has a stable shape for consumers.
            if [[ ! -f "${serial_log}" ]]; then
              echo "(serial log was not produced)" >"${serial_log}"
            fi
            if [[ ! -f "${http_log}" ]]; then
              echo "(no HTTP requests were logged)" >"${http_log}"
            fi

            exit "${harness_exit}"
          ) 2>&1 | tee "${harness_log}"

          # Capture the harness exit code even when the pipeline fails, so we can surface it
          # in job summaries and downstream steps.
          harness_exit="${PIPESTATUS[0]}"
          set -e
          echo "exit_code=${harness_exit}" >>"${GITHUB_OUTPUT}"
          exit "${harness_exit}"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: win7-virtio-harness-logs
          if-no-files-found: error
          # Includes virtio-snd.wav when virtio-snd is enabled with the wav backend.
          path: out/win7-virtio-harness-logs/

      - name: Job summary
        if: always()
        shell: bash
        run: |
          log_dir="out/win7-virtio-harness-logs"
          harness_log="${log_dir}/harness.log"
          serial_log="${log_dir}/win7-virtio-serial.log"

          result_marker=""
          blk_resize_marker=""
          blk_reset_marker=""
          net_link_flap_marker=""
          net_link_flap_host_marker=""
          net_offload_csum_marker=""
          snd_marker=""
          input_events_marker=""
          input_wheel_marker=""
          input_media_keys_marker=""
          input_led_marker=""
          input_binding_host_marker=""
          input_events_modifiers_marker=""
          input_events_buttons_marker=""
          input_events_wheel_marker=""
          input_tablet_marker=""
           input_inject_marker=""
           input_media_keys_inject_marker=""
           input_tablet_inject_marker=""
           pci_preflight_marker=""
           blk_resize_request_marker=""
           blk_resize_fail_marker=""
           blk_resize_host_marker=""
            snd_capture_marker=""
            snd_duplex_marker=""
            snd_buffer_limits_marker=""
            wav_marker=""
          failure_token=""
          failure_line=""
          error_line=""
          force_intx_host_marker=""
          if [[ -f "${serial_log}" ]]; then
            result_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|RESULT\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            blk_resize_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-blk-resize\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            blk_reset_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-blk-reset\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            net_link_flap_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-net-link-flap\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            net_offload_csum_marker="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-net-offload-csum|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            snd_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-snd\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            input_events_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-input-events\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            input_wheel_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-input-wheel\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            input_media_keys_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-input-media-keys\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            input_led_marker="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-input-led|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            input_events_modifiers_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-input-events-modifiers\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            input_events_buttons_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-input-events-buttons\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            input_events_wheel_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-input-events-wheel\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            input_tablet_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-input-tablet-events\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            snd_capture_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-snd-capture\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            snd_duplex_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-snd-duplex\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            snd_buffer_limits_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-snd-buffer-limits\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
          fi
           if [[ -f "${harness_log}" ]]; then
              wav_marker="$(grep -Eo 'AERO_VIRTIO_WIN7_HOST\\|VIRTIO_SND_WAV\\|[A-Z]+' "${harness_log}" | tail -n 1 || true)"
              input_inject_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_INPUT_EVENTS_INJECT|' "${harness_log}" | tail -n 1 || true)"
              input_media_keys_inject_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_INPUT_MEDIA_KEYS_INJECT|' "${harness_log}" | tail -n 1 || true)"
              input_tablet_inject_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_INPUT_TABLET_EVENTS_INJECT|' "${harness_log}" | tail -n 1 || true)"
              input_binding_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_INPUT_BINDING|' "${harness_log}" | tail -n 1 || true)"
              force_intx_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|CONFIG|force_intx=1' "${harness_log}" | tail -n 1 || true)"
              pci_preflight_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|QEMU_PCI_PREFLIGHT|' "${harness_log}" | tail -n 1 || true)"
              blk_resize_request_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_BLK_RESIZE|REQUEST|' "${harness_log}" | tail -n 1 || true)"
              blk_resize_fail_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_BLK_RESIZE|FAIL|reason=' "${harness_log}" | tail -n 1 || true)"
              blk_resize_host_marker="$(
                grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_BLK_RESIZE|' "${harness_log}" \
                  | grep -vF '|REQUEST|' \
                  | grep -vF '|FAIL|reason=' \
                  | tail -n 1 \
                  || true
              )"
              net_link_flap_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_NET_LINK_FLAP|' "${harness_log}" | tail -n 1 || true)"
              # Extract the last structured failure token from the harness output, if present.
              # Example: "FAIL: MISSING_VIRTIO_INPUT_EVENTS: ..."
              failure_token="$(grep -Eo 'FAIL: [A-Z0-9_]+:' "${harness_log}" | tail -n 1 | sed -e 's/^FAIL: //' -e 's/:$//' || true)"
             # Fallback: the full last failure line (useful when no structured token is present).
            failure_line="$(grep -F 'FAIL:' "${harness_log}" | tail -n 1 || true)"
            # Fallback: last explicit "ERROR:" line.
            error_line="$(grep -F 'ERROR:' "${harness_log}" | tail -n 1 || true)"
          fi

          {
            echo "### Win7 virtio host harness"
            echo ""
            echo "- Harness step: ${{ steps.harness.outcome }}"
            echo "- Harness exit code: ${{ steps.harness.outputs.exit_code || 'unknown' }}"
            if [[ "${{ inputs.force_intx }}" == "true" && -n "${force_intx_host_marker}" ]]; then
              echo "- Host force INTx marker: \`${force_intx_host_marker}\`"
            fi
            if [[ -n "${failure_token}" ]]; then
              echo "- Harness failure token: ${failure_token}"
            fi
            if [[ -z "${failure_token}" && -n "${failure_line}" ]]; then
              echo "- Harness failure: ${failure_line}"
            fi
            if [[ -z "${failure_token}" && -z "${failure_line}" && -n "${error_line}" ]]; then
              echo "- Harness error: ${error_line}"
            fi
            if [[ -n "${result_marker}" ]]; then
              echo "- Guest result marker: ${result_marker}"
            fi
            if [[ -n "${blk_resize_marker}" ]]; then
              echo "- Guest virtio-blk-resize marker: ${blk_resize_marker}"
            fi
            if [[ -n "${blk_reset_marker}" ]]; then
              echo "- Guest virtio-blk-reset marker: ${blk_reset_marker}"
            fi
            if [[ -n "${net_link_flap_marker}" ]]; then
              echo "- Guest virtio-net-link-flap marker: ${net_link_flap_marker}"
            fi
            if [[ -n "${net_offload_csum_marker}" ]]; then
              echo "- Guest virtio-net-offload-csum marker: \`${net_offload_csum_marker}\`"
            fi
            if [[ -n "${blk_resize_request_marker}" ]]; then
              echo "- Host virtio-blk-resize request marker: \`${blk_resize_request_marker}\`"
            fi
            if [[ -n "${blk_resize_fail_marker}" ]]; then
              echo "- Host virtio-blk-resize QMP failure marker: \`${blk_resize_fail_marker}\`"
            fi
            if [[ -n "${blk_resize_host_marker}" ]]; then
              echo "- Host virtio-blk-resize marker: \`${blk_resize_host_marker}\`"
            fi
            if [[ -n "${net_link_flap_host_marker}" ]]; then
              echo "- Host virtio-net-link-flap marker: \`${net_link_flap_host_marker}\`"
            fi
            if [[ -n "${snd_marker}" ]]; then
              echo "- Guest virtio-snd marker: ${snd_marker}"
            fi
            if [[ -n "${input_events_marker}" ]]; then
              echo "- Guest virtio-input-events marker: ${input_events_marker}"
            fi
            if [[ -n "${input_wheel_marker}" ]]; then
              echo "- Guest virtio-input-wheel marker: ${input_wheel_marker}"
            fi
            if [[ -n "${input_media_keys_marker}" ]]; then
              echo "- Guest virtio-input-media-keys marker: ${input_media_keys_marker}"
            fi
            if [[ "${{ inputs.require_virtio_input_binding }}" == "true" && -n "${input_binding_host_marker}" ]]; then
              echo "- Host virtio-input binding marker: \`${input_binding_host_marker}\`"
            fi
            if [[ "${{ inputs.with_virtio_input_led }}" == "true" && -n "${input_led_marker}" ]]; then
              echo "- Guest virtio-input-led marker: \`${input_led_marker}\`"
            fi
            if [[ -n "${input_events_modifiers_marker}" ]]; then
              echo "- Guest virtio-input-events-modifiers marker: ${input_events_modifiers_marker}"
            fi
            if [[ -n "${input_events_buttons_marker}" ]]; then
              echo "- Guest virtio-input-events-buttons marker: ${input_events_buttons_marker}"
            fi
            if [[ -n "${input_events_wheel_marker}" ]]; then
              echo "- Guest virtio-input-events-wheel marker: ${input_events_wheel_marker}"
            fi
            if [[ -n "${input_inject_marker}" ]]; then
              echo "- Host virtio-input injection marker: \`${input_inject_marker}\`"
            fi
            if [[ -n "${input_media_keys_inject_marker}" ]]; then
              echo "- Host virtio-input media keys injection marker: \`${input_media_keys_inject_marker}\`"
            fi
            if [[ -n "${input_tablet_marker}" ]]; then
              echo "- Guest virtio-input-tablet-events marker: ${input_tablet_marker}"
            fi
             if [[ -n "${input_tablet_inject_marker}" ]]; then
               echo "- Host virtio-input tablet injection marker: \`${input_tablet_inject_marker}\`"
             fi
             if [[ -n "${pci_preflight_marker}" ]]; then
               echo "- Host QEMU PCI preflight marker: \`${pci_preflight_marker}\`"
             fi
             if [[ -n "${snd_capture_marker}" ]]; then
               echo "- Guest virtio-snd-capture marker: ${snd_capture_marker}"
             fi
            if [[ -n "${snd_duplex_marker}" ]]; then
              echo "- Guest virtio-snd-duplex marker: ${snd_duplex_marker}"
            fi
            if [[ -n "${snd_buffer_limits_marker}" ]]; then
              echo "- Guest virtio-snd-buffer-limits marker: ${snd_buffer_limits_marker}"
            fi
            if [[ -n "${wav_marker}" ]]; then
              echo "- Host wav marker: ${wav_marker}"
            fi
            echo "- Logs artifact: win7-virtio-harness-logs"
            echo "- Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          } >>"$GITHUB_STEP_SUMMARY"
