name: Win7 virtio host harness (self-hosted)

on:
  workflow_dispatch:
    inputs:
      disk_image_path:
        description: Path on the self-hosted runner to a prepared Win7 qcow2/vhdx disk image (required)
        required: false
        default: ""
        type: string
      qemu_system:
        description: qemu-system-* binary to use on the runner
        required: false
        default: qemu-system-x86_64
        type: string
      timeout_seconds:
        description: Harness timeout in seconds
        required: false
        default: "600"
        type: string
      http_port:
        description: HTTP port on the runner for the harness file server (guest reaches it as 10.0.2.2:<port>)
        required: false
        default: "18080"
        type: string
      snapshot:
        description: Run QEMU in snapshot mode (discard disk writes)
        required: false
        default: true
        type: boolean
      follow_serial:
        description: Stream guest COM1 output to the workflow log while waiting
        required: false
        default: false
        type: boolean
      with_virtio_input_events:
        description: Inject deterministic virtio-input events via QMP (keyboard + mouse) and require virtio-input-events to PASS (requires a guest image provisioned with --test-input-events)
        required: false
        default: false
        type: boolean
      # virtio-snd testing requires modern-only virtio-pci enumeration (disable-legacy=on, x-pci-revision=0x01).
      # Using the wav backend keeps the runner headless and produces an artifact for debugging regressions.
      with_virtio_snd:
        description: Attach virtio-snd and require the guest virtio-snd playback + capture + duplex selftests to PASS (guest selftest must run capture/duplex smoke tests; newer aero-virtio-selftest binaries do this automatically when virtio-snd is present, older images need --test-snd-capture or AERO_VIRTIO_SELFTEST_TEST_SND_CAPTURE=1)
        required: false
        default: false
        type: boolean
      virtio_snd_audio_backend:
        description: Audio backend to use when virtio-snd is enabled
        required: false
        default: wav
        type: choice
        options:
          - none
          - wav
      virtio_snd_verify_wav:
        description: When using the wav backend, fail if the captured audio is silent
        required: false
        default: true
        type: boolean
      virtio_snd_wav_peak_threshold:
        description: Optional override for wav non-silence peak threshold (default is harness default)
        required: false
        default: ""
        type: string
      virtio_snd_wav_rms_threshold:
        description: Optional override for wav non-silence RMS threshold (default is harness default)
        required: false
        default: ""
        type: string

concurrency:
  # QEMU uses fixed ports and shared images; overlapping runs will conflict.
  group: win7-virtio-harness
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  win7-virtio-harness:
    runs-on: [self-hosted, aero-win7-harness]
    # Guard against a wedged self-hosted runner (the harness itself has its own timeout too).
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Win7 virtio host harness (QEMU)
        id: harness
        shell: bash
        run: |
          set -euo pipefail

          log_dir="out/win7-virtio-harness-logs"
          rm -rf "${log_dir}"
          mkdir -p "${log_dir}"

          serial_log="${log_dir}/win7-virtio-serial.log"
          http_log="${log_dir}/http.log"
          harness_log="${log_dir}/harness.log"
          virtio_snd_wav_path="${log_dir}/virtio-snd.wav"

          : >"${serial_log}"
          : >"${http_log}"
          : >"${harness_log}"

          set +e
          (
            set -euo pipefail
            echo "Runner: ${RUNNER_NAME} (${RUNNER_OS})"
            echo "Inputs:"
            echo "  disk_image_path: '${{ inputs.disk_image_path }}'"
            echo "  qemu_system: '${{ inputs.qemu_system }}'"
            echo "  timeout_seconds: '${{ inputs.timeout_seconds }}'"
            echo "  http_port: '${{ inputs.http_port }}'"
            echo "  snapshot: '${{ inputs.snapshot }}'"
            echo "  follow_serial: '${{ inputs.follow_serial }}'"
            echo "  with_virtio_input_events: '${{ inputs.with_virtio_input_events }}'"
            echo "  with_virtio_snd: '${{ inputs.with_virtio_snd }}'"
            echo "  virtio_snd_audio_backend: '${{ inputs.virtio_snd_audio_backend }}'"
            echo "  virtio_snd_verify_wav: '${{ inputs.virtio_snd_verify_wav }}'"
            echo "  virtio_snd_wav_peak_threshold: '${{ inputs.virtio_snd_wav_peak_threshold }}'"
            echo "  virtio_snd_wav_rms_threshold: '${{ inputs.virtio_snd_wav_rms_threshold }}'"
            echo

            disk_image_path="${{ inputs.disk_image_path }}"
            qemu_system="${{ inputs.qemu_system }}"
            timeout_seconds="${{ inputs.timeout_seconds }}"
            http_port="${{ inputs.http_port }}"

            if [[ -z "${disk_image_path}" ]]; then
              echo "ERROR: workflow input 'disk_image_path' is empty."
              echo "Provide a path on the self-hosted runner to a prepared Windows 7 image (qcow2/vhdx)."
              exit 1
            fi

            if [[ ! -e "${disk_image_path}" ]]; then
              echo "ERROR: disk image path does not exist on the runner: ${disk_image_path}"
              exit 1
            fi

            if ! command -v "${qemu_system}" >/dev/null 2>&1; then
              echo "ERROR: qemu system binary not found/executable: ${qemu_system}"
              exit 1
            fi

            if ! command -v python3 >/dev/null 2>&1; then
              echo "ERROR: python3 not found in PATH"
              exit 1
            fi

            if [[ -z "${timeout_seconds}" || ! "${timeout_seconds}" =~ ^[0-9]+$ ]]; then
              echo "ERROR: workflow input 'timeout_seconds' must be an integer number of seconds, got: '${timeout_seconds}'"
              exit 1
            fi
            if [[ -z "${http_port}" || ! "${http_port}" =~ ^[0-9]+$ ]]; then
              echo "ERROR: workflow input 'http_port' must be an integer TCP port, got: '${http_port}'"
              exit 1
            fi
            if (( http_port < 1 || http_port > 65535 )); then
              echo "ERROR: workflow input 'http_port' must be in range 1..65535, got: '${http_port}'"
              exit 1
            fi

            echo "python3: $(python3 --version 2>&1 || true)"
            echo "qemu: $(\"${qemu_system}\" --version 2>&1 | head -n 1 || true)"
            echo

            echo "Running host-harness unit tests..."
            python3 -m unittest discover -s drivers/windows7/tests/host-harness/tests
            echo

            with_virtio_snd="${{ inputs.with_virtio_snd }}"
            virtio_snd_audio_backend="${{ inputs.virtio_snd_audio_backend }}"
            virtio_snd_verify_wav="${{ inputs.virtio_snd_verify_wav }}"
            virtio_snd_wav_peak_threshold="${{ inputs.virtio_snd_wav_peak_threshold }}"
            virtio_snd_wav_rms_threshold="${{ inputs.virtio_snd_wav_rms_threshold }}"
            with_virtio_input_events="${{ inputs.with_virtio_input_events }}"

            # Remove stale output from previous runs (self-hosted runners persist state).
            rm -f "${virtio_snd_wav_path}"

            args=(
              python3 -u drivers/windows7/tests/host-harness/invoke_aero_virtio_win7_tests.py
              --qemu-system "${qemu_system}"
              --disk-image "${disk_image_path}"
              --serial-log "${serial_log}"
              --http-log "${http_log}"
              --http-port "${http_port}"
              --timeout-seconds "${timeout_seconds}"
            )
            if [[ "${{ inputs.snapshot }}" == "true" ]]; then
              args+=(--snapshot)
            fi
            if [[ "${{ inputs.follow_serial }}" == "true" ]]; then
              args+=(--follow-serial)
            fi
            if [[ "${with_virtio_input_events}" == "true" ]]; then
              args+=(--with-input-events)
            fi
            if [[ "${with_virtio_snd}" == "true" ]]; then
              args+=(--with-virtio-snd)

              case "${virtio_snd_audio_backend}" in
                wav)
                  args+=(--virtio-snd-audio-backend=wav --virtio-snd-wav-path "${virtio_snd_wav_path}")

                  if [[ "${virtio_snd_verify_wav}" == "true" ]]; then
                    args+=(--virtio-snd-verify-wav)
                  fi

                  if [[ -n "${virtio_snd_wav_peak_threshold}" ]]; then
                    args+=(--virtio-snd-wav-peak-threshold "${virtio_snd_wav_peak_threshold}")
                  fi
                  if [[ -n "${virtio_snd_wav_rms_threshold}" ]]; then
                    args+=(--virtio-snd-wav-rms-threshold "${virtio_snd_wav_rms_threshold}")
                  fi
                  ;;
                none)
                  args+=(--virtio-snd-audio-backend=none)
                  if [[ "${virtio_snd_verify_wav}" == "true" ]]; then
                    echo "NOTE: virtio_snd_verify_wav=true is ignored because virtio_snd_audio_backend=none"
                  fi
                  ;;
                *)
                  echo "ERROR: unknown workflow input virtio_snd_audio_backend='${virtio_snd_audio_backend}'" >&2
                  exit 1
                  ;;
              esac
            fi

            echo "Executing harness:"
            printf '  %q' "${args[@]}"
            echo
            echo

            set +e
            "${args[@]}"
            harness_exit=$?
            set -e

            # If QEMU fails very early, the harness may not create a serial log. Always upload *something*
            # so the artifact has a stable shape for consumers.
            if [[ ! -f "${serial_log}" ]]; then
              echo "(serial log was not produced)" >"${serial_log}"
            fi
            if [[ ! -f "${http_log}" ]]; then
              echo "(no HTTP requests were logged)" >"${http_log}"
            fi

            exit "${harness_exit}"
          ) 2>&1 | tee "${harness_log}"

          # Capture the harness exit code even when the pipeline fails, so we can surface it
          # in job summaries and downstream steps.
          harness_exit="${PIPESTATUS[0]}"
          set -e
          echo "exit_code=${harness_exit}" >>"${GITHUB_OUTPUT}"
          exit "${harness_exit}"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: win7-virtio-harness-logs
          if-no-files-found: error
          # Includes virtio-snd.wav when virtio-snd is enabled with the wav backend.
          path: out/win7-virtio-harness-logs/

      - name: Job summary
        if: always()
        shell: bash
        run: |
          log_dir="out/win7-virtio-harness-logs"
          harness_log="${log_dir}/harness.log"
          serial_log="${log_dir}/win7-virtio-serial.log"

          result_marker=""
          snd_marker=""
          input_events_marker=""
          input_inject_marker=""
          snd_capture_marker=""
          snd_duplex_marker=""
          wav_marker=""
          failure_token=""
          if [[ -f "${serial_log}" ]]; then
            result_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|RESULT\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            snd_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-snd\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            input_events_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-input-events\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            snd_capture_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-snd-capture\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            snd_duplex_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-snd-duplex\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
          fi
          if [[ -f "${harness_log}" ]]; then
            wav_marker="$(grep -Eo 'AERO_VIRTIO_WIN7_HOST\\|VIRTIO_SND_WAV\\|[A-Z]+' "${harness_log}" | tail -n 1 || true)"
            input_inject_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_INPUT_EVENTS_INJECT|' "${harness_log}" | tail -n 1 || true)"
            # Extract the last structured failure token from the harness output, if present.
            # Example: "FAIL: MISSING_VIRTIO_INPUT_EVENTS: ..."
            failure_token="$(grep -Eo 'FAIL: [A-Z0-9_]+:' "${harness_log}" | tail -n 1 | sed -e 's/^FAIL: //' -e 's/:$//' || true)"
          fi

          {
            echo "### Win7 virtio host harness"
            echo ""
            echo "- Harness step: ${{ steps.harness.outcome }}"
            echo "- Harness exit code: ${{ steps.harness.outputs.exit_code || 'unknown' }}"
            if [[ -n "${failure_token}" ]]; then
              echo "- Harness failure token: ${failure_token}"
            fi
            if [[ -n "${result_marker}" ]]; then
              echo "- Guest result marker: ${result_marker}"
            fi
            if [[ -n "${snd_marker}" ]]; then
              echo "- Guest virtio-snd marker: ${snd_marker}"
            fi
            if [[ -n "${input_events_marker}" ]]; then
              echo "- Guest virtio-input-events marker: ${input_events_marker}"
            fi
            if [[ -n "${input_inject_marker}" ]]; then
              echo "- Host virtio-input injection marker: \`${input_inject_marker}\`"
            fi
            if [[ -n "${snd_capture_marker}" ]]; then
              echo "- Guest virtio-snd-capture marker: ${snd_capture_marker}"
            fi
            if [[ -n "${snd_duplex_marker}" ]]; then
              echo "- Guest virtio-snd-duplex marker: ${snd_duplex_marker}"
            fi
            if [[ -n "${wav_marker}" ]]; then
              echo "- Host wav marker: ${wav_marker}"
            fi
            echo "- Logs artifact: win7-virtio-harness-logs"
            echo "- Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          } >>"$GITHUB_STEP_SUMMARY"
