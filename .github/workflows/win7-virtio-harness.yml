name: Win7 virtio host harness (self-hosted)

on:
  workflow_dispatch:
    inputs:
      disk_image_path:
        description: Path on the self-hosted runner to a prepared Win7 qcow2/vhdx disk image (required)
        required: false
        default: ""
        type: string
      qemu_system:
        description: qemu-system-* binary to use on the runner
        required: false
        default: qemu-system-x86_64
        type: string
      timeout_seconds:
        description: Harness timeout in seconds
        required: false
        default: "600"
        type: string
      snapshot:
        description: Run QEMU in snapshot mode (discard disk writes)
        required: false
        default: true
        type: boolean
      follow_serial:
        description: Stream guest COM1 output to the workflow log while waiting
        required: false
        default: false
        type: boolean

concurrency:
  # QEMU uses fixed ports and shared images; overlapping runs will conflict.
  group: win7-virtio-harness
  cancel-in-progress: false

jobs:
  win7-virtio-harness:
    runs-on: [self-hosted, aero-win7-harness]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Win7 virtio host harness (QEMU)
        id: harness
        shell: bash
        run: |
          set -euo pipefail

          log_dir="out/win7-virtio-harness-logs"
          rm -rf "${log_dir}"
          mkdir -p "${log_dir}"

          serial_log="${log_dir}/win7-virtio-serial.log"
          harness_log="${log_dir}/harness.log"

          : >"${serial_log}"
          : >"${harness_log}"

          {
            echo "Runner: ${RUNNER_NAME} (${RUNNER_OS})"
            echo "Inputs:"
            echo "  disk_image_path: '${{ inputs.disk_image_path }}'"
            echo "  qemu_system: '${{ inputs.qemu_system }}'"
            echo "  timeout_seconds: '${{ inputs.timeout_seconds }}'"
            echo "  snapshot: '${{ inputs.snapshot }}'"
            echo "  follow_serial: '${{ inputs.follow_serial }}'"
            echo

            disk_image_path="${{ inputs.disk_image_path }}"
            qemu_system="${{ inputs.qemu_system }}"
            timeout_seconds="${{ inputs.timeout_seconds }}"

            if [[ -z "${disk_image_path}" ]]; then
              echo "ERROR: workflow input 'disk_image_path' is empty."
              echo "Provide a path on the self-hosted runner to a prepared Windows 7 image (qcow2/vhdx)."
              exit 1
            fi

            if [[ ! -e "${disk_image_path}" ]]; then
              echo "ERROR: disk image path does not exist on the runner: ${disk_image_path}"
              exit 1
            fi

            if ! command -v "${qemu_system}" >/dev/null 2>&1; then
              echo "ERROR: qemu system binary not found/executable: ${qemu_system}"
              exit 1
            fi

            if ! command -v python3 >/dev/null 2>&1; then
              echo "ERROR: python3 not found in PATH"
              exit 1
            fi

            if [[ -z "${timeout_seconds}" || ! "${timeout_seconds}" =~ ^[0-9]+$ ]]; then
              echo "ERROR: workflow input 'timeout_seconds' must be an integer number of seconds, got: '${timeout_seconds}'"
              exit 1
            fi

            echo "python3: $(python3 --version 2>&1 || true)"
            echo "qemu: $(\"${qemu_system}\" --version 2>&1 | head -n 1 || true)"
            echo

            args=(
              python3 -u drivers/windows7/tests/host-harness/invoke_aero_virtio_win7_tests.py
              --qemu-system "${qemu_system}"
              --disk-image "${disk_image_path}"
              --serial-log "${serial_log}"
              --timeout-seconds "${timeout_seconds}"
            )
            if [[ "${{ inputs.snapshot }}" == "true" ]]; then
              args+=(--snapshot)
            fi
            if [[ "${{ inputs.follow_serial }}" == "true" ]]; then
              args+=(--follow-serial)
            fi

            echo "Executing harness:"
            printf '  %q' "${args[@]}"
            echo
            echo

            set +e
            "${args[@]}"
            harness_exit=$?
            set -e

            # If QEMU fails very early, the harness may not create a serial log. Always upload *something*
            # so the artifact has a stable shape for consumers.
            if [[ ! -f "${serial_log}" ]]; then
              echo "(serial log was not produced)" >"${serial_log}"
            fi

            exit "${harness_exit}"
          } 2>&1 | tee "${harness_log}"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: win7-virtio-harness-logs
          if-no-files-found: error
          path: out/win7-virtio-harness-logs/

      - name: Job summary
        if: always()
        shell: bash
        run: |
          {
            echo "### Win7 virtio host harness"
            echo ""
            echo "- Harness step: ${{ steps.harness.outcome }}"
            echo "- Logs artifact: win7-virtio-harness-logs"
          } >>"$GITHUB_STEP_SUMMARY"
