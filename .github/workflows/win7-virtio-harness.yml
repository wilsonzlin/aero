name: Win7 virtio host harness (self-hosted)

on:
  workflow_dispatch:
    inputs:
      disk_image_path:
        description: Path on the self-hosted runner to a prepared Win7 qcow2/vhdx disk image (required unless dry_run=true)
        required: false
        default: ""
        type: string
      qemu_system:
        description: qemu-system-* binary to use on the runner (must be on PATH unless dry_run=true)
        required: false
        default: qemu-system-x86_64
        type: string
      qemu_extra_args:
        description: Optional extra QEMU args to pass through to qemu-system-* (one arg per line; forwarded after --; blank/# lines ignored)
        required: false
        default: ""
        type: string
      dry_run:
        description: Print the computed QEMU argv and exit 0 without starting QEMU/HTTP/QMP (debug helper; disk image/QEMU not required)
        required: false
        default: false
        type: boolean
      timeout_seconds:
        description: Harness timeout in seconds
        required: false
        default: "600"
        type: string
      memory_mb:
        description: QEMU guest RAM size (MiB)
        required: false
        default: "2048"
        type: string
      smp:
        description: QEMU guest vCPU count
        required: false
        default: "2"
        type: string
      http_port:
        description: HTTP port on the runner for the harness file server (guest reaches it as 10.0.2.2:<port>)
        required: false
        default: "18080"
        type: string
      http_path:
        description: HTTP path served by the harness (must start with / and contain no whitespace; guest requests http://10.0.2.2:<port><path>)
        required: false
        default: "/aero-virtio-selftest"
        type: string
      udp_port:
        description: UDP port on the runner for the harness echo server (guest reaches it as 10.0.2.2:<port>)
        required: false
        default: "18081"
        type: string
      disable_udp:
        description: Disable the host UDP echo server and do not require the guest virtio-net-udp marker (useful for older guest images)
        required: false
        default: false
        type: boolean
      snapshot:
        description: Run QEMU in snapshot mode (discard disk writes)
        required: false
        default: true
        type: boolean
      follow_serial:
        description: Stream guest COM1 output to the workflow log while waiting
        required: false
        default: false
        type: boolean
      qemu_preflight_pci:
        description: Run a QMP query-pci preflight to validate QEMU-emitted virtio PCI IDs (VEN/DEV/REV) before waiting for guest results
        required: false
        default: false
        type: boolean
      virtio_transitional:
        description: Use transitional virtio-pci devices (legacy + modern) instead of modern-only contract-v1 devices (backcompat for older QEMU/guest images)
        required: false
        default: false
        type: boolean
      force_intx:
        description: Force virtio devices to expose no MSI-X capability (vectors=0) so the guest uses INTx
        required: false
        default: false
        type: boolean
      require_intx:
        description: Require INTx interrupt mode for attached virtio devices (blk/net/input/snd)
        required: false
        default: false
        type: boolean
      require_msi:
        description: Require MSI/MSI-X interrupt mode for attached virtio devices (blk/net/input/snd)
        required: false
        default: false
        type: boolean
      with_virtio_tablet:
        description: Attach a virtio-tablet-pci device (in addition to virtio keyboard/mouse). Requires the guest tablet driver to be installed if you expect virtio-input binding checks to pass.
        required: false
        default: false
        type: boolean
      require_virtio_net_msix:
        description: Require virtio-net MSI-X to be enabled/effective (host QMP check + guest mode marker)
        required: false
        default: false
        type: boolean
      require_virtio_blk_msix:
        description: Require virtio-blk MSI-X to be enabled/effective (host QMP check + guest mode marker)
        required: false
        default: false
        type: boolean
      require_virtio_snd_msix:
        description: Require virtio-snd MSI-X to be enabled/effective (requires with_virtio_snd; host QMP check + guest mode marker)
        required: false
        default: false
        type: boolean
      require_virtio_input_msix:
        description: Require virtio-input MSI-X to be effective (guest mode marker check)
        required: false
        default: false
        type: boolean
      virtio_msix_vectors:
        description: Request N MSI-X vectors from QEMU for all virtio devices (vectors=N). Mutually exclusive with force_intx.
        required: false
        default: ""
        type: string
      virtio_net_vectors:
        description: Request N MSI-X vectors from QEMU for virtio-net (overrides virtio_msix_vectors). Mutually exclusive with force_intx.
        required: false
        default: ""
        type: string
      virtio_blk_vectors:
        description: Request N MSI-X vectors from QEMU for virtio-blk (overrides virtio_msix_vectors). Mutually exclusive with force_intx.
        required: false
        default: ""
        type: string
      virtio_input_vectors:
        description: Request N MSI-X vectors from QEMU for virtio-input keyboard/mouse/tablet (overrides virtio_msix_vectors). Mutually exclusive with force_intx.
        required: false
        default: ""
        type: string
      virtio_snd_vectors:
        description: Request N MSI-X vectors from QEMU for virtio-snd (requires with_virtio_snd; overrides virtio_msix_vectors). Mutually exclusive with force_intx.
        required: false
        default: ""
        type: string
      with_virtio_input_events:
        description: Inject deterministic virtio-input events via QMP (keyboard + mouse) and require virtio-input-events to PASS (requires a guest image provisioned with --test-input-events)
        required: false
        default: false
        type: boolean
      with_virtio_input_wheel:
        description: Inject deterministic virtio-input wheel events via QMP and require virtio-input-wheel to PASS (implies virtio-input-events; requires a guest image provisioned with --test-input-events)
        required: false
        default: false
        type: boolean
      with_virtio_input_media_keys:
        description: Inject deterministic virtio-input Consumer Control (media key) events via QMP and require virtio-input-media-keys to PASS (requires a guest image provisioned with --test-input-media-keys)
        required: false
        default: false
        type: boolean
      with_virtio_input_led:
        description: Require virtio-input-led (keyboard LED/statusq) to PASS (requires a guest image provisioned with --test-input-led)
        required: false
        default: false
        type: boolean
      with_virtio_input_leds:
        description: Require virtio-input-leds (legacy keyboard LED/statusq marker) to PASS (requires a guest image provisioned with --test-input-leds; newer guests may use --test-input-led and still emit virtio-input-leds for compatibility)
        required: false
        default: false
        type: boolean
      require_virtio_input_binding:
        description: Require virtio-input-binding (PCI driver service validation) to PASS
        required: false
        default: false
        type: boolean
      with_virtio_input_events_extended:
        description: Inject extended virtio-input events via QMP (modifiers/buttons/wheel) and require virtio-input-events-* markers to PASS (requires a guest image provisioned with --test-input-events and --test-input-events-extended)
        required: false
        default: false
        type: boolean
      with_virtio_input_tablet_events:
        description: Inject deterministic virtio-input tablet events via QMP (absolute pointer) and require virtio-input-tablet-events to PASS (requires a guest image provisioned with --test-input-tablet-events/--test-tablet-events)
        required: false
        default: false
        type: boolean
      with_blk_resize:
        description: Trigger virtio-blk runtime resize via QMP and require virtio-blk-resize to PASS (requires a guest image provisioned with --test-blk-resize)
        required: false
        default: false
        type: boolean
      blk_resize_delta_mib:
        description: Delta in MiB to grow the virtio-blk backing device when with_blk_resize is enabled (default 64)
        required: false
        default: ""
        type: string
      require_expect_blk_msi:
        description: Fail if the guest was not provisioned with --expect-blk-msi (CONFIG marker expect_blk_msi=1)
        required: false
        default: false
        type: boolean
      require_no_blk_recovery:
        description: Fail if virtio-blk recovery/reset/abort counters are non-zero (from virtio-blk per-test fields or virtio-blk-counters marker when available)
        required: false
        default: false
        type: boolean
      fail_on_blk_recovery:
        description: Fail if virtio-blk counters report abort/reset_device/reset_bus activity (prefers virtio-blk-counters; if missing entirely, falls back to legacy *_srb fields on virtio-blk; does not fall back when virtio-blk-counters is present but SKIP)
        required: false
        default: false
        type: boolean
      require_no_blk_reset_recovery:
        description: Fail if virtio-blk reset-recovery counters report reset_detected or hw_reset_bus activity (prefers virtio-blk-reset-recovery; if missing entirely, falls back to legacy virtio-blk-miniport-reset-recovery|INFO|...; WARN/SKIP treated as unavailable)
        required: false
        default: false
        type: boolean
      fail_on_blk_reset_recovery:
        description: Fail if virtio-blk reset-recovery counters report hw_reset_bus activity (prefers virtio-blk-reset-recovery; if missing entirely, falls back to legacy virtio-blk-miniport-reset-recovery|INFO|...; WARN/SKIP treated as unavailable)
        required: false
        default: false
        type: boolean
      require_no_blk_miniport_flags:
        description: Fail if virtio-blk miniport flags diagnostic reports any non-zero removed/surprise_removed/reset_in_progress/reset_pending bits (best-effort; ignores missing/WARN markers)
        required: false
        default: false
        type: boolean
      fail_on_blk_miniport_flags:
        description: Fail if virtio-blk miniport flags diagnostic reports removed or surprise_removed activity (subset of require_no_blk_miniport_flags)
        required: false
        default: false
        type: boolean
      with_blk_reset:
        description: Require virtio-blk-reset to PASS (requires a guest image provisioned with --test-blk-reset)
        required: false
        default: false
        type: boolean
      with_net_link_flap:
        description: Flap virtio-net link via QMP (set_link) and require virtio-net-link-flap to PASS (requires a guest image provisioned with --test-net-link-flap)
        required: false
        default: false
        type: boolean
      require_net_csum_offload:
        description: Require at least one checksum-offloaded packet from the virtio-net driver (fails if tx_csum=0)
        required: false
        default: false
        type: boolean
      require_net_udp_csum_offload:
        description: Require at least one UDP checksum-offloaded TX packet from the virtio-net driver (fails if tx_udp=0)
        required: false
        default: false
        type: boolean
      # virtio-snd testing requires modern-only virtio-pci enumeration (disable-legacy=on, x-pci-revision=0x01).
      # Using the wav backend keeps the runner headless and produces an artifact for debugging regressions.
      with_virtio_snd:
        description: Attach virtio-snd and require the guest virtio-snd playback + capture + duplex selftests to PASS (guest selftest must run capture/duplex smoke tests; newer aero-virtio-selftest binaries do this automatically when virtio-snd is present, older images need --test-snd-capture or AERO_VIRTIO_SELFTEST_TEST_SND_CAPTURE=1)
        required: false
        default: false
        type: boolean
      with_snd_buffer_limits:
        description: Require virtio-snd-buffer-limits to PASS (requires with_virtio_snd and a guest image provisioned with --test-snd-buffer-limits)
        required: false
        default: false
        type: boolean
      virtio_snd_audio_backend:
        description: Audio backend to use when virtio-snd is enabled
        required: false
        default: wav
        type: choice
        options:
          - none
          - wav
      virtio_snd_verify_wav:
        description: When using the wav backend, fail if the captured audio is silent
        required: false
        default: true
        type: boolean
      virtio_snd_wav_peak_threshold:
        description: Optional override for wav non-silence peak threshold (default is harness default)
        required: false
        default: ""
        type: string
      virtio_snd_wav_rms_threshold:
        description: Optional override for wav non-silence RMS threshold (default is harness default)
        required: false
        default: ""
        type: string

concurrency:
  # QEMU uses fixed ports and shared images; overlapping runs will conflict.
  group: win7-virtio-harness
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  win7-virtio-harness:
    runs-on: [self-hosted, aero-win7-harness]
    # Guard against a wedged self-hosted runner (the harness itself has its own timeout too).
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Win7 virtio host harness (QEMU)
        id: harness
        shell: bash
        run: |
          set -euo pipefail

          log_dir="out/win7-virtio-harness-logs"
          rm -rf "${log_dir}"
          mkdir -p "${log_dir}"

          serial_log="${log_dir}/win7-virtio-serial.log"
          http_log="${log_dir}/http.log"
          harness_log="${log_dir}/harness.log"
          virtio_snd_wav_path="${log_dir}/virtio-snd.wav"

          : >"${serial_log}"
          : >"${http_log}"
          : >"${harness_log}"

          set +e
          (
            set -euo pipefail
            echo "Runner: ${RUNNER_NAME} (${RUNNER_OS})"
            echo "Inputs:"
            echo "  disk_image_path: '${{ inputs.disk_image_path }}'"
            echo "  qemu_system: '${{ inputs.qemu_system }}'"
            qemu_extra_args_items=()
            while IFS= read -r line; do
              line="${line%$'\r'}"
              line="${line#"${line%%[![:space:]]*}"}"
              line="${line%"${line##*[![:space:]]}"}"
              if [[ -z "${line}" || "${line}" == \#* ]]; then
                continue
              fi
              qemu_extra_args_items+=("${line}")
            done <<<"${{ inputs.qemu_extra_args }}"
            if (( ${#qemu_extra_args_items[@]} > 0 )); then
              echo "  qemu_extra_args:"
              for line in "${qemu_extra_args_items[@]}"; do
                echo "    - ${line}"
              done
            else
              echo "  qemu_extra_args: ''"
            fi
            echo "  dry_run: '${{ inputs.dry_run }}'"
            echo "  timeout_seconds: '${{ inputs.timeout_seconds }}'"
            echo "  memory_mb: '${{ inputs.memory_mb }}'"
            echo "  smp: '${{ inputs.smp }}'"
            echo "  http_port: '${{ inputs.http_port }}'"
            echo "  http_path: '${{ inputs.http_path }}'"
            echo "  udp_port: '${{ inputs.udp_port }}'"
            echo "  disable_udp: '${{ inputs.disable_udp }}'"
            echo "  snapshot: '${{ inputs.snapshot }}'"
            echo "  follow_serial: '${{ inputs.follow_serial }}'"
            echo "  qemu_preflight_pci: '${{ inputs.qemu_preflight_pci }}'"
            echo "  virtio_transitional: '${{ inputs.virtio_transitional }}'"
            echo "  force_intx: '${{ inputs.force_intx }}'"
            echo "  require_intx: '${{ inputs.require_intx }}'"
            echo "  require_msi: '${{ inputs.require_msi }}'"
            echo "  with_virtio_tablet: '${{ inputs.with_virtio_tablet }}'"
            echo "  require_virtio_net_msix: '${{ inputs.require_virtio_net_msix }}'"
            echo "  require_virtio_blk_msix: '${{ inputs.require_virtio_blk_msix }}'"
            echo "  require_virtio_snd_msix: '${{ inputs.require_virtio_snd_msix }}'"
            echo "  require_virtio_input_msix: '${{ inputs.require_virtio_input_msix }}'"
            echo "  virtio_msix_vectors: '${{ inputs.virtio_msix_vectors }}'"
            echo "  virtio_net_vectors: '${{ inputs.virtio_net_vectors }}'"
            echo "  virtio_blk_vectors: '${{ inputs.virtio_blk_vectors }}'"
            echo "  virtio_input_vectors: '${{ inputs.virtio_input_vectors }}'"
            echo "  virtio_snd_vectors: '${{ inputs.virtio_snd_vectors }}'"
            echo "  with_virtio_input_events: '${{ inputs.with_virtio_input_events }}'"
            echo "  with_virtio_input_wheel: '${{ inputs.with_virtio_input_wheel }}'"
            echo "  with_virtio_input_media_keys: '${{ inputs.with_virtio_input_media_keys }}'"
            echo "  with_virtio_input_led: '${{ inputs.with_virtio_input_led }}'"
            echo "  with_virtio_input_leds: '${{ inputs.with_virtio_input_leds }}'"
            echo "  require_virtio_input_binding: '${{ inputs.require_virtio_input_binding }}'"
            echo "  with_virtio_input_events_extended: '${{ inputs.with_virtio_input_events_extended }}'"
            echo "  with_virtio_input_tablet_events: '${{ inputs.with_virtio_input_tablet_events }}'"
            echo "  with_blk_resize: '${{ inputs.with_blk_resize }}'"
            echo "  blk_resize_delta_mib: '${{ inputs.blk_resize_delta_mib }}'"
            echo "  require_expect_blk_msi: '${{ inputs.require_expect_blk_msi }}'"
            echo "  require_no_blk_recovery: '${{ inputs.require_no_blk_recovery }}'"
            echo "  fail_on_blk_recovery: '${{ inputs.fail_on_blk_recovery }}'"
            echo "  require_no_blk_reset_recovery: '${{ inputs.require_no_blk_reset_recovery }}'"
            echo "  fail_on_blk_reset_recovery: '${{ inputs.fail_on_blk_reset_recovery }}'"
            echo "  require_no_blk_miniport_flags: '${{ inputs.require_no_blk_miniport_flags }}'"
            echo "  fail_on_blk_miniport_flags: '${{ inputs.fail_on_blk_miniport_flags }}'"
            echo "  with_blk_reset: '${{ inputs.with_blk_reset }}'"
            echo "  with_net_link_flap: '${{ inputs.with_net_link_flap }}'"
            echo "  require_net_csum_offload: '${{ inputs.require_net_csum_offload }}'"
            echo "  require_net_udp_csum_offload: '${{ inputs.require_net_udp_csum_offload }}'"
            echo "  with_virtio_snd: '${{ inputs.with_virtio_snd }}'"
            echo "  with_snd_buffer_limits: '${{ inputs.with_snd_buffer_limits }}'"
            echo "  virtio_snd_audio_backend: '${{ inputs.virtio_snd_audio_backend }}'"
            echo "  virtio_snd_verify_wav: '${{ inputs.virtio_snd_verify_wav }}'"
            echo "  virtio_snd_wav_peak_threshold: '${{ inputs.virtio_snd_wav_peak_threshold }}'"
            echo "  virtio_snd_wav_rms_threshold: '${{ inputs.virtio_snd_wav_rms_threshold }}'"
            echo

            disk_image_path="${{ inputs.disk_image_path }}"
            qemu_system="${{ inputs.qemu_system }}"
            qemu_extra_args="${{ inputs.qemu_extra_args }}"
            dry_run="${{ inputs.dry_run }}"
            timeout_seconds="${{ inputs.timeout_seconds }}"
            memory_mb="${{ inputs.memory_mb }}"
            smp="${{ inputs.smp }}"
            http_port="${{ inputs.http_port }}"
            http_path="${{ inputs.http_path }}"
            udp_port="${{ inputs.udp_port }}"

            # workflow_dispatch inputs are freeform strings; trim leading/trailing whitespace
            # so accidental spaces do not cause confusing failures (e.g. `command -v`).
            disk_image_path="${disk_image_path#"${disk_image_path%%[![:space:]]*}"}"
            disk_image_path="${disk_image_path%"${disk_image_path##*[![:space:]]}"}"
            qemu_system="${qemu_system#"${qemu_system%%[![:space:]]*}"}"
            qemu_system="${qemu_system%"${qemu_system##*[![:space:]]}"}"
            timeout_seconds="${timeout_seconds#"${timeout_seconds%%[![:space:]]*}"}"
            timeout_seconds="${timeout_seconds%"${timeout_seconds##*[![:space:]]}"}"
            memory_mb="${memory_mb#"${memory_mb%%[![:space:]]*}"}"
            memory_mb="${memory_mb%"${memory_mb##*[![:space:]]}"}"
            smp="${smp#"${smp%%[![:space:]]*}"}"
            smp="${smp%"${smp##*[![:space:]]}"}"
            http_port="${http_port#"${http_port%%[![:space:]]*}"}"
            http_port="${http_port%"${http_port##*[![:space:]]}"}"
            http_path="${http_path#"${http_path%%[![:space:]]*}"}"
            http_path="${http_path%"${http_path##*[![:space:]]}"}"
            udp_port="${udp_port#"${udp_port%%[![:space:]]*}"}"
            udp_port="${udp_port%"${udp_port##*[![:space:]]}"}"
            if [[ -z "${qemu_system}" ]]; then
              echo "ERROR: workflow input 'qemu_system' is empty."
              exit 1
            fi
            if [[ -d "${qemu_system}" ]]; then
              echo "ERROR: workflow input 'qemu_system' is a directory: ${qemu_system}"
              exit 1
            fi

            if [[ -z "${disk_image_path}" ]]; then
              if [[ "${dry_run}" == "true" ]]; then
                disk_image_path="${log_dir}/dry-run-disk.img"
                touch "${disk_image_path}"
                echo "NOTE: workflow input 'disk_image_path' is empty; using placeholder for dry_run: ${disk_image_path}"
              else
                echo "ERROR: workflow input 'disk_image_path' is empty."
                echo "Provide a path on the self-hosted runner to a prepared Windows 7 image (qcow2/vhdx)."
                exit 1
              fi
            fi

            if [[ ! -e "${disk_image_path}" ]]; then
              if [[ "${dry_run}" == "true" ]]; then
                echo "WARNING: disk image path does not exist on the runner: ${disk_image_path}"
              else
                echo "ERROR: disk image path does not exist on the runner: ${disk_image_path}"
                exit 1
              fi
            fi
            if [[ -d "${disk_image_path}" ]]; then
              echo "ERROR: disk image path is a directory: ${disk_image_path}"
              exit 1
            fi

            if ! command -v "${qemu_system}" >/dev/null 2>&1; then
              if [[ "${dry_run}" == "true" ]]; then
                echo "WARNING: qemu system binary not found/executable: ${qemu_system}"
              else
                echo "ERROR: qemu system binary not found/executable: ${qemu_system}"
                exit 1
              fi
            fi

            if ! command -v python3 >/dev/null 2>&1; then
              echo "ERROR: python3 not found in PATH"
              exit 1
            fi

            if [[ -z "${timeout_seconds}" || ! "${timeout_seconds}" =~ ^[0-9]+$ ]]; then
              echo "ERROR: workflow input 'timeout_seconds' must be an integer number of seconds, got: '${timeout_seconds}'"
              exit 1
            fi
            if [[ -z "${memory_mb}" || ! "${memory_mb}" =~ ^[0-9]+$ ]]; then
              echo "ERROR: workflow input 'memory_mb' must be an integer (MiB), got: '${memory_mb}'"
              exit 1
            fi
            if (( memory_mb <= 0 )); then
              echo "ERROR: workflow input 'memory_mb' must be > 0, got: '${memory_mb}'"
              exit 1
            fi
            if [[ -z "${smp}" || ! "${smp}" =~ ^[0-9]+$ ]]; then
              echo "ERROR: workflow input 'smp' must be an integer vCPU count, got: '${smp}'"
              exit 1
            fi
            if (( smp <= 0 )); then
              echo "ERROR: workflow input 'smp' must be > 0, got: '${smp}'"
              exit 1
            fi
            if [[ -z "${http_port}" || ! "${http_port}" =~ ^[0-9]+$ ]]; then
              echo "ERROR: workflow input 'http_port' must be an integer TCP port, got: '${http_port}'"
              exit 1
            fi
            if (( http_port < 1 || http_port > 65535 )); then
              echo "ERROR: workflow input 'http_port' must be in range 1..65535, got: '${http_port}'"
              exit 1
            fi
            if [[ -z "${http_path}" ]]; then
              echo "ERROR: workflow input 'http_path' must be non-empty"
              exit 1
            fi
            if [[ "${http_path}" != /* ]]; then
              echo "ERROR: workflow input 'http_path' must start with '/', got: '${http_path}'"
              exit 1
            fi
            if [[ "${http_path}" =~ [[:space:]] ]]; then
              echo "ERROR: workflow input 'http_path' must not contain whitespace, got: '${http_path}'"
              exit 1
            fi
            if [[ -z "${udp_port}" || ! "${udp_port}" =~ ^[0-9]+$ ]]; then
              echo "ERROR: workflow input 'udp_port' must be an integer UDP port, got: '${udp_port}'"
              exit 1
            fi
            if (( udp_port < 1 || udp_port > 65535 )); then
              echo "ERROR: workflow input 'udp_port' must be in range 1..65535, got: '${udp_port}'"
              exit 1
            fi

            echo "python3: $(python3 --version 2>&1 || true)"
            if command -v "${qemu_system}" >/dev/null 2>&1; then
              echo "qemu: $(\"${qemu_system}\" --version 2>&1 | head -n 1 || true)"
            else
              echo "qemu: (not found)"
            fi
            echo

            echo "Running host-harness unit tests..."
            python3 -m unittest discover -s drivers/windows7/tests/host-harness/tests
            echo

            with_virtio_snd="${{ inputs.with_virtio_snd }}"
            virtio_snd_audio_backend="${{ inputs.virtio_snd_audio_backend }}"
            virtio_snd_verify_wav="${{ inputs.virtio_snd_verify_wav }}"
            virtio_snd_wav_peak_threshold="${{ inputs.virtio_snd_wav_peak_threshold }}"
            virtio_snd_wav_rms_threshold="${{ inputs.virtio_snd_wav_rms_threshold }}"
            force_intx="${{ inputs.force_intx }}"
            require_intx="${{ inputs.require_intx }}"
            require_msi="${{ inputs.require_msi }}"
            with_virtio_tablet="${{ inputs.with_virtio_tablet }}"
            virtio_transitional="${{ inputs.virtio_transitional }}"
            require_virtio_net_msix="${{ inputs.require_virtio_net_msix }}"
            require_virtio_blk_msix="${{ inputs.require_virtio_blk_msix }}"
            require_virtio_snd_msix="${{ inputs.require_virtio_snd_msix }}"
            require_virtio_input_msix="${{ inputs.require_virtio_input_msix }}"
            virtio_msix_vectors="${{ inputs.virtio_msix_vectors }}"
            virtio_net_vectors="${{ inputs.virtio_net_vectors }}"
            virtio_blk_vectors="${{ inputs.virtio_blk_vectors }}"
            virtio_input_vectors="${{ inputs.virtio_input_vectors }}"
            virtio_snd_vectors="${{ inputs.virtio_snd_vectors }}"
            with_virtio_input_events="${{ inputs.with_virtio_input_events }}"
            with_virtio_input_wheel="${{ inputs.with_virtio_input_wheel }}"
            with_virtio_input_media_keys="${{ inputs.with_virtio_input_media_keys }}"
            with_virtio_input_led="${{ inputs.with_virtio_input_led }}"
            with_virtio_input_leds="${{ inputs.with_virtio_input_leds }}"
            require_virtio_input_binding="${{ inputs.require_virtio_input_binding }}"
            with_virtio_input_events_extended="${{ inputs.with_virtio_input_events_extended }}"
            with_virtio_input_tablet_events="${{ inputs.with_virtio_input_tablet_events }}"
            with_blk_resize="${{ inputs.with_blk_resize }}"
            blk_resize_delta_mib="${{ inputs.blk_resize_delta_mib }}"
            require_expect_blk_msi="${{ inputs.require_expect_blk_msi }}"
            require_no_blk_recovery="${{ inputs.require_no_blk_recovery }}"
            fail_on_blk_recovery="${{ inputs.fail_on_blk_recovery }}"
            require_no_blk_reset_recovery="${{ inputs.require_no_blk_reset_recovery }}"
            fail_on_blk_reset_recovery="${{ inputs.fail_on_blk_reset_recovery }}"
            require_no_blk_miniport_flags="${{ inputs.require_no_blk_miniport_flags }}"
            fail_on_blk_miniport_flags="${{ inputs.fail_on_blk_miniport_flags }}"
            with_blk_reset="${{ inputs.with_blk_reset }}"
            with_net_link_flap="${{ inputs.with_net_link_flap }}"
            require_net_csum_offload="${{ inputs.require_net_csum_offload }}"
            require_net_udp_csum_offload="${{ inputs.require_net_udp_csum_offload }}"
            with_snd_buffer_limits="${{ inputs.with_snd_buffer_limits }}"

            virtio_snd_wav_peak_threshold="${virtio_snd_wav_peak_threshold#"${virtio_snd_wav_peak_threshold%%[![:space:]]*}"}"
            virtio_snd_wav_peak_threshold="${virtio_snd_wav_peak_threshold%"${virtio_snd_wav_peak_threshold##*[![:space:]]}"}"
            virtio_snd_wav_rms_threshold="${virtio_snd_wav_rms_threshold#"${virtio_snd_wav_rms_threshold%%[![:space:]]*}"}"
            virtio_snd_wav_rms_threshold="${virtio_snd_wav_rms_threshold%"${virtio_snd_wav_rms_threshold##*[![:space:]]}"}"
            virtio_msix_vectors="${virtio_msix_vectors#"${virtio_msix_vectors%%[![:space:]]*}"}"
            virtio_msix_vectors="${virtio_msix_vectors%"${virtio_msix_vectors##*[![:space:]]}"}"
            virtio_net_vectors="${virtio_net_vectors#"${virtio_net_vectors%%[![:space:]]*}"}"
            virtio_net_vectors="${virtio_net_vectors%"${virtio_net_vectors##*[![:space:]]}"}"
            virtio_blk_vectors="${virtio_blk_vectors#"${virtio_blk_vectors%%[![:space:]]*}"}"
            virtio_blk_vectors="${virtio_blk_vectors%"${virtio_blk_vectors##*[![:space:]]}"}"
            virtio_input_vectors="${virtio_input_vectors#"${virtio_input_vectors%%[![:space:]]*}"}"
            virtio_input_vectors="${virtio_input_vectors%"${virtio_input_vectors##*[![:space:]]}"}"
            virtio_snd_vectors="${virtio_snd_vectors#"${virtio_snd_vectors%%[![:space:]]*}"}"
            virtio_snd_vectors="${virtio_snd_vectors%"${virtio_snd_vectors##*[![:space:]]}"}"
            blk_resize_delta_mib="${blk_resize_delta_mib#"${blk_resize_delta_mib%%[![:space:]]*}"}"
            blk_resize_delta_mib="${blk_resize_delta_mib%"${blk_resize_delta_mib##*[![:space:]]}"}"

            if [[ -n "${virtio_snd_wav_peak_threshold}" && "${with_virtio_snd}" != "true" ]]; then
              echo "ERROR: workflow input virtio_snd_wav_peak_threshold requires with_virtio_snd=true" >&2
              exit 1
            fi
            if [[ -n "${virtio_snd_wav_rms_threshold}" && "${with_virtio_snd}" != "true" ]]; then
              echo "ERROR: workflow input virtio_snd_wav_rms_threshold requires with_virtio_snd=true" >&2
              exit 1
            fi
            if [[ -n "${virtio_snd_wav_peak_threshold}" && ! "${virtio_snd_wav_peak_threshold}" =~ ^[0-9]+$ ]]; then
              echo "ERROR: workflow input virtio_snd_wav_peak_threshold must be a non-negative integer, got: '${virtio_snd_wav_peak_threshold}'" >&2
              exit 1
            fi
            if [[ -n "${virtio_snd_wav_rms_threshold}" && ! "${virtio_snd_wav_rms_threshold}" =~ ^[0-9]+$ ]]; then
              echo "ERROR: workflow input virtio_snd_wav_rms_threshold must be a non-negative integer, got: '${virtio_snd_wav_rms_threshold}'" >&2
              exit 1
            fi

            if [[ "${require_intx}" == "true" && "${require_msi}" == "true" ]]; then
              echo "ERROR: workflow inputs require_intx=true and require_msi=true are mutually exclusive" >&2
              exit 1
            fi
            if [[ "${force_intx}" == "true" && "${require_msi}" == "true" ]]; then
              echo "ERROR: workflow input force_intx=true is incompatible with require_msi=true (force_intx disables MSI-X)" >&2
              exit 1
            fi
            if [[ "${virtio_transitional}" == "true" && "${with_blk_resize}" == "true" ]]; then
              echo "ERROR: workflow input virtio_transitional=true is incompatible with with_blk_resize=true (blk resize requires the contract-v1 drive layout)" >&2
              exit 1
            fi
            if [[ "${virtio_transitional}" == "true" && "${with_virtio_snd}" == "true" ]]; then
              echo "ERROR: workflow input virtio_transitional=true is incompatible with with_virtio_snd=true (virtio-snd requires modern-only contract-v1 layout)" >&2
              exit 1
            fi
            if [[ "${require_virtio_snd_msix}" == "true" && "${with_virtio_snd}" != "true" ]]; then
              echo "ERROR: workflow input require_virtio_snd_msix=true requires with_virtio_snd=true" >&2
              exit 1
            fi
            if [[ -n "${virtio_snd_vectors}" && "${with_virtio_snd}" != "true" ]]; then
              echo "ERROR: workflow input virtio_snd_vectors requires with_virtio_snd=true" >&2
              exit 1
            fi
            if [[ "${require_intx}" == "true" && ( "${require_virtio_net_msix}" == "true" || "${require_virtio_blk_msix}" == "true" || "${require_virtio_snd_msix}" == "true" || "${require_virtio_input_msix}" == "true" ) ]]; then
              echo "ERROR: workflow input require_intx=true is incompatible with require_virtio_*_msix=true (MSI-X implies message interrupts)" >&2
              exit 1
            fi
            if [[ -n "${virtio_msix_vectors}" ]]; then
              if [[ ! "${virtio_msix_vectors}" =~ ^[0-9]+$ ]]; then
                echo "ERROR: workflow input virtio_msix_vectors must be a positive integer, got: '${virtio_msix_vectors}'" >&2
                exit 1
              fi
              if (( virtio_msix_vectors <= 0 )); then
                echo "ERROR: workflow input virtio_msix_vectors must be > 0, got: '${virtio_msix_vectors}'" >&2
                exit 1
              fi
            fi
            if [[ -n "${virtio_net_vectors}" ]]; then
              if [[ ! "${virtio_net_vectors}" =~ ^[0-9]+$ ]]; then
                echo "ERROR: workflow input virtio_net_vectors must be a positive integer, got: '${virtio_net_vectors}'" >&2
                exit 1
              fi
              if (( virtio_net_vectors <= 0 )); then
                echo "ERROR: workflow input virtio_net_vectors must be > 0, got: '${virtio_net_vectors}'" >&2
                exit 1
              fi
            fi
            if [[ -n "${virtio_blk_vectors}" ]]; then
              if [[ ! "${virtio_blk_vectors}" =~ ^[0-9]+$ ]]; then
                echo "ERROR: workflow input virtio_blk_vectors must be a positive integer, got: '${virtio_blk_vectors}'" >&2
                exit 1
              fi
              if (( virtio_blk_vectors <= 0 )); then
                echo "ERROR: workflow input virtio_blk_vectors must be > 0, got: '${virtio_blk_vectors}'" >&2
                exit 1
              fi
            fi
            if [[ -n "${virtio_input_vectors}" ]]; then
              if [[ ! "${virtio_input_vectors}" =~ ^[0-9]+$ ]]; then
                echo "ERROR: workflow input virtio_input_vectors must be a positive integer, got: '${virtio_input_vectors}'" >&2
                exit 1
              fi
              if (( virtio_input_vectors <= 0 )); then
                echo "ERROR: workflow input virtio_input_vectors must be > 0, got: '${virtio_input_vectors}'" >&2
                exit 1
              fi
            fi
            if [[ -n "${virtio_snd_vectors}" ]]; then
              if [[ ! "${virtio_snd_vectors}" =~ ^[0-9]+$ ]]; then
                echo "ERROR: workflow input virtio_snd_vectors must be a positive integer, got: '${virtio_snd_vectors}'" >&2
                exit 1
              fi
              if (( virtio_snd_vectors <= 0 )); then
                echo "ERROR: workflow input virtio_snd_vectors must be > 0, got: '${virtio_snd_vectors}'" >&2
                exit 1
              fi
            fi
            if [[ "${force_intx}" == "true" && ( -n "${virtio_msix_vectors}" || -n "${virtio_net_vectors}" || -n "${virtio_blk_vectors}" || -n "${virtio_input_vectors}" || -n "${virtio_snd_vectors}" ) ]]; then
              echo "ERROR: workflow input force_intx=true is mutually exclusive with virtio_*_vectors inputs (force_intx forces vectors=0)" >&2
              exit 1
            fi
            if [[ "${force_intx}" == "true" && ( "${require_virtio_net_msix}" == "true" || "${require_virtio_blk_msix}" == "true" || "${require_virtio_snd_msix}" == "true" || "${require_virtio_input_msix}" == "true" ) ]]; then
              echo "ERROR: workflow input force_intx=true is incompatible with require_virtio_*_msix=true (force_intx disables MSI-X)" >&2
              exit 1
            fi

            # Remove stale output from previous runs (self-hosted runners persist state).
            rm -f "${virtio_snd_wav_path}"

            args=(
              python3 -u drivers/windows7/tests/host-harness/invoke_aero_virtio_win7_tests.py
              --qemu-system "${qemu_system}"
              --disk-image "${disk_image_path}"
              --memory-mb "${memory_mb}"
              --smp "${smp}"
              --serial-log "${serial_log}"
              --http-log "${http_log}"
              --http-port "${http_port}"
              --http-path "${http_path}"
              --udp-port "${udp_port}"
              --timeout-seconds "${timeout_seconds}"
            )
            if [[ "${{ inputs.snapshot }}" == "true" ]]; then
              args+=(--snapshot)
            fi
            if [[ "${dry_run}" == "true" ]]; then
              args+=(--dry-run)
            fi
            if [[ "${{ inputs.follow_serial }}" == "true" ]]; then
              args+=(--follow-serial)
            fi
            if [[ "${{ inputs.qemu_preflight_pci }}" == "true" ]]; then
              args+=(--qemu-preflight-pci)
            fi
            if [[ "${virtio_transitional}" == "true" ]]; then
              args+=(--virtio-transitional)
            fi
            if [[ "${{ inputs.disable_udp }}" == "true" ]]; then
              args+=(--disable-udp)
            fi
            if [[ "${force_intx}" == "true" ]]; then
              args+=(--force-intx)
            fi
            if [[ -n "${virtio_msix_vectors}" ]]; then
              args+=(--virtio-msix-vectors "${virtio_msix_vectors}")
            fi
            if [[ -n "${virtio_net_vectors}" ]]; then
              args+=(--virtio-net-vectors "${virtio_net_vectors}")
            fi
            if [[ -n "${virtio_blk_vectors}" ]]; then
              args+=(--virtio-blk-vectors "${virtio_blk_vectors}")
            fi
            if [[ -n "${virtio_input_vectors}" ]]; then
              args+=(--virtio-input-vectors "${virtio_input_vectors}")
            fi
            if [[ -n "${virtio_snd_vectors}" ]]; then
              args+=(--virtio-snd-vectors "${virtio_snd_vectors}")
            fi
            if [[ "${require_intx}" == "true" ]]; then
              args+=(--require-intx)
            fi
            if [[ "${require_msi}" == "true" ]]; then
              args+=(--require-msi)
            fi
            if [[ "${require_virtio_net_msix}" == "true" ]]; then
              args+=(--require-virtio-net-msix)
            fi
            if [[ "${require_virtio_blk_msix}" == "true" ]]; then
              args+=(--require-virtio-blk-msix)
            fi
            if [[ "${require_virtio_snd_msix}" == "true" ]]; then
              args+=(--require-virtio-snd-msix)
            fi
            if [[ "${require_virtio_input_msix}" == "true" ]]; then
              args+=(--require-virtio-input-msix)
            fi
            if [[ "${with_virtio_input_events}" == "true" ]]; then
              args+=(--with-input-events)
            fi
            if [[ "${with_virtio_input_wheel}" == "true" ]]; then
              args+=(--with-input-wheel)
            fi
            if [[ "${with_virtio_input_media_keys}" == "true" ]]; then
              args+=(--with-input-media-keys)
            fi
            if [[ "${with_virtio_input_leds}" == "true" && "${with_virtio_input_led}" == "true" ]]; then
              echo "NOTE: workflow inputs with_virtio_input_leds=true and with_virtio_input_led=true; using legacy --with-input-leds"
            fi
            if [[ "${with_virtio_input_leds}" == "true" ]]; then
              args+=(--with-input-leds)
            elif [[ "${with_virtio_input_led}" == "true" ]]; then
              args+=(--with-input-led)
            fi
            if [[ "${require_virtio_input_binding}" == "true" ]]; then
              args+=(--require-virtio-input-binding)
            fi
            if [[ "${with_virtio_input_events_extended}" == "true" ]]; then
              args+=(--with-input-events-extended)
            fi
            if [[ "${with_virtio_input_tablet_events}" == "true" ]]; then
              args+=(--with-tablet-events)
            fi
            if [[ "${with_virtio_tablet}" == "true" ]]; then
              args+=(--with-virtio-tablet)
            fi
            if [[ "${with_blk_resize}" == "true" ]]; then
              args+=(--with-blk-resize)
              if [[ -n "${blk_resize_delta_mib}" ]]; then
                if [[ ! "${blk_resize_delta_mib}" =~ ^[0-9]+$ ]]; then
                  echo "ERROR: workflow input blk_resize_delta_mib must be an integer (MiB), got: '${blk_resize_delta_mib}'" >&2
                  exit 1
                fi
                if (( blk_resize_delta_mib <= 0 )); then
                  echo "ERROR: workflow input blk_resize_delta_mib must be > 0, got: '${blk_resize_delta_mib}'" >&2
                  exit 1
                fi
                args+=(--blk-resize-delta-mib "${blk_resize_delta_mib}")
              fi
            fi
            if [[ "${require_expect_blk_msi}" == "true" ]]; then
              args+=(--require-expect-blk-msi)
            fi
            if [[ "${require_no_blk_recovery}" == "true" ]]; then
              args+=(--require-no-blk-recovery)
            fi
            if [[ "${fail_on_blk_recovery}" == "true" ]]; then
              args+=(--fail-on-blk-recovery)
            fi
            if [[ "${require_no_blk_reset_recovery}" == "true" ]]; then
              args+=(--require-no-blk-reset-recovery)
            fi
            if [[ "${fail_on_blk_reset_recovery}" == "true" ]]; then
              args+=(--fail-on-blk-reset-recovery)
            fi
            if [[ "${require_no_blk_miniport_flags}" == "true" ]]; then
              args+=(--require-no-blk-miniport-flags)
            fi
            if [[ "${fail_on_blk_miniport_flags}" == "true" ]]; then
              args+=(--fail-on-blk-miniport-flags)
            fi
            if [[ "${with_blk_reset}" == "true" ]]; then
              args+=(--with-blk-reset)
            fi
            if [[ "${with_net_link_flap}" == "true" ]]; then
              args+=(--with-net-link-flap)
            fi
            if [[ "${require_net_csum_offload}" == "true" ]]; then
              args+=(--require-net-csum-offload)
            fi
            if [[ "${require_net_udp_csum_offload}" == "true" ]]; then
              args+=(--require-net-udp-csum-offload)
            fi
            if [[ "${with_virtio_snd}" == "true" ]]; then
              args+=(--with-virtio-snd)

              case "${virtio_snd_audio_backend}" in
                wav)
                  args+=(--virtio-snd-audio-backend=wav --virtio-snd-wav-path "${virtio_snd_wav_path}")

                  if [[ "${virtio_snd_verify_wav}" == "true" ]]; then
                    args+=(--virtio-snd-verify-wav)
                  fi

                  if [[ -n "${virtio_snd_wav_peak_threshold}" ]]; then
                    args+=(--virtio-snd-wav-peak-threshold "${virtio_snd_wav_peak_threshold}")
                  fi
                  if [[ -n "${virtio_snd_wav_rms_threshold}" ]]; then
                    args+=(--virtio-snd-wav-rms-threshold "${virtio_snd_wav_rms_threshold}")
                  fi
                  ;;
                none)
                  args+=(--virtio-snd-audio-backend=none)
                  if [[ "${virtio_snd_verify_wav}" == "true" ]]; then
                    echo "NOTE: virtio_snd_verify_wav=true is ignored because virtio_snd_audio_backend=none"
                  fi
                  ;;
                *)
                  echo "ERROR: unknown workflow input virtio_snd_audio_backend='${virtio_snd_audio_backend}'" >&2
                  exit 1
                  ;;
              esac
            fi
            if [[ "${with_snd_buffer_limits}" == "true" ]]; then
              if [[ "${with_virtio_snd}" != "true" ]]; then
                echo "ERROR: workflow input with_snd_buffer_limits=true requires with_virtio_snd=true"
                exit 1
              fi
              args+=(--with-snd-buffer-limits)
            fi
            if [[ -n "${qemu_extra_args}" ]]; then
              qemu_extra_added=false
              while IFS= read -r line; do
                line="${line%$'\r'}"
                line="${line#"${line%%[![:space:]]*}"}"
                line="${line%"${line##*[![:space:]]}"}"
                if [[ -z "${line}" || "${line}" == \#* ]]; then
                  continue
                fi
                if [[ "${qemu_extra_added}" != "true" ]]; then
                  args+=(--)
                  qemu_extra_added=true
                fi
                args+=("${line}")
              done <<<"${qemu_extra_args}"
            fi

            echo "Executing harness:"
            printf '  %q' "${args[@]}"
            echo
            echo

            set +e
            "${args[@]}"
            harness_exit=$?
            set -e

            exit "${harness_exit}"
          ) 2>&1 | tee "${harness_log}"

          # Capture the harness exit code even when the pipeline fails, so we can surface it
          # in job summaries and downstream steps.
          harness_exit="${PIPESTATUS[0]}"

          # Ensure the logs artifact has a stable shape even when the harness fails before
          # producing serial/HTTP logs (e.g. unit tests fail, QEMU exits immediately, etc).
          if [[ ! -s "${serial_log}" ]]; then
            echo "(serial log was not produced)" >"${serial_log}"
          fi
          if [[ ! -s "${http_log}" ]]; then
            echo "(no HTTP requests were logged)" >"${http_log}"
          fi
          qemu_stderr_log="${serial_log%.*}.qemu.stderr.log"
          if [[ ! -f "${qemu_stderr_log}" ]]; then
            echo "(qemu stderr log was not produced)" >"${qemu_stderr_log}"
          fi
          set -e
          echo "exit_code=${harness_exit}" >>"${GITHUB_OUTPUT}"
          exit "${harness_exit}"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: win7-virtio-harness-logs
          if-no-files-found: error
          # Includes virtio-snd.wav when virtio-snd is enabled with the wav backend.
          path: out/win7-virtio-harness-logs/

      - name: Job summary
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          log_dir="out/win7-virtio-harness-logs"
          harness_log="${log_dir}/harness.log"
          serial_log="${log_dir}/win7-virtio-serial.log"
          http_log="${log_dir}/http.log"
          qemu_stderr_log="${serial_log%.*}.qemu.stderr.log"

          config_marker=""
          result_marker=""
          blk_marker=""
          blk_marker_line=""
          blk_msix_marker_line=""
          blk_counters_marker=""
          blk_miniport_flags_marker=""
          blk_miniport_reset_recovery_marker=""
          blk_resize_marker=""
          blk_resize_marker_line=""
          blk_reset_marker=""
          blk_reset_marker_line=""
          blk_reset_recovery_marker=""
          net_marker=""
          net_marker_line=""
          net_msix_marker_line=""
          net_udp_marker=""
          net_udp_marker_line=""
          net_link_flap_marker=""
          net_link_flap_marker_line=""
          net_link_flap_host_marker=""
          net_offload_csum_marker=""
          snd_marker=""
          snd_marker_line=""
          snd_msix_marker_line=""
          input_events_marker=""
          input_events_marker_line=""
          input_wheel_marker=""
          input_wheel_marker_line=""
          input_media_keys_marker=""
          input_media_keys_marker_line=""
          input_led_marker=""
          input_leds_marker=""
          input_binding_host_marker=""
          input_bind_host_marker=""
          input_msix_marker_line=""
          input_events_modifiers_marker=""
          input_events_modifiers_marker_line=""
          input_events_buttons_marker=""
          input_events_buttons_marker_line=""
          input_events_wheel_marker=""
          input_events_wheel_marker_line=""
          input_tablet_marker=""
          input_tablet_marker_line=""
          input_inject_marker=""
          input_media_keys_inject_marker=""
          input_tablet_inject_marker=""
          pci_preflight_marker=""
          blk_resize_request_marker=""
          blk_resize_fail_marker=""
          blk_resize_host_marker=""
          blk_io_host_marker=""
          net_large_host_marker=""
          net_udp_host_marker=""
          net_udp_dns_host_marker=""
          net_offload_csum_host_marker=""
          net_diag_host_marker=""
          snd_host_marker=""
          snd_capture_host_marker=""
          snd_duplex_host_marker=""
          snd_buffer_limits_host_marker=""
          snd_format_host_marker=""
          snd_eventq_host_marker=""
          snd_capture_marker=""
          snd_capture_marker_line=""
          snd_duplex_marker=""
          snd_duplex_marker_line=""
          snd_buffer_limits_marker=""
          snd_buffer_limits_marker_line=""
          wav_marker=""
          failure_token=""
          failure_line=""
          note_line=""
          warning_line=""
          error_line=""
          force_intx_host_marker=""
          blk_irq_host_marker=""
          net_irq_host_marker=""
          snd_irq_host_marker=""
          input_irq_host_marker=""
          net_msix_host_marker=""
          blk_msix_host_marker=""
          snd_msix_host_marker=""
          input_msix_host_marker=""
          blk_recovery_host_marker=""
          blk_counters_host_marker=""
          blk_reset_host_marker=""
          blk_reset_recovery_host_marker=""
          blk_miniport_flags_host_marker=""
          blk_miniport_reset_recovery_host_marker=""
          qemu_stderr_line=""
          harness_cmdline=""
          dry_run_qemu_cmdline=""
          dry_run_qemu_json=""
          qemu_cmdline=""
          runner_line=""
          python_version_line=""
          qemu_version_line=""
          if [[ -f "${serial_log}" ]]; then
            config_marker="$(grep -F 'AERO_VIRTIO_SELFTEST|CONFIG|' "${serial_log}" | tail -n 1 | tr -d '\r' || true)"
            result_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|RESULT\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            blk_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-blk\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            blk_marker_line="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-blk|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            blk_msix_marker_line="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-blk-msix|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            blk_counters_marker="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-blk-counters|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            blk_miniport_flags_marker="$(
              grep -F 'virtio-blk-miniport-flags|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            blk_miniport_reset_recovery_marker="$(
              grep -F 'virtio-blk-miniport-reset-recovery|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            blk_resize_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-blk-resize\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            blk_resize_marker_line="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-blk-resize|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            blk_reset_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-blk-reset\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            blk_reset_marker_line="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-blk-reset|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            blk_reset_recovery_marker="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-blk-reset-recovery|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            net_udp_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-net-udp\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            net_udp_marker_line="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-net-udp|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            net_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-net\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            net_marker_line="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-net|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            net_msix_marker_line="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-net-msix|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            net_link_flap_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-net-link-flap\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            net_link_flap_marker_line="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-net-link-flap|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            net_offload_csum_marker="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-net-offload-csum|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            snd_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-snd\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            snd_marker_line="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-snd|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            snd_msix_marker_line="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-snd-msix|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            input_events_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-input-events\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            input_events_marker_line="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-input-events|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            input_wheel_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-input-wheel\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            input_wheel_marker_line="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-input-wheel|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            input_media_keys_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-input-media-keys\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            input_media_keys_marker_line="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-input-media-keys|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            input_led_marker="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-input-led|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            input_leds_marker="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-input-leds|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            input_msix_marker_line="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-input-msix|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            input_events_modifiers_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-input-events-modifiers\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            input_events_modifiers_marker_line="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-input-events-modifiers|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            input_events_buttons_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-input-events-buttons\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            input_events_buttons_marker_line="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-input-events-buttons|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            input_events_wheel_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-input-events-wheel\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            input_events_wheel_marker_line="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-input-events-wheel|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            input_tablet_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-input-tablet-events\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            input_tablet_marker_line="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-input-tablet-events|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            snd_capture_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-snd-capture\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            snd_capture_marker_line="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-snd-capture|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            snd_duplex_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-snd-duplex\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            snd_duplex_marker_line="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-snd-duplex|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
            snd_buffer_limits_marker="$(grep -Eo 'AERO_VIRTIO_SELFTEST\\|TEST\\|virtio-snd-buffer-limits\\|[A-Z]+' "${serial_log}" | tail -n 1 || true)"
            snd_buffer_limits_marker_line="$(
              grep -F 'AERO_VIRTIO_SELFTEST|TEST|virtio-snd-buffer-limits|' "${serial_log}" | tail -n 1 | tr -d '\r' || true
            )"
          fi
          if [[ -f "${harness_log}" ]]; then
            wav_marker="$(grep -Eo 'AERO_VIRTIO_WIN7_HOST\\|VIRTIO_SND_WAV\\|[A-Z]+' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            input_inject_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_INPUT_EVENTS_INJECT|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            input_media_keys_inject_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_INPUT_MEDIA_KEYS_INJECT|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            input_tablet_inject_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_INPUT_TABLET_EVENTS_INJECT|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            input_bind_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_INPUT_BIND|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            input_binding_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_INPUT_BINDING|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            force_intx_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|CONFIG|force_intx=1' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            blk_irq_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_BLK_IRQ|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            net_irq_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_NET_IRQ|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            snd_irq_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_SND_IRQ|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            input_irq_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_INPUT_IRQ|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            net_msix_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_NET_MSIX|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            blk_msix_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_BLK_MSIX|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            snd_msix_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_SND_MSIX|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            input_msix_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_INPUT_MSIX|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            blk_recovery_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_BLK_RECOVERY|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            blk_counters_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_BLK_COUNTERS|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            blk_reset_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_BLK_RESET|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            blk_reset_recovery_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_BLK_RESET_RECOVERY|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            blk_miniport_flags_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_BLK_MINIPORT_FLAGS|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            blk_miniport_reset_recovery_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_BLK_MINIPORT_RESET_RECOVERY|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            pci_preflight_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|QEMU_PCI_PREFLIGHT|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            blk_resize_request_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_BLK_RESIZE|REQUEST|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            blk_resize_fail_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_BLK_RESIZE|FAIL|reason=' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            blk_resize_host_marker="$(
              grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_BLK_RESIZE|' "${harness_log}" \
                | grep -vF '|REQUEST|' \
                | grep -vF '|FAIL|reason=' \
                | tail -n 1 | tr -d '\r' \
                || true
            )"
            blk_io_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_BLK_IO|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            net_large_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_NET_LARGE|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            net_udp_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_NET_UDP|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            net_udp_dns_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_NET_UDP_DNS|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            net_offload_csum_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_NET_OFFLOAD_CSUM|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            net_diag_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_NET_DIAG|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            snd_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_SND|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            snd_capture_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_SND_CAPTURE|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            snd_duplex_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_SND_DUPLEX|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            snd_buffer_limits_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_SND_BUFFER_LIMITS|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            snd_format_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_SND_FORMAT|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            snd_eventq_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_SND_EVENTQ|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            net_link_flap_host_marker="$(grep -F 'AERO_VIRTIO_WIN7_HOST|VIRTIO_NET_LINK_FLAP|' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            # Extract the last structured failure token from the harness output, if present.
            # Example: "FAIL: MISSING_VIRTIO_INPUT_EVENTS: ..."
            failure_token="$(grep -Eo 'FAIL: [A-Z0-9_]+:' "${harness_log}" | tail -n 1 | sed -e 's/^FAIL: //' -e 's/:$//' || true)"
            # The full last failure line (often includes useful context beyond the token, such as counter values).
            failure_line="$(grep -F 'FAIL:' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            # The full last NOTE line (if any).
            note_line="$(grep -F 'NOTE:' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            # The full last warning line (if any).
            warning_line="$(grep -F 'WARNING:' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            # The last explicit "ERROR:" line (if any).
            error_line="$(grep -F 'ERROR:' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            harness_cmdline="$(awk '/Executing harness:/{getline; sub(/^[[:space:]]+/, ""); print}' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            qemu_cmdline="$(awk '/Launching QEMU:/{getline; sub(/^[[:space:]]+/, ""); print}' "${harness_log}" | tail -n 1 | tr -d '\r' || true)"
            dry_run_qemu_json="$(awk '/^\["/{print; exit}' "${harness_log}" | tr -d '\r' || true)"
            dry_run_qemu_cmdline="$(awk '/^\["/{getline; sub(/^[[:space:]]+/, ""); print; exit}' "${harness_log}" | tr -d '\r' || true)"
            if [[ "${{ inputs.dry_run }}" == "true" && -z "${qemu_cmdline}" && -n "${dry_run_qemu_cmdline}" ]]; then
              qemu_cmdline="${dry_run_qemu_cmdline}"
            fi
            runner_line="$(grep -m1 -F 'Runner:' "${harness_log}" | tr -d '\r' || true)"
            python_version_line="$(grep -m1 -F 'python3:' "${harness_log}" | tr -d '\r' || true)"
            qemu_version_line="$(grep -m1 -F 'qemu:' "${harness_log}" | tr -d '\r' || true)"
          fi
          if [[ -f "${qemu_stderr_log}" ]]; then
            qemu_stderr_line="$(tail -n 1 "${qemu_stderr_log}" | tr -d '\r' || true)"
          fi

          {
            echo "### Win7 virtio host harness"
            echo ""
            echo "- Harness step: ${{ steps.harness.outcome || 'skipped' }}"
            echo "- Harness exit code: ${{ steps.harness.outputs.exit_code || 'unknown' }}"
            if [[ "${{ inputs.dry_run }}" == "true" ]]; then
              echo "- Dry run: true (QEMU not launched)"
            fi
            if [[ -n "${runner_line}" ]]; then
              echo "- ${runner_line}"
            fi
            if [[ -n "${python_version_line}" ]]; then
              echo "- ${python_version_line}"
            fi
            if [[ -n "${qemu_version_line}" ]]; then
              echo "- ${qemu_version_line}"
            fi
            if [[ -n "${note_line}" ]]; then
              echo "- Harness note (last line): \`${note_line}\`"
            fi
            if [[ -n "${warning_line}" ]]; then
              echo "- Harness warning (last line): \`${warning_line}\`"
            fi
            if [[ -n "${force_intx_host_marker}" ]]; then
              echo "- Host force INTx marker: \`${force_intx_host_marker}\`"
            fi
            if [[ -n "${config_marker}" ]]; then
              echo "- Guest CONFIG marker: \`${config_marker}\`"
            fi
            if [[ -n "${blk_irq_host_marker}" ]]; then
              echo "- Host virtio-blk IRQ marker: \`${blk_irq_host_marker}\`"
            fi
            if [[ -n "${net_irq_host_marker}" ]]; then
              echo "- Host virtio-net IRQ marker: \`${net_irq_host_marker}\`"
            fi
            if [[ -n "${snd_irq_host_marker}" ]]; then
              echo "- Host virtio-snd IRQ marker: \`${snd_irq_host_marker}\`"
            fi
            if [[ -n "${input_irq_host_marker}" ]]; then
              echo "- Host virtio-input IRQ marker: \`${input_irq_host_marker}\`"
            fi
            if [[ -n "${blk_recovery_host_marker}" ]]; then
              echo "- Host virtio-blk recovery marker: \`${blk_recovery_host_marker}\`"
            fi
            if [[ -n "${blk_counters_host_marker}" ]]; then
              echo "- Host virtio-blk counters marker: \`${blk_counters_host_marker}\`"
            fi
            if [[ -n "${net_msix_host_marker}" ]]; then
              echo "- Host virtio-net MSI-X marker: \`${net_msix_host_marker}\`"
            fi
            if [[ -n "${blk_msix_host_marker}" ]]; then
              echo "- Host virtio-blk MSI-X marker: \`${blk_msix_host_marker}\`"
            fi
            if [[ -n "${snd_msix_host_marker}" ]]; then
              echo "- Host virtio-snd MSI-X marker: \`${snd_msix_host_marker}\`"
            fi
            if [[ -n "${input_msix_host_marker}" ]]; then
              echo "- Host virtio-input MSI-X marker: \`${input_msix_host_marker}\`"
            fi
            if [[ -n "${failure_token}" ]]; then
              echo "- Harness failure token: \`${failure_token}\`"
            fi
            # Always surface the last `FAIL:` line as well (it often includes useful context beyond the
            # structured token, such as counter values).
            if [[ -n "${failure_line}" ]]; then
              echo "- Harness failure: \`${failure_line}\`"
            fi
            # Similarly, surface the last explicit `ERROR:` line even when a structured failure token is present.
            if [[ -n "${error_line}" ]]; then
              echo "- Harness error: \`${error_line}\`"
            fi
            if [[ "${{ steps.harness.outcome }}" != "success" && -n "${qemu_stderr_line}" && "${qemu_stderr_line}" != "(qemu stderr log was not produced)" && "${qemu_stderr_line}" != "(qemu stderr log was empty)" ]]; then
              echo "- QEMU stderr (last line): \`${qemu_stderr_line}\`"
            fi
            if [[ ( "${{ steps.harness.outcome }}" != "success" || "${{ inputs.dry_run }}" == "true" ) && -n "${harness_cmdline}" ]]; then
              echo "- Harness command: \`${harness_cmdline}\`"
            fi
            if [[ ( "${{ steps.harness.outcome }}" != "success" || "${{ inputs.dry_run }}" == "true" ) && -n "${qemu_cmdline}" ]]; then
              echo "- QEMU command: \`${qemu_cmdline}\`"
            fi
            if [[ "${{ inputs.dry_run }}" == "true" && -n "${dry_run_qemu_json}" ]]; then
              echo ""
              echo "<details><summary>Dry run QEMU argv (JSON)</summary>"
              echo ""
              echo '```json'
              echo "${dry_run_qemu_json}"
              echo '```'
              echo "</details>"
            fi
            if [[ -n "${result_marker}" ]]; then
              echo "- Guest result marker: \`${result_marker}\`"
            fi
            if [[ -n "${blk_marker}" ]]; then
              echo "- Guest virtio-blk marker: \`${blk_marker}\`"
            fi
            if [[ -n "${blk_marker_line}" ]]; then
              echo "- Guest virtio-blk marker line: \`${blk_marker_line}\`"
            fi
            if [[ -n "${blk_msix_marker_line}" ]]; then
              echo "- Guest virtio-blk-msix marker line: \`${blk_msix_marker_line}\`"
            fi
            if [[ -n "${blk_counters_marker}" ]]; then
              echo "- Guest virtio-blk-counters marker: \`${blk_counters_marker}\`"
            fi
            if [[ -n "${blk_resize_marker}" ]]; then
              echo "- Guest virtio-blk-resize marker: \`${blk_resize_marker}\`"
            fi
            if [[ -n "${blk_resize_marker_line}" ]]; then
              echo "- Guest virtio-blk-resize marker line: \`${blk_resize_marker_line}\`"
            fi
            if [[ -n "${blk_reset_marker}" ]]; then
              echo "- Guest virtio-blk-reset marker: \`${blk_reset_marker}\`"
            fi
            if [[ -n "${blk_reset_marker_line}" ]]; then
              echo "- Guest virtio-blk-reset marker line: \`${blk_reset_marker_line}\`"
            fi
            if [[ -n "${blk_reset_recovery_marker}" ]]; then
              echo "- Guest virtio-blk-reset-recovery marker: \`${blk_reset_recovery_marker}\`"
            fi
            if [[ -n "${blk_miniport_flags_marker}" ]]; then
              echo "- Guest virtio-blk-miniport-flags diagnostic: \`${blk_miniport_flags_marker}\`"
            fi
            if [[ -n "${blk_miniport_reset_recovery_marker}" ]]; then
              echo "- Guest virtio-blk-miniport-reset-recovery diagnostic: \`${blk_miniport_reset_recovery_marker}\`"
            fi
            if [[ -n "${blk_reset_host_marker}" ]]; then
              echo "- Host virtio-blk-reset marker: \`${blk_reset_host_marker}\`"
            fi
            if [[ -n "${blk_reset_recovery_host_marker}" ]]; then
              echo "- Host virtio-blk-reset-recovery marker: \`${blk_reset_recovery_host_marker}\`"
            fi
            if [[ -n "${blk_miniport_flags_host_marker}" ]]; then
              echo "- Host virtio-blk miniport flags marker: \`${blk_miniport_flags_host_marker}\`"
            fi
            if [[ -n "${blk_miniport_reset_recovery_host_marker}" ]]; then
              echo "- Host virtio-blk miniport reset recovery marker: \`${blk_miniport_reset_recovery_host_marker}\`"
            fi
            if [[ -n "${net_link_flap_marker}" ]]; then
              echo "- Guest virtio-net-link-flap marker: \`${net_link_flap_marker}\`"
            fi
            if [[ -n "${net_link_flap_marker_line}" ]]; then
              echo "- Guest virtio-net-link-flap marker line: \`${net_link_flap_marker_line}\`"
            fi
            if [[ -n "${net_udp_marker}" ]]; then
              echo "- Guest virtio-net-udp marker: \`${net_udp_marker}\`"
            fi
            if [[ -n "${net_udp_marker_line}" ]]; then
              echo "- Guest virtio-net-udp marker line: \`${net_udp_marker_line}\`"
            fi
            if [[ -n "${net_marker}" ]]; then
              echo "- Guest virtio-net marker: \`${net_marker}\`"
            fi
            if [[ -n "${net_marker_line}" ]]; then
              echo "- Guest virtio-net marker line: \`${net_marker_line}\`"
            fi
            if [[ -n "${net_msix_marker_line}" ]]; then
              echo "- Guest virtio-net-msix marker line: \`${net_msix_marker_line}\`"
            fi
            if [[ -n "${net_offload_csum_marker}" ]]; then
              echo "- Guest virtio-net-offload-csum marker: \`${net_offload_csum_marker}\`"
            fi
            if [[ -n "${blk_resize_request_marker}" ]]; then
              echo "- Host virtio-blk-resize request marker: \`${blk_resize_request_marker}\`"
            fi
            if [[ -n "${blk_resize_fail_marker}" ]]; then
              echo "- Host virtio-blk-resize QMP failure marker: \`${blk_resize_fail_marker}\`"
            fi
            if [[ -n "${blk_resize_host_marker}" ]]; then
              echo "- Host virtio-blk-resize marker: \`${blk_resize_host_marker}\`"
            fi
            if [[ -n "${blk_io_host_marker}" ]]; then
              echo "- Host virtio-blk I/O marker: \`${blk_io_host_marker}\`"
            fi
            if [[ -n "${net_link_flap_host_marker}" ]]; then
              echo "- Host virtio-net-link-flap marker: \`${net_link_flap_host_marker}\`"
            fi
            if [[ -n "${net_large_host_marker}" ]]; then
              echo "- Host virtio-net-large marker: \`${net_large_host_marker}\`"
            fi
            if [[ -n "${net_udp_host_marker}" ]]; then
              echo "- Host virtio-net-udp marker: \`${net_udp_host_marker}\`"
            fi
            if [[ -n "${net_udp_dns_host_marker}" ]]; then
              echo "- Host virtio-net-udp-dns marker: \`${net_udp_dns_host_marker}\`"
            fi
            if [[ -n "${net_offload_csum_host_marker}" ]]; then
              echo "- Host virtio-net-offload-csum marker: \`${net_offload_csum_host_marker}\`"
            fi
            if [[ -n "${net_diag_host_marker}" ]]; then
              echo "- Host virtio-net-diag marker: \`${net_diag_host_marker}\`"
            fi
            if [[ -n "${snd_host_marker}" ]]; then
              echo "- Host virtio-snd marker: \`${snd_host_marker}\`"
            fi
            if [[ -n "${snd_capture_host_marker}" ]]; then
              echo "- Host virtio-snd-capture marker: \`${snd_capture_host_marker}\`"
            fi
            if [[ -n "${snd_duplex_host_marker}" ]]; then
              echo "- Host virtio-snd-duplex marker: \`${snd_duplex_host_marker}\`"
            fi
            if [[ -n "${snd_buffer_limits_host_marker}" ]]; then
              echo "- Host virtio-snd-buffer-limits marker: \`${snd_buffer_limits_host_marker}\`"
            fi
            if [[ -n "${snd_format_host_marker}" ]]; then
              echo "- Host virtio-snd-format marker: \`${snd_format_host_marker}\`"
            fi
            if [[ -n "${snd_eventq_host_marker}" ]]; then
              echo "- Host virtio-snd-eventq marker: \`${snd_eventq_host_marker}\`"
            fi
            if [[ -n "${snd_marker}" ]]; then
              echo "- Guest virtio-snd marker: \`${snd_marker}\`"
            fi
            if [[ -n "${snd_marker_line}" ]]; then
              echo "- Guest virtio-snd marker line: \`${snd_marker_line}\`"
            fi
            if [[ -n "${snd_msix_marker_line}" ]]; then
              echo "- Guest virtio-snd-msix marker line: \`${snd_msix_marker_line}\`"
            fi
            if [[ -n "${input_events_marker}" ]]; then
              echo "- Guest virtio-input-events marker: \`${input_events_marker}\`"
            fi
            if [[ -n "${input_events_marker_line}" ]]; then
              echo "- Guest virtio-input-events marker line: \`${input_events_marker_line}\`"
            fi
            if [[ -n "${input_wheel_marker}" ]]; then
              echo "- Guest virtio-input-wheel marker: \`${input_wheel_marker}\`"
            fi
            if [[ -n "${input_wheel_marker_line}" ]]; then
              echo "- Guest virtio-input-wheel marker line: \`${input_wheel_marker_line}\`"
            fi
            if [[ -n "${input_media_keys_marker}" ]]; then
              echo "- Guest virtio-input-media-keys marker: \`${input_media_keys_marker}\`"
            fi
            if [[ -n "${input_media_keys_marker_line}" ]]; then
              echo "- Guest virtio-input-media-keys marker line: \`${input_media_keys_marker_line}\`"
            fi
            if [[ -n "${input_binding_host_marker}" ]]; then
              echo "- Host virtio-input binding marker: \`${input_binding_host_marker}\`"
            fi
            if [[ -n "${input_bind_host_marker}" ]]; then
              echo "- Host virtio-input bind marker: \`${input_bind_host_marker}\`"
            fi
            if [[ -n "${input_msix_marker_line}" ]]; then
              echo "- Guest virtio-input-msix marker line: \`${input_msix_marker_line}\`"
            fi
            if [[ -n "${input_led_marker}" ]]; then
              echo "- Guest virtio-input-led marker: \`${input_led_marker}\`"
            fi
            if [[ -n "${input_leds_marker}" ]]; then
              echo "- Guest virtio-input-leds marker: \`${input_leds_marker}\`"
            fi
            if [[ -n "${input_events_modifiers_marker}" ]]; then
              echo "- Guest virtio-input-events-modifiers marker: \`${input_events_modifiers_marker}\`"
            fi
            if [[ -n "${input_events_modifiers_marker_line}" ]]; then
              echo "- Guest virtio-input-events-modifiers marker line: \`${input_events_modifiers_marker_line}\`"
            fi
            if [[ -n "${input_events_buttons_marker}" ]]; then
              echo "- Guest virtio-input-events-buttons marker: \`${input_events_buttons_marker}\`"
            fi
            if [[ -n "${input_events_buttons_marker_line}" ]]; then
              echo "- Guest virtio-input-events-buttons marker line: \`${input_events_buttons_marker_line}\`"
            fi
            if [[ -n "${input_events_wheel_marker}" ]]; then
              echo "- Guest virtio-input-events-wheel marker: \`${input_events_wheel_marker}\`"
            fi
            if [[ -n "${input_events_wheel_marker_line}" ]]; then
              echo "- Guest virtio-input-events-wheel marker line: \`${input_events_wheel_marker_line}\`"
            fi
            if [[ -n "${input_inject_marker}" ]]; then
              echo "- Host virtio-input injection marker: \`${input_inject_marker}\`"
            fi
            if [[ -n "${input_media_keys_inject_marker}" ]]; then
              echo "- Host virtio-input media keys injection marker: \`${input_media_keys_inject_marker}\`"
            fi
            if [[ -n "${input_tablet_marker}" ]]; then
              echo "- Guest virtio-input-tablet-events marker: \`${input_tablet_marker}\`"
            fi
            if [[ -n "${input_tablet_marker_line}" ]]; then
              echo "- Guest virtio-input-tablet-events marker line: \`${input_tablet_marker_line}\`"
            fi
            if [[ -n "${input_tablet_inject_marker}" ]]; then
              echo "- Host virtio-input tablet injection marker: \`${input_tablet_inject_marker}\`"
            fi
            if [[ -n "${pci_preflight_marker}" ]]; then
              echo "- Host QEMU PCI preflight marker: \`${pci_preflight_marker}\`"
            fi
            if [[ -n "${snd_capture_marker}" ]]; then
              echo "- Guest virtio-snd-capture marker: \`${snd_capture_marker}\`"
            fi
            if [[ -n "${snd_capture_marker_line}" ]]; then
              echo "- Guest virtio-snd-capture marker line: \`${snd_capture_marker_line}\`"
            fi
            if [[ -n "${snd_duplex_marker}" ]]; then
              echo "- Guest virtio-snd-duplex marker: \`${snd_duplex_marker}\`"
            fi
            if [[ -n "${snd_duplex_marker_line}" ]]; then
              echo "- Guest virtio-snd-duplex marker line: \`${snd_duplex_marker_line}\`"
            fi
            if [[ -n "${snd_buffer_limits_marker}" ]]; then
              echo "- Guest virtio-snd-buffer-limits marker: \`${snd_buffer_limits_marker}\`"
            fi
            if [[ -n "${snd_buffer_limits_marker_line}" ]]; then
              echo "- Guest virtio-snd-buffer-limits marker line: \`${snd_buffer_limits_marker_line}\`"
            fi
            if [[ -n "${wav_marker}" ]]; then
              echo "- Host wav marker: \`${wav_marker}\`"
            fi
            if [[ "${{ steps.harness.outcome }}" != "success" ]]; then
              if [[ -f "${harness_log}" ]]; then
                echo ""
                echo "<details><summary>harness.log (tail)</summary>"
                echo ""
                echo '```'
                tail -n 200 "${harness_log}" | tr -d '\r'
                echo '```'
                echo "</details>"
              fi
              if [[ -f "${serial_log}" ]]; then
                echo ""
                echo "<details><summary>serial.log (tail)</summary>"
                echo ""
                echo '```'
                tail -n 200 "${serial_log}" | tr -d '\r'
                echo '```'
                echo "</details>"
              fi
              if [[ -f "${http_log}" ]]; then
                echo ""
                echo "<details><summary>http.log (tail)</summary>"
                echo ""
                echo '```'
                tail -n 200 "${http_log}" | tr -d '\r'
                echo '```'
                echo "</details>"
              fi
              echo ""
              echo "<details><summary>qemu.stderr.log (tail)</summary>"
              echo ""
              echo '```'
              if [[ -f "${qemu_stderr_log}" ]]; then
                if [[ -s "${qemu_stderr_log}" ]]; then
                  tail -n 200 "${qemu_stderr_log}" | tr -d '\r'
                else
                  echo "(qemu stderr log was empty)"
                fi
              else
                echo "(qemu stderr log was not produced)"
              fi
              echo '```'
              echo "</details>"
            fi
            echo "- Logs artifact: win7-virtio-harness-logs"
            echo "- Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          } >>"$GITHUB_STEP_SUMMARY"
