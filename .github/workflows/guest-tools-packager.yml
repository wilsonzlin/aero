name: guest-tools-packager

on:
  push:
    branches: [main]
    paths:
      - "tools/packaging/**"
      - "tools/packaging/specs/**"
      - "tools/guest-tools/**"
      - "guest-tools/**"
      - "drivers/scripts/make-guest-tools-from-aero-virtio.ps1"
      - "drivers/scripts/make-guest-tools-from-ci.ps1"
      - "drivers/scripts/make-guest-tools-from-virtio-win.ps1"
      - "drivers/scripts/make-guest-tools-from-virtio-win.sh"
      - "ci/package-guest-tools.ps1"
      - "docs/windows-device-contract.json"
      - "docs/windows-device-contract-virtio-win.json"
      - ".github/workflows/guest-tools-packager.yml"
  pull_request:
    paths:
      - "tools/packaging/**"
      - "tools/packaging/specs/**"
      - "tools/guest-tools/**"
      - "guest-tools/**"
      - "drivers/scripts/make-guest-tools-from-aero-virtio.ps1"
      - "drivers/scripts/make-guest-tools-from-ci.ps1"
      - "drivers/scripts/make-guest-tools-from-virtio-win.ps1"
      - "drivers/scripts/make-guest-tools-from-virtio-win.sh"
      - "ci/package-guest-tools.ps1"
      - "docs/windows-device-contract.json"
      - "docs/windows-device-contract-virtio-win.json"
      - ".github/workflows/guest-tools-packager.yml"
  merge_group:
    paths:
      - "tools/packaging/**"
      - "tools/packaging/specs/**"
      - "tools/guest-tools/**"
      - "guest-tools/**"
      - "drivers/scripts/make-guest-tools-from-aero-virtio.ps1"
      - "drivers/scripts/make-guest-tools-from-ci.ps1"
      - "drivers/scripts/make-guest-tools-from-virtio-win.ps1"
      - "drivers/scripts/make-guest-tools-from-virtio-win.sh"
      - "ci/package-guest-tools.ps1"
      - "docs/windows-device-contract.json"
      - "docs/windows-device-contract-virtio-win.json"
      - ".github/workflows/guest-tools-packager.yml"
  workflow_dispatch:

concurrency:
  group: guest-tools-packager-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: "1"

jobs:
  test:
    name: Packager + config validation (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - windows-latest

    env:
      # `aero_packager` is a standalone workspace under tools/. Use a stable target
      # directory so CI caching behaves consistently across OSes.
      CARGO_TARGET_DIR: ${{ github.workspace }}/target

    steps:
      - uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Rust
        id: setup-rust
        uses: ./.github/actions/setup-rust
        with:
          toolchain: stable
          # Always require lockfiles to be honoured in CI (avoid silently updating
          # dependencies during `cargo test`).
          locked: always

      - name: cargo test (tools/packaging/aero_packager)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p out/guest-tools-packager
          cargo test ${{ steps.setup-rust.outputs.cargo_locked_flag }} --manifest-path tools/packaging/aero_packager/Cargo.toml 2>&1 | tee out/guest-tools-packager/cargo-test.log

      - name: Smoke package real guest-tools/ directory (using dummy driver fixtures)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p out/guest-tools-packager
          rm -rf out/guest-tools-packager/smoke
          cargo run ${{ steps.setup-rust.outputs.cargo_locked_flag }} --manifest-path tools/packaging/aero_packager/Cargo.toml -- \
            --drivers-dir tools/packaging/aero_packager/testdata/drivers \
            --guest-tools-dir guest-tools \
            --spec tools/packaging/aero_packager/testdata/spec-smoke-real-guest-tools.json \
            --out-dir out/guest-tools-packager/smoke \
            --version 0.0.0 \
            --build-id ci \
            --source-date-epoch 0 2>&1 | tee out/guest-tools-packager/package-smoke.log

      - name: Validate Guest Tools config vs packaging spec
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p out/guest-tools-packager
          python tools/guest-tools/validate_config.py --spec tools/packaging/specs/win7-signed.json 2>&1 | tee out/guest-tools-packager/validate-config-win7-signed.log
          python tools/guest-tools/validate_config.py --spec tools/packaging/specs/win7-virtio-win.json 2>&1 | tee out/guest-tools-packager/validate-config-win7-virtio-win.log
          python tools/guest-tools/validate_config.py --spec tools/packaging/specs/win7-virtio-full.json 2>&1 | tee out/guest-tools-packager/validate-config-win7-virtio-full.log
          python tools/guest-tools/validate_config.py --spec tools/packaging/specs/win7-aero-guest-tools.json 2>&1 | tee out/guest-tools-packager/validate-config-win7-aero-guest-tools.log
          python tools/guest-tools/validate_config.py --spec tools/packaging/specs/win7-aero-virtio.json 2>&1 | tee out/guest-tools-packager/validate-config-win7-aero-virtio.log
          python tools/guest-tools/validate_config.py --spec tools/packaging/specs/win7-aerogpu-only.json 2>&1 | tee out/guest-tools-packager/validate-config-win7-aerogpu-only.log

      - name: Python unit tests (tools/guest-tools)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p out/guest-tools-packager
          python tools/guest-tools/lint_guest_tools_scripts.py 2>&1 | tee out/guest-tools-packager/lint-guest-tools-scripts.log
          python -m unittest discover -s tools/guest-tools/tests -p 'test_*.py' 2>&1 | tee out/guest-tools-packager/python-unittest-guest-tools.log

      - name: Validate make-guest-tools-from-ci.ps1 signing-policy surface
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          function Assert-SigningPolicyAccepted {
            param([Parameter(Mandatory = $true)][string]$Policy)

            $out = & pwsh -NoProfile -ExecutionPolicy Bypass -File 'drivers/scripts/make-guest-tools-from-ci.ps1' `
              -PackagesRoot 'out/does-not-exist' `
              -SigningPolicy $Policy 2>&1

            $exit = $LASTEXITCODE
            $text = $out | Out-String

            if ($exit -eq 0) {
              throw "Expected wrapper to fail (missing InputRoot), but it succeeded for SigningPolicy=$Policy."
            }

            if ($text -notmatch 'InputRoot does not exist') {
              throw "Expected wrapper to reach ci/package-guest-tools.ps1 and fail with missing InputRoot for SigningPolicy=$Policy. Output:`n$text"
            }
          }

          # Canonical values:
          Assert-SigningPolicyAccepted -Policy 'test'
          Assert-SigningPolicyAccepted -Policy 'production'
          Assert-SigningPolicyAccepted -Policy 'none'

          # Legacy aliases (for back-compat):
          Assert-SigningPolicyAccepted -Policy 'testsigning'
          Assert-SigningPolicyAccepted -Policy 'test-signing'
          Assert-SigningPolicyAccepted -Policy 'prod'
          Assert-SigningPolicyAccepted -Policy 'whql'
          Assert-SigningPolicyAccepted -Policy 'nointegritychecks'
          Assert-SigningPolicyAccepted -Policy 'no-integrity-checks'

      - name: Smoke-test CI wrapper (ci/package-guest-tools.ps1)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          New-Item -ItemType Directory -Force -Path 'out/guest-tools-packager/wrapper' | Out-Null

          pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci/package-guest-tools.ps1' `
            -InputRoot 'tools/packaging/aero_packager/testdata/drivers' `
            -GuestToolsDir 'tools/packaging/aero_packager/testdata/guest-tools' `
            -CertPath 'tools/packaging/aero_packager/testdata/guest-tools/certs/test.cer' `
            -SpecPath 'tools/packaging/aero_packager/testdata/spec.json' `
            -OutDir 'out/guest-tools-packager/wrapper' `
            -Version '0.0.0' `
            -BuildId 'ci' `
            -SourceDateEpoch 0

          foreach ($p in @(
            'out/guest-tools-packager/wrapper/aero-guest-tools.iso',
            'out/guest-tools-packager/wrapper/aero-guest-tools.zip',
            'out/guest-tools-packager/wrapper/manifest.json',
            'out/guest-tools-packager/wrapper/aero-guest-tools.manifest.json'
          )) {
            if (!(Test-Path -LiteralPath $p)) {
              throw "Missing expected wrapper output: $p"
            }
          }

      - name: Smoke-test convenience wrapper (drivers/scripts/make-guest-tools-from-ci.ps1)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          foreach ($case in @(
            @{ OutDir = 'out/guest-tools-packager/make-from-ci-test'; SigningPolicy = 'test' },
            @{ OutDir = 'out/guest-tools-packager/make-from-ci-testsigning'; SigningPolicy = 'testsigning' }
          )) {
            New-Item -ItemType Directory -Force -Path $case.OutDir | Out-Null

            pwsh -NoProfile -ExecutionPolicy Bypass -File 'drivers/scripts/make-guest-tools-from-ci.ps1' `
              -PackagesRoot 'tools/packaging/aero_packager/testdata/drivers' `
              -GuestToolsDir 'tools/packaging/aero_packager/testdata/guest-tools' `
              -SigningPolicy $case.SigningPolicy `
              -CertPath 'tools/packaging/aero_packager/testdata/guest-tools/certs/test.cer' `
              -SpecPath 'tools/packaging/aero_packager/testdata/spec.json' `
              -OutDir $case.OutDir `
              -Version '0.0.0' `
              -BuildId 'ci' `
              -SourceDateEpoch 0

            foreach ($p in @(
              (Join-Path $case.OutDir 'aero-guest-tools.iso'),
              (Join-Path $case.OutDir 'aero-guest-tools.zip'),
              (Join-Path $case.OutDir 'manifest.json')
            )) {
              if (!(Test-Path -LiteralPath $p)) {
                throw "Missing expected wrapper output: $p"
              }
            }
          }

      - name: Smoke-test aero-virtio Guest Tools wrapper (drivers/scripts/make-guest-tools-from-aero-virtio.ps1)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          New-Item -ItemType Directory -Force -Path 'out/guest-tools-packager/aero-virtio-script' | Out-Null
 
          pwsh -NoProfile -ExecutionPolicy Bypass -File 'drivers/scripts/make-guest-tools-from-aero-virtio.ps1' `
            -DriverOutDir 'tools/packaging/aero_packager/testdata/drivers-aero-virtio' `
            -GuestToolsDir 'guest-tools' `
            -OutDir 'out/guest-tools-packager/aero-virtio-script' `
            -Version '0.0.0' `
            -BuildId 'ci'
 
          foreach ($p in @(
            'out/guest-tools-packager/aero-virtio-script/aero-guest-tools.iso',
            'out/guest-tools-packager/aero-virtio-script/aero-guest-tools.zip',
            'out/guest-tools-packager/aero-virtio-script/manifest.json'
          )) {
            if (!(Test-Path -LiteralPath $p)) {
              throw "Missing expected aero-virtio wrapper output: $p"
            }
          }

      - name: Smoke-test aero-virtio wrapper fails when aero drivers are missing
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
 
          $out = & pwsh -NoProfile -ExecutionPolicy Bypass -File 'drivers/scripts/make-guest-tools-from-aero-virtio.ps1' `
            -DriverOutDir 'tools/packaging/aero_packager/testdata/drivers' `
            -GuestToolsDir 'guest-tools' `
            -OutDir 'out/guest-tools-packager/aero-virtio-missing' `
            -Version '0.0.0' `
            -BuildId 'ci' 2>&1
 
          $exit = $LASTEXITCODE
          $text = $out | Out-String
 
          if ($exit -eq 0) {
            throw "Expected wrapper to fail when aerovblk/aerovnet are missing, but it succeeded."
          }
 
          if ($text -notmatch 'aerovblk' -or $text -notmatch 'missing') {
            throw "Unexpected error output from wrapper. Expected it to mention missing aerovblk. Output:`n$text"
          }
 
          Write-Host "Got expected failure (exit $exit)."

      - name: Upload logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: guest-tools-packager-logs-${{ matrix.os }}
          path: out/guest-tools-packager/*.log
          if-no-files-found: ignore
          retention-days: 7
