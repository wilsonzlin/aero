name: Perf (smoke)

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths-ignore:
      - "docs/**"
      - "**/*.md"

permissions:
  contents: read

concurrency:
  group: perf-smoke-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  perf-smoke:
    permissions:
      contents: read
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    env:
      NODE_VERSION: "20.11.1"
      PERF_ITERATIONS: "3"
      PERF_REGRESSION_THRESHOLD_PCT: "15"
      PERF_EXTREME_CV_THRESHOLD: "0.5"
      AERO_NODE_DIR: ${{ vars.AERO_NODE_DIR }}
      AERO_REQUIRE_WEBGPU: "0"
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"
    steps:
      - name: Checkout (candidate)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          path: head

      - name: Checkout (baseline)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: ${{ github.event.pull_request.base.sha }}
          path: base

      - name: Determine Node workspace directory (candidate)
        id: node-dir-head
        run: |
          set -euo pipefail

          if [[ -n "${AERO_NODE_DIR:-}" ]]; then
            dir="$AERO_NODE_DIR"
          elif [[ -f head/package.json ]]; then
            dir="."
          elif [[ -f head/frontend/package.json ]]; then
            dir="frontend"
          elif [[ -f head/web/package.json ]]; then
            dir="web"
          else
            echo "package.json not found in candidate checkout. Set AERO_NODE_DIR to the directory containing package.json." >&2
            exit 1
          fi

          lockfile="$dir/package-lock.json"
          if [[ "$dir" == "." ]]; then
            lockfile="package-lock.json"
            full_dir="head"
          else
            full_dir="head/$dir"
          fi
          full_lockfile="head/$lockfile"

          if [[ ! -f "$full_lockfile" ]]; then
            echo "package-lock.json not found at '$full_lockfile'. This workflow expects npm; ensure a lockfile exists." >&2
            exit 1
          fi

          echo "dir=$full_dir" >> "$GITHUB_OUTPUT"
          echo "lockfile=$full_lockfile" >> "$GITHUB_OUTPUT"

      - name: Determine Node workspace directory (baseline)
        id: node-dir-base
        run: |
          set -euo pipefail

          if [[ -n "${AERO_NODE_DIR:-}" ]]; then
            dir="$AERO_NODE_DIR"
          elif [[ -f base/package.json ]]; then
            dir="."
          elif [[ -f base/frontend/package.json ]]; then
            dir="frontend"
          elif [[ -f base/web/package.json ]]; then
            dir="web"
          else
            echo "package.json not found in baseline checkout. Set AERO_NODE_DIR to the directory containing package.json." >&2
            exit 1
          fi

          lockfile="$dir/package-lock.json"
          if [[ "$dir" == "." ]]; then
            lockfile="package-lock.json"
            full_dir="base"
          else
            full_dir="base/$dir"
          fi
          full_lockfile="base/$lockfile"

          if [[ ! -f "$full_lockfile" ]]; then
            echo "package-lock.json not found at '$full_lockfile'. This workflow expects npm; ensure a lockfile exists." >&2
            exit 1
          fi

          echo "dir=$full_dir" >> "$GITHUB_OUTPUT"
          echo "lockfile=$full_lockfile" >> "$GITHUB_OUTPUT"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: |
            head/tools/perf/package-lock.json
            ${{ steps.node-dir-head.outputs.lockfile }}
            ${{ steps.node-dir-base.outputs.lockfile }}

      - name: Install perf tool dependencies
        run: npm ci
        working-directory: head/tools/perf

      - name: Setup Playwright (cached)
        uses: ./.github/actions/setup-playwright
        with:
          browsers: chromium
          working-directory: head/tools/perf
          lockfile: head/tools/perf/package-lock.json

      - name: Install app dependencies (baseline)
        run: npm ci
        working-directory: ${{ steps.node-dir-base.outputs.dir }}

      - name: Build app (baseline)
        run: npm run build
        working-directory: ${{ steps.node-dir-base.outputs.dir }}

      - name: Run perf smoke (baseline)
        working-directory: ${{ steps.node-dir-base.outputs.dir }}
        run: |
          set -euo pipefail
          PORT=4173
          setsid npm run preview -- --host 127.0.0.1 --port "$PORT" --strictPort &
          server_pid=$!
          cleanup() {
            kill -- "-$server_pid" || true
            sleep 1
            kill -9 -- "-$server_pid" || true
            wait "$server_pid" || true
          }
          trap cleanup EXIT

          for i in {1..60}; do
            curl -fsS "http://127.0.0.1:$PORT/" >/dev/null && break
            sleep 1
          done
          curl -fsS "http://127.0.0.1:$PORT/" >/dev/null

          node "$GITHUB_WORKSPACE/head/tools/perf/run.mjs" \
            --url "http://127.0.0.1:$PORT/" \
            --out-dir "$GITHUB_WORKSPACE/head/perf-results/base" \
            --iterations ${{ env.PERF_ITERATIONS }}

      - name: Install app dependencies (candidate)
        run: npm ci
        working-directory: ${{ steps.node-dir-head.outputs.dir }}

      - name: Build app (candidate)
        run: npm run build
        working-directory: ${{ steps.node-dir-head.outputs.dir }}

      - name: Run perf smoke (candidate)
        working-directory: ${{ steps.node-dir-head.outputs.dir }}
        run: |
          set -euo pipefail
          PORT=4174
          setsid npm run preview -- --host 127.0.0.1 --port "$PORT" --strictPort &
          server_pid=$!
          cleanup() {
            kill -- "-$server_pid" || true
            sleep 1
            kill -9 -- "-$server_pid" || true
            wait "$server_pid" || true
          }
          trap cleanup EXIT

          for i in {1..60}; do
            curl -fsS "http://127.0.0.1:$PORT/" >/dev/null && break
            sleep 1
          done
          curl -fsS "http://127.0.0.1:$PORT/" >/dev/null

          node "$GITHUB_WORKSPACE/head/tools/perf/run.mjs" \
            --url "http://127.0.0.1:$PORT/" \
            --out-dir "$GITHUB_WORKSPACE/head/perf-results/head" \
            --iterations ${{ env.PERF_ITERATIONS }}

      - name: Compare (fail on regression)
        run: |
          node tools/perf/compare.mjs \
            --baseline perf-results/base/summary.json \
            --candidate perf-results/head/summary.json \
            --out-dir perf-results \
            --regression-threshold-pct ${{ env.PERF_REGRESSION_THRESHOLD_PCT }} \
            --extreme-cv-threshold ${{ env.PERF_EXTREME_CV_THRESHOLD }}
        working-directory: head

      - name: Job summary
        if: always()
        working-directory: head
        run: |
          if [[ -f perf-results/compare.md ]]; then
            cat perf-results/compare.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No perf comparison produced (compare.md missing)." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload perf artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-smoke-${{ github.run_id }}
          path: head/perf-results
          if-no-files-found: error
          retention-days: 14

  perf-comment:
    name: PR comment (perf smoke)
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    needs: [perf-smoke]
    if: always() && github.event.pull_request.head.repo.full_name == github.repository
    permissions:
      actions: read
      contents: read
      issues: write
    steps:
      - name: Download perf artifacts
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: perf-smoke-${{ github.run_id }}
          path: perf-results

      - name: Comment on PR (summary)
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("node:fs");
            const path = require("node:path");

            const summaryPath = path.join(process.env.GITHUB_WORKSPACE, "perf-results", "summary.json");
            if (!fs.existsSync(summaryPath)) {
              core.warning(`Perf summary not found at ${summaryPath}; skipping PR comment.`);
              return;
            }

            const summary = JSON.parse(fs.readFileSync(summaryPath, "utf8"));
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;

            const fmtPct = (pct) => `${pct > 0 ? "+" : ""}${(pct * 100).toFixed(1)}%`;
            const fmtMs = (ms) => `${ms > 0 ? "+" : ""}${ms.toFixed(1)}ms`;

            const lines = [];
            lines.push("<!-- aero-perf-smoke -->");
            lines.push("### Perf (smoke)");
            lines.push("");
            lines.push(`Report + artifacts: ${runUrl}`);
            lines.push("");
            lines.push(`Baseline: \`${summary.baseline?.gitSha ?? "unknown"}\``);
            lines.push(`Candidate: \`${summary.candidate?.gitSha ?? "unknown"}\``);
            lines.push(`Threshold: ${summary.regressionThresholdPct}% regression (median-of-${summary.iterations ?? "?"})`);

            if (summary.status === "unstable") {
              lines.push("");
              lines.push("Result: **Unstable** (extreme variance detected; see artifacts for raw samples)");
            } else if (summary.status === "fail") {
              lines.push("");
              lines.push("Result: **Regression**");
            } else if (summary.status === "pass") {
              lines.push("");
              lines.push("Result: **No significant regressions**");
            }

            const bullets = [];
            const take = (arr) => (Array.isArray(arr) ? arr.slice(0, 5) : []);
            for (const r of take(summary.topRegressions)) {
              bullets.push(`- \`${r.name}\`: ${fmtPct(r.pct)} (${fmtMs(r.deltaMs)})`);
            }
            if (bullets.length) {
              lines.push("");
              lines.push("Top regressions:");
              lines.push(...bullets);
            }

            const improvements = [];
            for (const r of take(summary.topImprovements)) {
              improvements.push(`- \`${r.name}\`: ${fmtPct(r.pct)} (${fmtMs(r.deltaMs)})`);
            }
            if (improvements.length) {
              lines.push("");
              lines.push("Top improvements:");
              lines.push(...improvements);
            }

            const body = lines.join("\n");

            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;

            const existing = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
              per_page: 100,
            });

            const marker = "<!-- aero-perf-smoke -->";
            const botLogin = "github-actions[bot]";
            const previous = existing.find(
              (c) => c.user?.login === botLogin && typeof c.body === "string" && c.body.includes(marker),
            );

            if (previous) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: previous.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            }
