name: virtio-driver-iso

on:
  push:
    paths-ignore:
      - "docs/**"
      - "**/*.md"
  pull_request:
    paths-ignore:
      - "docs/**"
      - "**/*.md"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ISO tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y xorriso p7zip-full
          python3 -m pip install pycdlib

      - name: Build sample virtio drivers ISO (deterministic, Rust backend)
        run: |
          python3 tools/driver-iso/build.py \
            --backend rust \
            --source-date-epoch 0 \
            --drivers-root drivers/virtio/sample \
            --output dist/aero-virtio-win7-drivers-sample.iso \
            --include-manifest

      - name: Determinism self-test (build ISO twice, compare SHA256)
        run: |
          python3 tools/driver-iso/build.py \
            --backend rust \
            --source-date-epoch 0 \
            --drivers-root drivers/virtio/sample \
            --output dist/aero-virtio-win7-drivers-sample-2.iso \
            --include-manifest
          h1="$(sha256sum dist/aero-virtio-win7-drivers-sample.iso | awk '{print $1}')"
          h2="$(sha256sum dist/aero-virtio-win7-drivers-sample-2.iso | awk '{print $1}')"
          echo "sha256 run1: $h1"
          echo "sha256 run2: $h2"
          test "$h1" = "$h2"

      - name: Verify ISO contents
        run: |
          python3 tools/driver-iso/verify_iso.py \
            --require-arch both \
            --iso dist/aero-virtio-win7-drivers-sample.iso

      - name: Smoke test virtio-win extractor (synthetic ISO)
        run: |
          python3 tools/virtio-win/tests/test_extract.py

      - name: Smoke test make-driver-pack.sh (pwsh on Linux, synthetic ISO)
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v pwsh >/dev/null 2>&1; then
            echo "pwsh not found on PATH; skipping make-driver-pack.sh smoke test."
            exit 0
          fi
          tmp="$(mktemp -d)"
          stage="$tmp/iso-root"
          mkdir -p "$stage/viostor/w7/amd64" "$stage/viostor/w7/x86" "$stage/NetKVM/w7/amd64" "$stage/NetKVM/w7/x86"
          echo "viostor amd64" > "$stage/viostor/w7/amd64/viostor.inf"
          echo "viostor x86" > "$stage/viostor/w7/x86/viostor.inf"
          echo "netkvm amd64" > "$stage/NetKVM/w7/amd64/netkvm.inf"
          echo "netkvm x86" > "$stage/NetKVM/w7/x86/netkvm.inf"
          echo "license" > "$stage/LICENSE"
          echo "1.2.3" > "$stage/VERSION"
          xorriso -as mkisofs -iso-level 3 -J -R -V VIRTIOWIN_TEST -o "$tmp/virtio-win.iso" "$stage"
          drivers/scripts/make-driver-pack.sh --virtio-win-iso "$tmp/virtio-win.iso" --out-dir "$tmp/out" -- --NoZip
          test -f "$tmp/out/aero-win7-driver-pack/manifest.json"

      - name: Smoke test make-driver-pack.ps1 -VirtioWinIso on Linux (auto-extract fallback)
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v pwsh >/dev/null 2>&1; then
            echo "pwsh not found on PATH; skipping make-driver-pack.ps1 -VirtioWinIso smoke test."
            exit 0
          fi
          tmp="$(mktemp -d)"
          stage="$tmp/iso-root"
          mkdir -p "$stage/viostor/w7/amd64" "$stage/viostor/w7/x86" "$stage/NetKVM/w7/amd64" "$stage/NetKVM/w7/x86"
          echo "viostor amd64" > "$stage/viostor/w7/amd64/viostor.inf"
          echo "viostor x86" > "$stage/viostor/w7/x86/viostor.inf"
          echo "netkvm amd64" > "$stage/NetKVM/w7/amd64/netkvm.inf"
          echo "netkvm x86" > "$stage/NetKVM/w7/x86/netkvm.inf"
          echo "license" > "$stage/LICENSE"
          echo "1.2.3" > "$stage/VERSION"
          xorriso -as mkisofs -iso-level 3 -J -R -V VIRTIOWIN_TEST -o "$tmp/virtio-win.iso" "$stage"
          pwsh -NoProfile -ExecutionPolicy Bypass -File drivers/scripts/make-driver-pack.ps1 \
            -VirtioWinIso "$tmp/virtio-win.iso" \
            -OutDir "$tmp/out" \
            -NoZip \
            -Drivers viostor netkvm
          test -f "$tmp/out/aero-win7-driver-pack/manifest.json"

      - name: Smoke test make-virtio-driver-iso.sh (pwsh on Linux, synthetic ISO)
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v pwsh >/dev/null 2>&1; then
            echo "pwsh not found on PATH; skipping make-virtio-driver-iso.sh smoke test."
            exit 0
          fi
          tmp="$(mktemp -d)"
          stage="$tmp/iso-root"
          mkdir -p "$stage/viostor/w7/amd64" "$stage/viostor/w7/x86" "$stage/NetKVM/w7/amd64" "$stage/NetKVM/w7/x86"
          echo "viostor amd64" > "$stage/viostor/w7/amd64/viostor.inf"
          echo "viostor x86" > "$stage/viostor/w7/x86/viostor.inf"
          echo "netkvm amd64" > "$stage/NetKVM/w7/amd64/netkvm.inf"
          echo "netkvm x86" > "$stage/NetKVM/w7/x86/netkvm.inf"
          echo "license" > "$stage/LICENSE"
          echo "1.2.3" > "$stage/VERSION"
          xorriso -as mkisofs -iso-level 3 -J -R -V VIRTIOWIN_TEST -o "$tmp/virtio-win.iso" "$stage"
          drivers/scripts/make-virtio-driver-iso.sh --virtio-win-iso "$tmp/virtio-win.iso" --out-iso "$tmp/aero-virtio.iso"
          test -f "$tmp/aero-virtio.iso"
          python3 tools/driver-iso/verify_iso.py --require-arch both --iso "$tmp/aero-virtio.iso"

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v6
        with:
          name: aero-virtio-win7-drivers-sample-iso
          path: dist/aero-virtio-win7-drivers-sample.iso
