name: virtio-driver-iso

on:
  push:
    paths-ignore:
      - "docs/**"
      - "**/*.md"
  pull_request:
    paths-ignore:
      - "docs/**"
      - "**/*.md"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ISO tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y xorriso p7zip-full

      - name: Build sample virtio drivers ISO
        run: |
          python3 tools/driver-iso/build.py \
            --drivers-root drivers/virtio/sample \
            --output dist/aero-virtio-win7-drivers-sample.iso \
            --include-manifest

      - name: Verify ISO contents
        run: |
          python3 tools/driver-iso/verify_iso.py \
            --require-arch both \
            --iso dist/aero-virtio-win7-drivers-sample.iso

      - name: Smoke test virtio-win extractor (synthetic ISO)
        run: |
          python3 tools/virtio-win/tests/test_extract.py

      - name: Smoke test make-driver-pack.sh (pwsh on Linux, synthetic ISO)
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v pwsh >/dev/null 2>&1; then
            echo "pwsh not found on PATH; skipping make-driver-pack.sh smoke test."
            exit 0
          fi
          tmp="$(mktemp -d)"
          stage="$tmp/iso-root"
          mkdir -p "$stage/viostor/w7/amd64" "$stage/viostor/w7/x86" "$stage/NetKVM/w7/amd64" "$stage/NetKVM/w7/x86"
          echo "viostor amd64" > "$stage/viostor/w7/amd64/viostor.inf"
          echo "viostor x86" > "$stage/viostor/w7/x86/viostor.inf"
          echo "netkvm amd64" > "$stage/NetKVM/w7/amd64/netkvm.inf"
          echo "netkvm x86" > "$stage/NetKVM/w7/x86/netkvm.inf"
          echo "license" > "$stage/LICENSE"
          echo "1.2.3" > "$stage/VERSION"
          xorriso -as mkisofs -iso-level 3 -J -R -V VIRTIOWIN_TEST -o "$tmp/virtio-win.iso" "$stage"
          drivers/scripts/make-driver-pack.sh --virtio-win-iso "$tmp/virtio-win.iso" --out-dir "$tmp/out" -- --NoZip
          test -f "$tmp/out/aero-win7-driver-pack/manifest.json"

      - name: Smoke test make-virtio-driver-iso.sh (pwsh on Linux, synthetic ISO)
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v pwsh >/dev/null 2>&1; then
            echo "pwsh not found on PATH; skipping make-virtio-driver-iso.sh smoke test."
            exit 0
          fi
          tmp="$(mktemp -d)"
          stage="$tmp/iso-root"
          mkdir -p "$stage/viostor/w7/amd64" "$stage/viostor/w7/x86" "$stage/NetKVM/w7/amd64" "$stage/NetKVM/w7/x86"
          echo "viostor amd64" > "$stage/viostor/w7/amd64/viostor.inf"
          echo "viostor x86" > "$stage/viostor/w7/x86/viostor.inf"
          echo "netkvm amd64" > "$stage/NetKVM/w7/amd64/netkvm.inf"
          echo "netkvm x86" > "$stage/NetKVM/w7/x86/netkvm.inf"
          echo "license" > "$stage/LICENSE"
          echo "1.2.3" > "$stage/VERSION"
          xorriso -as mkisofs -iso-level 3 -J -R -V VIRTIOWIN_TEST -o "$tmp/virtio-win.iso" "$stage"
          drivers/scripts/make-virtio-driver-iso.sh --virtio-win-iso "$tmp/virtio-win.iso" --out-iso "$tmp/aero-virtio.iso"
          test -f "$tmp/aero-virtio.iso"
          python3 tools/driver-iso/verify_iso.py --require-arch both --iso "$tmp/aero-virtio.iso"

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: aero-virtio-win7-drivers-sample-iso
          path: dist/aero-virtio-win7-drivers-sample.iso
