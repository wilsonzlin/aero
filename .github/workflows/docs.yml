name: Docs

on:
  pull_request:
    paths:
      - "docs/**"
      - "instructions/**"
      - "AGENTS.md"
      - "README*"
      - ".markdownlint-cli2.jsonc"
      - "scripts/ci/check-windows7-virtio-contract-consistency.py"
      - "scripts/ci/check-aerogpu-share-token-contract.py"
      - "scripts/ci/check-aerogpu-win7-dbgctl-readme-flags.py"
      - "scripts/ci/check-win7-virtio-input-hidtest-readme-flags.py"
      - "scripts/ci/check-gs-docs-banned-words.py"
      - "scripts/ci/check-usb-doc-paths.py"
      - "scripts/ci/check-virtio-win-guest-tools-docs.py"
      - "scripts/ci/gen-guest-tools-devices-cmd.py"
      - "scripts/generate-guest-tools-devices-cmd.py"
      - "guest-tools/config/devices.cmd"
      - "tools/packaging/specs/*.json"
      - "crates/devices/src/pci/profile.rs"
      - "crates/aero-virtio/src/devices/blk.rs"
      - "crates/aero-virtio/src/devices/net.rs"
      - "crates/aero-virtio/src/devices/input.rs"
      - "crates/aero-virtio/src/devices/snd.rs"
      - "drivers/scripts/make-guest-tools-from-virtio-win.ps1"
      - "drivers/scripts/make-guest-tools-from-virtio-win.sh"
      - "drivers/README.md"
      - "drivers/windows7/virtio-blk/inf/aero_virtio_blk.inf"
      - "drivers/windows7/virtio-net/inf/aero_virtio_net.inf"
      - "drivers/windows7/virtio-snd/inf/aero_virtio_snd.inf"
      - "drivers/windows7/virtio-input/inf/aero_virtio_input.inf"
      - "drivers/windows7/virtio-input/tests/qemu/README.md"
      - "drivers/windows7/virtio-input/tools/hidtest/README.md"
      - "drivers/windows7/virtio-input/tools/hidtest/main.c"
      - "drivers/windows7/virtio-blk/include/aero_virtio_blk.h"
      - "drivers/windows7/virtio-net/include/aero_virtio_net.h"
      - "drivers/windows7/virtio-input/src/virtio_input.h"
      - "drivers/win7/virtio/virtio-core/portable/virtio_pci_identity.h"
      - "drivers/windows/virtio/pci-modern/virtio_pci_modern_transport.h"
      - "drivers/windows/virtio/pci-modern/virtio_pci_modern_transport.c"
      - "drivers/aerogpu/protocol/**"
      - "drivers/aerogpu/kmd/README.md"
      - "drivers/aerogpu/tests/win7/README.md"
      - "drivers/aerogpu/umd/d3d9/README.md"
      - "drivers/aerogpu/umd/d3d10_11/README.md"
      - "drivers/aerogpu/tools/win7_dbgctl/README.md"
      - "drivers/aerogpu/tools/win7_dbgctl/src/aerogpu_dbgctl.cpp"
      - "drivers/aerogpu/packaging/win7/README.md"
      - "tools/packaging/README.md"
      - "tools/packaging/specs/README.md"
      - ".github/workflows/docs.yml"
  push:
    branches: ["main"]
    paths:
      - "docs/**"
      - "instructions/**"
      - "AGENTS.md"
      - "README*"
      - ".markdownlint-cli2.jsonc"
      - "scripts/ci/check-windows7-virtio-contract-consistency.py"
      - "scripts/ci/check-aerogpu-share-token-contract.py"
      - "scripts/ci/check-aerogpu-win7-dbgctl-readme-flags.py"
      - "scripts/ci/check-win7-virtio-input-hidtest-readme-flags.py"
      - "scripts/ci/check-gs-docs-banned-words.py"
      - "scripts/ci/check-usb-doc-paths.py"
      - "scripts/ci/check-virtio-win-guest-tools-docs.py"
      - "scripts/ci/gen-guest-tools-devices-cmd.py"
      - "scripts/generate-guest-tools-devices-cmd.py"
      - "guest-tools/config/devices.cmd"
      - "tools/packaging/specs/*.json"
      - "crates/devices/src/pci/profile.rs"
      - "crates/aero-virtio/src/devices/blk.rs"
      - "crates/aero-virtio/src/devices/net.rs"
      - "crates/aero-virtio/src/devices/input.rs"
      - "crates/aero-virtio/src/devices/snd.rs"
      - "drivers/scripts/make-guest-tools-from-virtio-win.ps1"
      - "drivers/scripts/make-guest-tools-from-virtio-win.sh"
      - "drivers/README.md"
      - "drivers/windows7/virtio-blk/inf/aero_virtio_blk.inf"
      - "drivers/windows7/virtio-net/inf/aero_virtio_net.inf"
      - "drivers/windows7/virtio-snd/inf/aero_virtio_snd.inf"
      - "drivers/windows7/virtio-input/inf/aero_virtio_input.inf"
      - "drivers/windows7/virtio-input/tests/qemu/README.md"
      - "drivers/windows7/virtio-input/tools/hidtest/README.md"
      - "drivers/windows7/virtio-input/tools/hidtest/main.c"
      - "drivers/windows7/virtio-blk/include/aero_virtio_blk.h"
      - "drivers/windows7/virtio-net/include/aero_virtio_net.h"
      - "drivers/windows7/virtio-input/src/virtio_input.h"
      - "drivers/win7/virtio/virtio-core/portable/virtio_pci_identity.h"
      - "drivers/windows/virtio/pci-modern/virtio_pci_modern_transport.h"
      - "drivers/windows/virtio/pci-modern/virtio_pci_modern_transport.c"
      - "drivers/aerogpu/protocol/**"
      - "drivers/aerogpu/kmd/README.md"
      - "drivers/aerogpu/tests/win7/README.md"
      - "drivers/aerogpu/umd/d3d9/README.md"
      - "drivers/aerogpu/umd/d3d10_11/README.md"
      - "drivers/aerogpu/tools/win7_dbgctl/README.md"
      - "drivers/aerogpu/tools/win7_dbgctl/src/aerogpu_dbgctl.cpp"
      - "drivers/aerogpu/packaging/win7/README.md"
      - "tools/packaging/README.md"
      - "tools/packaging/specs/README.md"
      - ".github/workflows/docs.yml"
  workflow_dispatch:
    inputs:
      check_external:
        description: "Also check external links (slower and can be flaky)"
        type: boolean
        default: false

permissions:
  contents: read

concurrency:
  group: docs-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  docs:
    name: Docs (markdown + links)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Markdown lint
        uses: DavidAnson/markdownlint-cli2-action@v17
        with:
          globs: |
            AGENTS.md
            README*.md
            docs/**/*.md
            instructions/**/*.md

      - name: Check docs for emulator-only USB path pointers
        run: python3 scripts/ci/check-usb-doc-paths.py

      - name: Check GS docs wording
        run: python3 scripts/ci/check-gs-docs-banned-words.py

      - name: Check Windows 7 virtio contract consistency
        run: python3 scripts/ci/check-windows7-virtio-contract-consistency.py

      - name: Check AeroGPU shared surface ShareToken contract
        run: python3 scripts/ci/check-aerogpu-share-token-contract.py

      - name: Check AeroGPU Win7 dbgctl README flags match implementation
        run: python3 scripts/ci/check-aerogpu-win7-dbgctl-readme-flags.py

      - name: Check Win7 virtio-input hidtest docs flags match implementation
        run: python3 scripts/ci/check-win7-virtio-input-hidtest-readme-flags.py

      - name: Check Guest Tools devices.cmd is generated from contract
        run: python3 scripts/ci/gen-guest-tools-devices-cmd.py --check

      - name: Check virtio-win Guest Tools docs match wrapper defaults
        run: python3 scripts/ci/check-virtio-win-guest-tools-docs.py

      # Fast, deterministic check for broken relative links in markdown.
      # We intentionally run lychee in `--offline` mode so docs-only PRs get
      # meaningful CI without depending on external network reliability.
      - name: Check internal markdown links (offline)
        uses: lycheeverse/lychee-action@v1
        with:
          args: >-
            --no-progress
            --offline
            --exclude ^https?://
            --exclude ^wss?://
            AGENTS.md
            README*.md
            docs
            instructions
          fail: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Optional: manually check external links. This is opt-in to avoid flakes.
      - name: Check external links (manual)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.check_external == 'true'
        uses: lycheeverse/lychee-action@v1
        with:
          args: >-
            --no-progress
            --timeout 10
            --exclude ^wss?://
            --exclude ^https?://localhost
            --exclude ^https?://127\.0\.0\.1
            --exclude ^https?://10\.0\.2\.2
            --exclude ^https?://(?:[a-z0-9-]+\.)*example\.com
            --exclude ^https?://(?:[a-z0-9-]+\.)*example\.net
            --exclude ^https?://[^/]*\.example(?:/|$)
            --exclude ^https?://(?:[a-z0-9-]+\.)*examplecdn\.com
            --exclude ^https?://.*\.invalid
            --exclude ^https?://.*\.cloudfront\.net
            --exclude ^https?://s3\.amazonaws\.com
            --exclude ^https?://cloudflare-dns\.com/dns-query
            --exclude ^https?://YOUR_
            --exclude ^https?://disk-image-service
            --exclude ^https?://storage
            AGENTS.md
            README*.md
            docs
            instructions
          fail: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
