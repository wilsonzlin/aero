name: Docs

on:
  pull_request:
    paths:
      - "docs/**"
      - "AGENTS.md"
      - "README*"
      - ".markdownlint-cli2.jsonc"
      - "scripts/ci/check-windows7-virtio-contract-consistency.py"
      - "scripts/ci/gen-guest-tools-devices-cmd.py"
      - "scripts/generate-guest-tools-devices-cmd.py"
      - "guest-tools/config/devices.cmd"
      - "crates/devices/src/pci/profile.rs"
      - "crates/aero-virtio/src/devices/blk.rs"
      - "crates/aero-virtio/src/devices/net.rs"
      - "crates/aero-virtio/src/devices/input.rs"
      - "crates/aero-virtio/src/devices/snd.rs"
      - "drivers/windows7/virtio/blk/aerovblk.inf"
      - "drivers/windows7/virtio/net/aerovnet.inf"
      - "drivers/windows7/virtio-snd/inf/aero-virtio-snd.inf"
      - "drivers/windows/virtio-input/virtio-input.inf"
      - ".github/workflows/docs.yml"
  push:
    branches: ["main"]
    paths:
      - "docs/**"
      - "AGENTS.md"
      - "README*"
      - ".markdownlint-cli2.jsonc"
      - "scripts/ci/check-windows7-virtio-contract-consistency.py"
      - "scripts/ci/gen-guest-tools-devices-cmd.py"
      - "scripts/generate-guest-tools-devices-cmd.py"
      - "guest-tools/config/devices.cmd"
      - "crates/devices/src/pci/profile.rs"
      - "crates/aero-virtio/src/devices/blk.rs"
      - "crates/aero-virtio/src/devices/net.rs"
      - "crates/aero-virtio/src/devices/input.rs"
      - "crates/aero-virtio/src/devices/snd.rs"
      - "drivers/windows7/virtio/blk/aerovblk.inf"
      - "drivers/windows7/virtio/net/aerovnet.inf"
      - "drivers/windows7/virtio-snd/inf/aero-virtio-snd.inf"
      - "drivers/windows/virtio-input/virtio-input.inf"
      - ".github/workflows/docs.yml"
  workflow_dispatch:
    inputs:
      check_external:
        description: "Also check external links (slower and can be flaky)"
        type: boolean
        default: false

permissions:
  contents: read

concurrency:
  group: docs-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  docs:
    name: Docs (markdown + links)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Markdown lint
        uses: DavidAnson/markdownlint-cli2-action@v17
        with:
          globs: |
            AGENTS.md
            README*.md
            docs/**/*.md

      - name: Check Windows 7 virtio contract consistency
        run: python3 scripts/ci/check-windows7-virtio-contract-consistency.py

      - name: Check Guest Tools devices.cmd is generated from contract
        run: python3 scripts/ci/gen-guest-tools-devices-cmd.py --check

      # Fast, deterministic check for broken relative links in markdown.
      # We intentionally run lychee in `--offline` mode so docs-only PRs get
      # meaningful CI without depending on external network reliability.
      - name: Check internal markdown links (offline)
        uses: lycheeverse/lychee-action@v1
        with:
          args: >-
            --no-progress
            --offline
            --exclude ^https?://
            --exclude ^wss?://
            AGENTS.md
            README*.md
            docs
          fail: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Optional: manually check external links. This is opt-in to avoid flakes.
      - name: Check external links (manual)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.check_external == 'true'
        uses: lycheeverse/lychee-action@v1
        with:
          args: >-
            --no-progress
            --timeout 10
            --exclude ^wss?://
            --exclude ^https?://localhost
            --exclude ^https?://127\.0\.0\.1
            --exclude ^https?://10\.0\.2\.2
            --exclude ^https?://(?:[a-z0-9-]+\.)*example\.com
            --exclude ^https?://(?:[a-z0-9-]+\.)*example\.net
            --exclude ^https?://[^/]*\.example(?:/|$)
            --exclude ^https?://(?:[a-z0-9-]+\.)*examplecdn\.com
            --exclude ^https?://.*\.invalid
            --exclude ^https?://.*\.cloudfront\.net
            --exclude ^https?://s3\.amazonaws\.com
            --exclude ^https?://cloudflare-dns\.com/dns-query
            --exclude ^https?://YOUR_
            --exclude ^https?://disk-image-service
            --exclude ^https?://storage
            AGENTS.md
            README*.md
            docs
          fail: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
