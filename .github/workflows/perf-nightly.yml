name: Perf (nightly)

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      iterations:
        description: Iterations per benchmark (median-of-N)
        required: false
        default: "7"

permissions:
  contents: write

jobs:
  perf-nightly:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    env:
      NODE_VERSION: "20.11.1"
      PERF_ITERATIONS: ${{ github.event.inputs.iterations || '7' }}
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: tools/perf/package-lock.json

      - name: Determine Playwright version
        id: playwright-version
        run: |
          set -euo pipefail
          version="$(node -p "const pkg=require('./tools/perf/package.json'); (pkg.dependencies && pkg.dependencies['playwright-core']) || (pkg.devDependencies && pkg.devDependencies['playwright-core']) || ''")"
          version="${version#^}"
          version="${version#~}"
          if [[ -z "$version" ]]; then
            echo "playwright-core version not found in tools/perf/package.json" >&2
            exit 1
          fi
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Install perf tool dependencies
        run: npm ci
        working-directory: tools/perf

      - name: Install Chromium (Playwright)
        run: npx --yes playwright@${{ steps.playwright-version.outputs.version }} install --with-deps chromium

      - name: Run browser perf (nightly)
        run: node tools/perf/run.mjs --out-dir perf-results/nightly --iterations ${{ env.PERF_ITERATIONS }}

      - name: Upload browser perf artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-nightly-${{ github.run_id }}
          path: perf-results/nightly
          if-no-files-found: error

      - name: Checkout gh-pages (optional; used to load prior history)
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          ref: gh-pages
          path: .gh-pages
          fetch-depth: 1

      - name: Restore previous history
        run: |
          if [ -f .gh-pages/history.json ]; then
            cp .gh-pages/history.json bench/history.json
          fi

      - name: Run microbenchmarks (history)
        run: node bench/run.js --out bench/results.json

      - name: Append to history
        run: |
          node bench/history.js append \
            --history bench/history.json \
            --input bench/results.json \
            --timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --commit "$GITHUB_SHA" \
            --repository "$GITHUB_REPOSITORY"

      - name: Generate markdown report
        run: node bench/history.js render-md --history bench/history.json --out bench/history.md

      - name: Build dashboard bundle
        run: |
          rm -rf dist/perf-dashboard
          mkdir -p dist/perf-dashboard
          cp -r bench/dashboard/* dist/perf-dashboard/
          cp bench/history.json dist/perf-dashboard/history.json
          cp bench/history.md dist/perf-dashboard/history.md
          cp bench/history.schema.json dist/perf-dashboard/history.schema.json

      - name: Upload history + dashboard artifact
        uses: actions/upload-artifact@v4
        with:
          name: perf-history-dashboard
          path: dist/perf-dashboard

      - name: Publish dashboard to gh-pages
        if: github.repository == 'wilsonzlin/aero' && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: dist/perf-dashboard
          publish_branch: gh-pages
