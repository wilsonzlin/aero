name: Perf (nightly)

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      iterations:
        description: Iterations per benchmark (median-of-N)
        required: false
        default: "7"

permissions:
  contents: write

concurrency:
  group: perf-nightly-${{ github.ref }}
  cancel-in-progress: true

jobs:
  perf-nightly:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    env:
      PERF_ITERATIONS: ${{ github.event.inputs.iterations || '7' }}
      PERF_TRACE: ${{ vars.PERF_TRACE }}
      PERF_TRACE_DURATION_MS: ${{ vars.PERF_TRACE_DURATION_MS }}
      PERF_INCLUDE_AERO_BENCH: ${{ vars.PERF_INCLUDE_AERO_BENCH }}
      AERO_NODE_DIR: ${{ vars.AERO_NODE_DIR }}
      AERO_REQUIRE_WEBGPU: "0"
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node workspace
        id: node-workspace
        uses: ./.github/actions/setup-node-workspace

      - name: Setup Playwright (cached)
        uses: ./.github/actions/setup-playwright
        with:
          browsers: chromium
          working-directory: tools/perf
          lockfile: ${{ steps.node-workspace.outputs.lockfile }}

      - name: Run browser perf (nightly)
        run: node scripts/ci/run_browser_perf.mjs --workspace "${{ steps.node-workspace.outputs.dir }}" --preview --preview-port 4173 --out-dir perf-results/nightly

      - name: Validate perf export (nightly browser)
        run: node tools/perf/validate_perf_export.mjs --schema bench/schema/perf-output.schema.json --input perf-results/nightly/perf_export.json

      - name: Write GPU perf scenario params
        run: |
          set -euo pipefail
          mkdir -p perf-results/gpu
          cat > perf-results/gpu/scenario_params.json <<'JSON'
          {
            "vga_text_scroll": { "frames": 120 },
            "vbe_lfb_blit": { "frames": 60, "width": 256, "height": 256 }
          }
          JSON

      - name: Run GPU perf (nightly)
        run: |
          set -euo pipefail
          node --experimental-strip-types --import ./scripts/register-ts-strip-loader.mjs bench/gpu_bench.ts \
            --scenarios vga_text_scroll,vbe_lfb_blit,webgpu_triangle_batch,d3d9_state_churn \
            --scenario-params perf-results/gpu/scenario_params.json \
            --swiftshader true \
            --iterations ${{ env.PERF_ITERATIONS }} \
            --output perf-results/gpu/raw.json

      - name: Run storage perf (nightly)
        run: |
          set -euo pipefail
          node --experimental-strip-types --import ./scripts/register-ts-strip-loader.mjs bench/runner.ts storage_io \
            --out-dir perf-results/storage_io

      - name: Validate perf export (storage_io, if present)
        run: |
          set -euo pipefail
          if [[ -f perf-results/storage_io/perf_export.json ]]; then
            node tools/perf/validate_perf_export.mjs \
              --schema bench/schema/perf-output.schema.json \
              --input perf-results/storage_io/perf_export.json
          else
            echo "perf-results/storage_io/perf_export.json not found; skipping perf export schema validation."
          fi
      - name: Run aero-gateway bench (nightly)
        run: |
          set -euo pipefail
          mkdir -p perf-results/gateway
          npm -w backend/aero-gateway run build
          node backend/aero-gateway/bench/run.mjs \
            --mode nightly \
            --json "$GITHUB_WORKSPACE/perf-results/gateway/raw.json"

      - name: Job summary
        if: always()
        run: |
          {
            echo "### Perf (nightly)"
            echo ""
            echo "- Iterations: ${{ env.PERF_ITERATIONS }}"
            echo "- Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            echo "- Artifacts:"
            echo "  - perf-nightly-${{ github.run_id }} (\`perf-results/nightly\`)"
            echo "  - perf-history-dashboard (\`dist/perf-dashboard\`)"
            if [[ -f perf-results/storage_io/storage_bench.json ]]; then
              echo "- Storage: \`perf-results/storage_io/storage_bench.json\`"
            fi
            if [[ -f perf-results/storage_io/report.json ]]; then
              echo "- Storage report: \`perf-results/storage_io/report.json\`"
            fi
            if [[ -f perf-results/gpu/raw.json ]]; then
              echo "- GPU: \`perf-results/gpu/raw.json\`"
            fi
            if [[ -f perf-results/gateway/raw.json ]]; then
              echo "- Gateway: \`perf-results/gateway/raw.json\`"
            fi
            echo ""
            if [[ -f perf-results/nightly/summary.json ]]; then
              node - <<'NODE'
              const fs = require("node:fs");
              const path = require("node:path");

              const summaryPath = path.join(process.env.GITHUB_WORKSPACE, "perf-results", "nightly", "summary.json");
              const summary = JSON.parse(fs.readFileSync(summaryPath, "utf8"));

              const meta = summary.meta ?? {};
              if (typeof meta.gitSha === "string") {
                console.log(`Commit: \`${meta.gitSha}\``);
                console.log("");
              }
              if (typeof meta.chromiumVersion === "string") {
                console.log(`Chromium: \`${meta.chromiumVersion}\``);
                console.log("");
              }

              const fmtTraceStatus = (trace) => {
                if (!trace || typeof trace !== "object") return "unknown";
                const requested = trace.requested === true;
                const available = trace.available === true;
                const captured = trace.captured === true;
                const timedOut = trace.timedOut === true;
                if (!requested) return available ? "available (not captured)" : "not captured";
                if (timedOut) return "timed out";
                if (!available) return "unsupported";
                return captured ? "captured" : "not captured";
              };

              const aeroPerf = meta.aeroPerf && typeof meta.aeroPerf === "object" ? meta.aeroPerf : null;
              if (aeroPerf) {
                const exportApiTimedOut = aeroPerf.exportApiTimedOut === true;
                const exportAvailable = aeroPerf.exportAvailable === true;
                const exportStatus = exportAvailable ? (exportApiTimedOut ? "available (late)" : "available") : exportApiTimedOut ? "timed out" : "unavailable";
                console.log(`Perf export: ${exportStatus} (\`perf-results/nightly/perf_export.json\`)`);
                console.log(`Trace: ${fmtTraceStatus(aeroPerf.trace)} (\`perf-results/nightly/trace.json\`)`);
                console.log("");
              }

              const benches = Array.isArray(summary.benchmarks) ? summary.benchmarks : [];
              if (benches.length === 0) {
                console.log("_No benchmarks found in summary.json._");
                process.exit(0);
              }

              const fmtNumber = (n) => {
                if (!Number.isFinite(n)) return "n/a";
                const abs = Math.abs(n);
                if (abs >= 1000) return n.toFixed(0);
                if (abs >= 10) return n.toFixed(2);
                return n.toFixed(3);
              };
              const fmtCv = (n) => (Number.isFinite(n) ? `${(n * 100).toFixed(2)}%` : "n/a");
              const fmtN = (n) => (Number.isFinite(n) ? Math.round(n).toString() : "n/a");

              console.log("| Benchmark | Median | CV | n |");
              console.log("| --- | ---: | ---: | ---: |");
              for (const b of benches) {
                const name = String(b.name ?? "");
                const unit = String(b.unit ?? "");
                const median = b.stats?.median;
                const cv = b.stats?.cv;
                const n = b.stats?.n;
                const medianText = `${fmtNumber(median)} ${unit}`.trim();
                console.log(`| \`${name}\` | ${medianText} | ${fmtCv(cv)} | ${fmtN(n)} |`);
              }
          NODE
              if [[ -f perf-results/gateway/raw.json ]]; then
                node - <<'NODE'
                const fs = require("node:fs");
                const path = require("node:path");

                const gatewayPath = path.join(process.env.GITHUB_WORKSPACE, "perf-results", "gateway", "raw.json");
                const data = JSON.parse(fs.readFileSync(gatewayPath, "utf8"));

                const rtt = data.tcpProxy?.rttMs ?? {};
                const thr = data.tcpProxy?.throughput ?? {};
                const thrStats = thr.stats ?? {};
                const doh = data.doh ?? {};
                const qpsStats = doh.qpsStats ?? {};
                const latency = doh.latencyMs ?? {};

                const fmt = (n, decimals = 2) => (typeof n === "number" && Number.isFinite(n) ? n.toFixed(decimals) : "n/a");
                const fmtInt = (n) => (typeof n === "number" && Number.isFinite(n) ? Math.round(n).toString() : "n/a");
                const fmtCv = (cv) =>
                  typeof cv === "number" && Number.isFinite(cv) ? (cv === 0 ? "0" : `${(cv * 100).toFixed(2)}%`) : "n/a";

                const rows = [];
                const pushRow = (label, value, cv, n) => rows.push([label, value, fmtCv(cv), fmtInt(n)]);

                pushRow("tcp_rtt_p50_ms", `${fmt(rtt.p50, 2)} ms`, rtt.cv, rtt.n);
                pushRow("tcp_throughput_mib_s", `${fmt(thr.mibPerSecond, 1)} MiB/s`, thrStats.cv, thrStats.n);
                pushRow("doh_qps", `${fmt(doh.qps, 0)} qps`, qpsStats.cv, qpsStats.n);
                const hitRatio = doh.cache?.hitRatio;
                pushRow(
                  "doh_cache_hit_ratio_pct",
                  hitRatio == null ? "n/a" : `${fmt(hitRatio * 100, 1)} %`,
                  null,
                  (doh.cache?.hits ?? 0) + (doh.cache?.misses ?? 0),
                );
                pushRow("doh_latency_p99_ms", `${fmt(latency.p99, 2)} ms`, latency.cv, latency.n);

                console.log("");
                console.log("Gateway:");
                console.log("");
                console.log("| Metric | Value | CV | n |");
                console.log("| --- | ---: | ---: | ---: |");
                for (const row of rows) {
                  console.log(`| \`${row[0]}\` | ${row[1]} | ${row[2]} | ${row[3]} |`);
                }
              NODE
              fi
            else
              echo "_No summary.json produced._"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload perf artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-nightly-${{ github.run_id }}
          path: perf-results
          if-no-files-found: error
          retention-days: 14

      - name: Checkout gh-pages (optional; used to load prior history)
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          ref: gh-pages
          path: .gh-pages
          fetch-depth: 1

      - name: Restore previous history
        run: |
          if [ -f .gh-pages/history.json ]; then
            cp .gh-pages/history.json bench/history.json
          fi

      - name: Compute history timestamp
        id: history-timestamp
        run: echo "ts=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$GITHUB_OUTPUT"

      - name: Append to history
        run: |
          ts="${{ steps.history-timestamp.outputs.ts }}"

          node bench/history.js append \
            --history bench/history.json \
            --input perf-results/nightly/raw.json \
            --timestamp "$ts" \
            --commit "$GITHUB_SHA" \
            --repository "$GITHUB_REPOSITORY"

          node bench/history.js append \
            --history bench/history.json \
            --input perf-results/gpu/raw.json \
            --timestamp "$ts" \
            --commit "$GITHUB_SHA" \
            --repository "$GITHUB_REPOSITORY"

          node bench/history.js append \
            --history bench/history.json \
            --input perf-results/storage_io/storage_bench.json \
            --timestamp "$ts" \
            --commit "$GITHUB_SHA" \
            --repository "$GITHUB_REPOSITORY"

          node bench/history.js append \
            --history bench/history.json \
            --input perf-results/gateway/raw.json \
            --timestamp "$ts" \
            --commit "$GITHUB_SHA" \
            --repository "$GITHUB_REPOSITORY"

      - name: Generate markdown report
        run: node bench/history.js render-md --history bench/history.json --out bench/history.md

      - name: Build dashboard bundle
        run: |
          rm -rf dist/perf-dashboard
          mkdir -p dist/perf-dashboard
          cp -r bench/dashboard/* dist/perf-dashboard/
          mkdir -p dist/perf-dashboard/_shared
          cp web/public/_shared/text_one_line.js dist/perf-dashboard/_shared/text_one_line.js
          cp bench/history.json dist/perf-dashboard/history.json
          cp bench/history.md dist/perf-dashboard/history.md
          cp bench/history.schema.json dist/perf-dashboard/history.schema.json

      - name: Upload history + dashboard artifact
        uses: actions/upload-artifact@v4
        with:
          name: perf-history-dashboard
          path: dist/perf-dashboard
          retention-days: 14

      - name: Publish dashboard to gh-pages
        if: github.repository == 'wilsonzlin/aero' && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: dist/perf-dashboard
          publish_branch: gh-pages
