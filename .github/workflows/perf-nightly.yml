name: Perf (nightly)

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      iterations:
        description: Iterations per benchmark (median-of-N)
        required: false
        default: "7"

permissions:
  contents: write

jobs:
  perf-nightly:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    env:
      NODE_VERSION: "20.11.1"
      PERF_ITERATIONS: ${{ github.event.inputs.iterations || '7' }}
      AERO_NODE_DIR: ${{ vars.AERO_NODE_DIR }}
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Determine Node workspace directory
        id: node-dir
        run: |
          set -euo pipefail

          if [[ -n "${AERO_NODE_DIR:-}" ]]; then
            dir="$AERO_NODE_DIR"
          elif [[ -f package.json ]]; then
            dir="."
          elif [[ -f frontend/package.json ]]; then
            dir="frontend"
          elif [[ -f web/package.json ]]; then
            dir="web"
          else
            echo "package.json not found. Set AERO_NODE_DIR to the directory containing package.json." >&2
            exit 1
          fi

          lockfile="$dir/package-lock.json"
          if [[ "$dir" == "." ]]; then
            lockfile="package-lock.json"
          fi
          if [[ ! -f "$lockfile" ]]; then
            echo "package-lock.json not found at '$lockfile'. This workflow expects npm; ensure a lockfile exists." >&2
            exit 1
          fi

          echo "dir=$dir" >> "$GITHUB_OUTPUT"
          echo "lockfile=$lockfile" >> "$GITHUB_OUTPUT"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: |
            tools/perf/package-lock.json
            ${{ steps.node-dir.outputs.lockfile }}

      - name: Determine Playwright version
        id: playwright-version
        run: |
          set -euo pipefail
          version="$(node -p "require('./tools/perf/package-lock.json')?.packages?.['node_modules/playwright-core']?.version ?? ''")"
          if [[ -z "$version" ]]; then
            echo "playwright-core version not found in tools/perf/package-lock.json" >&2
            exit 1
          fi
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}-chromium
          restore-keys: |
            ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}-

      - name: Install perf tool dependencies
        run: npm ci
        working-directory: tools/perf

      - name: Install Chromium (Playwright)
        run: node node_modules/playwright-core/cli.js install --with-deps chromium
        working-directory: tools/perf

      - name: Install app dependencies (nightly)
        run: npm ci
        working-directory: ${{ steps.node-dir.outputs.dir }}
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"

      - name: Build app (nightly)
        run: npm run build
        working-directory: ${{ steps.node-dir.outputs.dir }}

      - name: Run browser perf (nightly)
        working-directory: ${{ steps.node-dir.outputs.dir }}
        run: |
          set -euo pipefail
          PORT=4173
          setsid npm run preview -- --host 127.0.0.1 --port "$PORT" --strictPort &
          server_pid=$!
          cleanup() {
            kill -- "-$server_pid" || true
            sleep 1
            kill -9 -- "-$server_pid" || true
            wait "$server_pid" || true
          }
          trap cleanup EXIT

          for i in {1..60}; do
            curl -fsS "http://127.0.0.1:$PORT/" >/dev/null && break
            sleep 1
          done
          curl -fsS "http://127.0.0.1:$PORT/" >/dev/null

          node "$GITHUB_WORKSPACE/tools/perf/run.mjs" \
            --url "http://127.0.0.1:$PORT/" \
            --out-dir "$GITHUB_WORKSPACE/perf-results/nightly" \
            --iterations ${{ env.PERF_ITERATIONS }}

      - name: Job summary
        if: always()
        run: |
          {
            echo "### Perf (nightly)"
            echo ""
            echo "- Iterations: ${{ env.PERF_ITERATIONS }}"
            if [[ -f perf-results/nightly/summary.json ]]; then
              echo ""
              echo "Raw summary:"
              echo ""
              echo '```json'
              cat perf-results/nightly/summary.json
              echo '```'
            else
              echo ""
              echo "_No summary.json produced._"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload browser perf artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-nightly-${{ github.run_id }}
          path: perf-results/nightly
          if-no-files-found: error

      - name: Checkout gh-pages (optional; used to load prior history)
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          ref: gh-pages
          path: .gh-pages
          fetch-depth: 1

      - name: Restore previous history
        run: |
          if [ -f .gh-pages/history.json ]; then
            cp .gh-pages/history.json bench/history.json
          fi

      - name: Run microbenchmarks (history)
        run: node bench/run.js --out bench/results.json

      - name: Append to history
        run: |
          node bench/history.js append \
            --history bench/history.json \
            --input bench/results.json \
            --timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --commit "$GITHUB_SHA" \
            --repository "$GITHUB_REPOSITORY"

      - name: Generate markdown report
        run: node bench/history.js render-md --history bench/history.json --out bench/history.md

      - name: Build dashboard bundle
        run: |
          rm -rf dist/perf-dashboard
          mkdir -p dist/perf-dashboard
          cp -r bench/dashboard/* dist/perf-dashboard/
          cp bench/history.json dist/perf-dashboard/history.json
          cp bench/history.md dist/perf-dashboard/history.md
          cp bench/history.schema.json dist/perf-dashboard/history.schema.json

      - name: Upload history + dashboard artifact
        uses: actions/upload-artifact@v4
        with:
          name: perf-history-dashboard
          path: dist/perf-dashboard

      - name: Publish dashboard to gh-pages
        if: github.repository == 'wilsonzlin/aero' && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: dist/perf-dashboard
          publish_branch: gh-pages
