name: Perf (nightly)

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      iterations:
        description: Iterations per benchmark (median-of-N)
        required: false
        default: "7"

permissions:
  contents: write

concurrency:
  group: perf-nightly-${{ github.ref }}
  cancel-in-progress: true

jobs:
  perf-nightly:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    env:
      PERF_ITERATIONS: ${{ github.event.inputs.iterations || '7' }}
      AERO_REQUIRE_WEBGPU: "0"
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install dependencies (npm ci)
        run: npm ci

      - name: Setup Playwright (cached)
        uses: ./.github/actions/setup-playwright
        with:
          browsers: chromium
          working-directory: tools/perf
          lockfile: package-lock.json

      - name: Build app (nightly)
        run: npm run build

      - name: Run browser perf (nightly)
        run: |
          set -euo pipefail
          PORT=4173
          setsid npm run preview -- --host 127.0.0.1 --port "$PORT" --strictPort &
          server_pid=$!
          cleanup() {
            kill -- "-$server_pid" || true
            sleep 1
            kill -9 -- "-$server_pid" || true
            wait "$server_pid" || true
          }
          trap cleanup EXIT

          for i in {1..60}; do
            curl -fsS "http://127.0.0.1:$PORT/" >/dev/null && break
            sleep 1
          done
          curl -fsS "http://127.0.0.1:$PORT/" >/dev/null

          node "$GITHUB_WORKSPACE/tools/perf/run.mjs" \
            --url "http://127.0.0.1:$PORT/" \
            --out-dir "$GITHUB_WORKSPACE/perf-results/nightly" \
            --iterations ${{ env.PERF_ITERATIONS }}

      - name: Write GPU perf scenario params
        run: |
          set -euo pipefail
          mkdir -p perf-results/gpu
          cat > perf-results/gpu/scenario_params.json <<'JSON'
          {
            "vga_text_scroll": { "frames": 120 },
            "vbe_lfb_blit": { "frames": 60, "width": 256, "height": 256 }
          }
          JSON

      - name: Run GPU perf (nightly)
        run: |
          set -euo pipefail
          node --experimental-strip-types bench/gpu_bench.ts \
            --scenarios vga_text_scroll,vbe_lfb_blit,webgpu_triangle_batch,d3d9_state_churn \
            --scenario-params perf-results/gpu/scenario_params.json \
            --swiftshader true \
            --output perf-results/gpu/raw.json

      - name: Job summary
        if: always()
        run: |
          {
            echo "### Perf (nightly)"
            echo ""
            echo "- Iterations: ${{ env.PERF_ITERATIONS }}"
            if [[ -f perf-results/nightly/summary.json ]]; then
              echo ""
              echo "Raw summary:"
              echo ""
              echo '```json'
              cat perf-results/nightly/summary.json
              echo '```'
            else
              echo ""
              echo "_No summary.json produced._"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload perf artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-nightly-${{ github.run_id }}
          path: perf-results
          if-no-files-found: error
          retention-days: 14

      - name: Checkout gh-pages (optional; used to load prior history)
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          ref: gh-pages
          path: .gh-pages
          fetch-depth: 1

      - name: Restore previous history
        run: |
          if [ -f .gh-pages/history.json ]; then
            cp .gh-pages/history.json bench/history.json
          fi

      - name: Compute history timestamp
        id: history-timestamp
        run: echo "ts=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$GITHUB_OUTPUT"

      - name: Append to history
        run: |
          ts="${{ steps.history-timestamp.outputs.ts }}"

          node bench/history.js append \
            --history bench/history.json \
            --input perf-results/nightly/raw.json \
            --timestamp "$ts" \
            --commit "$GITHUB_SHA" \
            --repository "$GITHUB_REPOSITORY"

          node bench/history.js append \
            --history bench/history.json \
            --input perf-results/gpu/raw.json \
            --timestamp "$ts" \
            --commit "$GITHUB_SHA" \
            --repository "$GITHUB_REPOSITORY"

      - name: Generate markdown report
        run: node bench/history.js render-md --history bench/history.json --out bench/history.md

      - name: Build dashboard bundle
        run: |
          rm -rf dist/perf-dashboard
          mkdir -p dist/perf-dashboard
          cp -r bench/dashboard/* dist/perf-dashboard/
          cp bench/history.json dist/perf-dashboard/history.json
          cp bench/history.md dist/perf-dashboard/history.md
          cp bench/history.schema.json dist/perf-dashboard/history.schema.json

      - name: Upload history + dashboard artifact
        uses: actions/upload-artifact@v4
        with:
          name: perf-history-dashboard
          path: dist/perf-dashboard
          retention-days: 14

      - name: Publish dashboard to gh-pages
        if: github.repository == 'wilsonzlin/aero' && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: dist/perf-dashboard
          publish_branch: gh-pages
