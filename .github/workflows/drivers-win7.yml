name: Win7 Drivers (build + catalog + test-sign)

on:
  pull_request:
    paths:
      - "drivers/**"
      - "ci/**"
      - "tools/packaging/**"
      - "guest-tools/**"
      - ".github/workflows/drivers-win7.yml"
    paths-ignore:
      - "docs/**"
      - "**/*.md"
  push:
    branches:
      - main
    paths:
      - "drivers/**"
      - "ci/**"
      - "tools/packaging/**"
      - "guest-tools/**"
      - ".github/workflows/drivers-win7.yml"
    paths-ignore:
      - "docs/**"
      - "**/*.md"
  workflow_dispatch:

jobs:
  drivers-win7:
    runs-on: windows-latest
    outputs:
      skip: ${{ steps.detect.outputs.skip }}
      has_sys: ${{ steps.built.outputs.has_sys }}
    env:
      # Cache only the installer/downloads (not the installed WDK toolchain).
      WDK_DOWNLOAD_CACHE: C:\wdk-download-cache
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Version stamping derives from git tags/commits; fetch full history + tags so
          # `git describe` and commit-distance calculations are accurate.
          fetch-depth: 0
          fetch-tags: true

      - name: Run virtio host tests (CMake)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $hasWin7VirtioCommon = Test-Path -LiteralPath 'drivers/windows7/virtio/common/tests/CMakeLists.txt'
          $hasPortableVirtqSplit = Test-Path -LiteralPath 'drivers/windows/virtio/common/tests/CMakeLists.txt'

          if (!$hasWin7VirtioCommon -and !$hasPortableVirtqSplit) {
            Write-Host "No virtio host tests found; skipping."
            exit 0
          }

          # Validate both architectures (x86 + x64) without requiring any VM.
          cmake -S . -B build-virtio-common-x64 -A x64 -DAERO_VIRTIO_BUILD_TESTS=ON
          cmake --build build-virtio-common-x64 --config Release
          ctest --test-dir build-virtio-common-x64 --output-on-failure -C Release

          cmake -S . -B build-virtio-common-x86 -A Win32 -DAERO_VIRTIO_BUILD_TESTS=ON
          cmake --build build-virtio-common-x86 --config Release
          ctest --test-dir build-virtio-common-x86 --output-on-failure -C Release

      - name: Detect driver projects
        id: detect
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $driversDir = Join-Path $env:GITHUB_WORKSPACE 'drivers'
          if (!(Test-Path -LiteralPath $driversDir)) {
            Write-Host "No drivers/ directory found; skipping Win7 driver build."
            "skip=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 0
          }

          $files = Get-ChildItem -LiteralPath $driversDir -Recurse -File -ErrorAction SilentlyContinue
          if (!$files) {
            Write-Host "drivers/ exists but is empty; skipping Win7 driver build."
            "skip=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 0
          }

          # Only run CI when we have *CI-buildable* driver projects.
          #
          # We intentionally ignore classic WDK 7.1 NMake wrapper projects that invoke build.exe
          # (Keyword=MakeFileProj / ConfigurationType=Makefile), because this workflow provisions
          # a modern Windows Kits toolchain and does not guarantee a WDK 7.1 build environment.
          #
          # Additionally, require an INF in the same directory tree so we only run when we can
          # generate catalogs + signed driver packages.
          $buildable = New-Object System.Collections.Generic.List[object]

          $vcxprojs = $files | Where-Object { $_.Extension -eq '.vcxproj' }
          foreach ($proj in $vcxprojs) {
            $content = Get-Content -LiteralPath $proj.FullName -Raw -ErrorAction SilentlyContinue
            if (-not $content) { continue }
            if ($content -match '<Keyword>\\s*MakeFileProj\\s*</Keyword>' -or $content -match '<ConfigurationType>\\s*Makefile\\s*</ConfigurationType>') {
              continue
            }

            $inf = Get-ChildItem -LiteralPath $proj.DirectoryName -Recurse -File -Filter '*.inf' -ErrorAction SilentlyContinue | Select-Object -First 1
            if (-not $inf) { continue }

            [void]$buildable.Add($proj.FullName)
          }

          if ($buildable.Count -eq 0) {
            Write-Host "No CI-buildable Win7 driver projects were found (expected MSBuild-based *.vcxproj with an .inf; ignoring WDK 7.1 NMake/build.exe wrappers). Skipping."
            "skip=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 0
          }

          Write-Host "Found $($buildable.Count) CI-buildable driver project(s); running Win7 driver build."
          "skip=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Prepare WDK download cache directory
        if: steps.detect.outputs.skip != 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          New-Item -ItemType Directory -Force -Path $env:WDK_DOWNLOAD_CACHE | Out-Null

      - name: Cache WDK downloads
        if: steps.detect.outputs.skip != 'true'
        uses: actions/cache@v4
        with:
          path: ${{ env.WDK_DOWNLOAD_CACHE }}
          key: wdk-download-${{ runner.os }}-${{ hashFiles('ci/install-wdk.ps1', 'ci/lib/Toolchain.psm1') }}
          restore-keys: |
            wdk-download-${{ runner.os }}-

      - name: Provision toolchain (ci/install-wdk.ps1)
        if: steps.detect.outputs.skip != 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (!(Test-Path -LiteralPath 'ci\install-wdk.ps1')) {
            throw "Expected script ci\install-wdk.ps1 to exist."
          }
          pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci\install-wdk.ps1'

      - name: Build drivers (ci/build-drivers.ps1)
        if: steps.detect.outputs.skip != 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (!(Test-Path -LiteralPath 'ci\build-drivers.ps1')) {
            throw "Expected script ci\build-drivers.ps1 to exist."
          }
          pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci\build-drivers.ps1' -ToolchainJson 'out\toolchain.json'

      - name: Detect built driver binaries
        id: built
        if: steps.detect.outputs.skip != 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $outDrivers = Join-Path $env:GITHUB_WORKSPACE 'out\drivers'
          if (!(Test-Path -LiteralPath $outDrivers)) {
            Write-Host "No out/drivers/ directory produced by build step; skipping catalog/sign/package."
            "has_sys=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 0
          }

          $sys = Get-ChildItem -LiteralPath $outDrivers -Recurse -File -Filter '*.sys' -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $sys) {
            Write-Host "No .sys files found under out/drivers/; skipping catalog/sign/package."
            "has_sys=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 0
          }

          Write-Host "Found driver binary: $($sys.FullName)"
          "has_sys=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Generate catalogs (ci/make-catalogs.ps1)
        if: steps.detect.outputs.skip != 'true' && steps.built.outputs.has_sys == 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (!(Test-Path -LiteralPath 'ci\make-catalogs.ps1')) {
            throw "Expected script ci\make-catalogs.ps1 to exist."
          }
          pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci\make-catalogs.ps1' -ToolchainJson 'out\toolchain.json'

      - name: Test-sign drivers (ci/sign-drivers.ps1)
        if: steps.detect.outputs.skip != 'true' && steps.built.outputs.has_sys == 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (!(Test-Path -LiteralPath 'ci\sign-drivers.ps1')) {
            throw "Expected script ci\sign-drivers.ps1 to exist."
          }
          pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci\sign-drivers.ps1' -ToolchainJson 'out\toolchain.json'

      - name: Upload signed packages (out/packages + aero-test.cer)
        if: steps.detect.outputs.skip != 'true' && steps.built.outputs.has_sys == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: win7-drivers-signed-packages
          path: |
            out/packages/**
            out/certs/aero-test.cer
          if-no-files-found: error

      - name: Package artifacts (ci/package-drivers.ps1)
        if: steps.detect.outputs.skip != 'true' && steps.built.outputs.has_sys == 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (!(Test-Path -LiteralPath 'ci\package-drivers.ps1')) {
            throw "Expected script ci\package-drivers.ps1 to exist."
          }
          pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci\package-drivers.ps1' -MakeFatImage

      - name: Upload artifacts (out/artifacts/)
        if: steps.detect.outputs.skip != 'true' && steps.built.outputs.has_sys == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: win7-drivers
          path: out/artifacts/
          if-no-files-found: error

  guest-tools:
    name: Guest Tools (ISO + zip)
    runs-on: ubuntu-latest
    needs: drivers-win7
    if: needs.drivers-win7.outputs.skip != 'true' && needs.drivers-win7.outputs.has_sys == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Version stamping derives from git tags/commits; fetch full history + tags so
          # `git describe` and commit-distance calculations are accurate.
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Rust (for aero_packager)
        uses: ./.github/actions/setup-rust
        with:
          toolchain: stable
          cache: false
          locked: auto

      - name: Download signed packages
        uses: actions/download-artifact@v4
        with:
          name: win7-drivers-signed-packages
          path: .

      - name: Package Guest Tools (ci/package-guest-tools.ps1)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          if (!(Test-Path -LiteralPath 'ci/package-guest-tools.ps1')) {
            throw "Expected script ci/package-guest-tools.ps1 to exist."
          }
          if (!(Test-Path -LiteralPath 'out/packages')) {
            throw "Expected signed driver packages at out/packages (download artifact step may have failed)."
          }
          if (!(Test-Path -LiteralPath 'out/certs/aero-test.cer')) {
            throw "Expected signing cert at out/certs/aero-test.cer (download artifact step may have failed)."
          }

          pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci/package-guest-tools.ps1' `
            -InputRoot 'out/packages' `
            -CertPath 'out/certs/aero-test.cer' `
            -OutDir 'out/guest-tools'

      - name: Verify Guest Tools outputs
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          foreach ($path in @(
            'out/guest-tools/aero-guest-tools.iso',
            'out/guest-tools/aero-guest-tools.zip',
            'out/guest-tools/aero-guest-tools.manifest.json'
          )) {
            if (!(Test-Path -LiteralPath $path)) {
              throw "Missing expected Guest Tools output: $path"
            }
          }

      - name: Upload Guest Tools artifacts
        uses: actions/upload-artifact@v4
        with:
          name: aero-guest-tools
          path: |
            out/guest-tools/aero-guest-tools.iso
            out/guest-tools/aero-guest-tools.zip
            out/guest-tools/aero-guest-tools.manifest.json
          if-no-files-found: error
