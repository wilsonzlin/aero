name: Win7 Drivers (build + catalog + test-sign)

on:
  pull_request:
    paths:
      - "drivers/**"
      - "ci/**"
      - ".github/workflows/drivers-win7.yml"
  push:
    branches:
      - main
    paths:
      - "drivers/**"
      - "ci/**"
      - ".github/workflows/drivers-win7.yml"
  workflow_dispatch:

jobs:
  drivers-win7:
    runs-on: windows-latest
    env:
      # Cache only the installer/downloads (not the installed WDK toolchain).
      WDK_DOWNLOAD_CACHE: C:\wdk-download-cache
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Version stamping derives from git tags/commits; fetch full history + tags so
          # `git describe` and commit-distance calculations are accurate.
          fetch-depth: 0
          fetch-tags: true

      - name: Detect driver projects
        id: detect
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $driversDir = Join-Path $env:GITHUB_WORKSPACE 'drivers'
          if (!(Test-Path -LiteralPath $driversDir)) {
            Write-Host "No drivers/ directory found; skipping Win7 driver build."
            "skip=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 0
          }

          $files = Get-ChildItem -LiteralPath $driversDir -Recurse -File -ErrorAction SilentlyContinue
          if (!$files) {
            Write-Host "drivers/ exists but is empty; skipping Win7 driver build."
            "skip=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 0
          }

          # Heuristic marker files that indicate "this repo actually has buildable driver projects".
          # Keep this aligned with ci/build-drivers.ps1 discovery conventions (solution/project files),
          # so we don't run expensive toolchain setup if there is nothing we can build.
          $markerFiles = $files | Where-Object {
            $_.Extension -in @('.sln', '.vcxproj')
          }

          if (@($markerFiles).Count -eq 0) {
            Write-Host "drivers/ contains files, but no driver project markers (*.sln, *.vcxproj) were found; skipping Win7 driver build."
            "skip=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 0
          }

          Write-Host "Found $(@($markerFiles).Count) driver project marker file(s); running Win7 driver build."
          "skip=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Prepare WDK download cache directory
        if: steps.detect.outputs.skip != 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          New-Item -ItemType Directory -Force -Path $env:WDK_DOWNLOAD_CACHE | Out-Null

      - name: Cache WDK downloads
        if: steps.detect.outputs.skip != 'true'
        uses: actions/cache@v4
        with:
          path: ${{ env.WDK_DOWNLOAD_CACHE }}
          key: wdk-download-${{ runner.os }}-${{ hashFiles('ci/install-wdk.ps1', 'ci/lib/Toolchain.psm1') }}
          restore-keys: |
            wdk-download-${{ runner.os }}-

      - name: Provision toolchain (ci/install-wdk.ps1)
        if: steps.detect.outputs.skip != 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (!(Test-Path -LiteralPath 'ci\install-wdk.ps1')) {
            throw "Expected script ci\install-wdk.ps1 to exist."
          }
          pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci\install-wdk.ps1'

      - name: Build drivers (ci/build-drivers.ps1)
        if: steps.detect.outputs.skip != 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (!(Test-Path -LiteralPath 'ci\build-drivers.ps1')) {
            throw "Expected script ci\build-drivers.ps1 to exist."
          }
          pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci\build-drivers.ps1' -ToolchainJson 'out\toolchain.json'

      - name: Detect built driver binaries
        id: built
        if: steps.detect.outputs.skip != 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $outDrivers = Join-Path $env:GITHUB_WORKSPACE 'out\drivers'
          if (!(Test-Path -LiteralPath $outDrivers)) {
            Write-Host "No out/drivers/ directory produced by build step; skipping catalog/sign/package."
            "has_sys=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 0
          }

          $sys = Get-ChildItem -LiteralPath $outDrivers -Recurse -File -Filter '*.sys' -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $sys) {
            Write-Host "No .sys files found under out/drivers/; skipping catalog/sign/package."
            "has_sys=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 0
          }

          Write-Host "Found driver binary: $($sys.FullName)"
          "has_sys=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Generate catalogs (ci/make-catalogs.ps1)
        if: steps.detect.outputs.skip != 'true' && steps.built.outputs.has_sys == 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (!(Test-Path -LiteralPath 'ci\make-catalogs.ps1')) {
            throw "Expected script ci\make-catalogs.ps1 to exist."
          }
          pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci\make-catalogs.ps1' -ToolchainJson 'out\toolchain.json'

      - name: Test-sign drivers (ci/sign-drivers.ps1)
        if: steps.detect.outputs.skip != 'true' && steps.built.outputs.has_sys == 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (!(Test-Path -LiteralPath 'ci\sign-drivers.ps1')) {
            throw "Expected script ci\sign-drivers.ps1 to exist."
          }
          pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci\sign-drivers.ps1' -ToolchainJson 'out\toolchain.json'

      - name: Package artifacts (ci/package-drivers.ps1)
        if: steps.detect.outputs.skip != 'true' && steps.built.outputs.has_sys == 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (!(Test-Path -LiteralPath 'ci\package-drivers.ps1')) {
            throw "Expected script ci\package-drivers.ps1 to exist."
          }
          pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci\package-drivers.ps1' -MakeFatImage

      - name: Upload artifacts (out/artifacts/)
        if: steps.detect.outputs.skip != 'true' && steps.built.outputs.has_sys == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: win7-drivers
          path: out/artifacts/
          if-no-files-found: error
