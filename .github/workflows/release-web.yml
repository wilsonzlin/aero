name: Release - web

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      ref:
        description: Git ref to build (branch, tag, or SHA). Leave blank to use the workflow ref.
        required: false
        default: ""
      tag:
        description: Optional release tag to upload assets to (e.g. v0.1.0). Leave blank to skip publishing a GitHub Release.
        required: false
        default: ""

permissions:
  contents: write

concurrency:
  group: release-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-web:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref != '' && inputs.ref || github.ref }}

      - name: Setup Node workspace
        uses: ./.github/actions/setup-node-workspace
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"

      - name: Check security header templates
        run: node scripts/ci/check-security-headers.mjs

      - name: Check pinned toolchains
        run: node scripts/ci/check-toolchains.mjs

      - name: Setup Rust (pinned stable)
        uses: ./.github/actions/setup-rust
        with:
          toolchain: stable
          targets: wasm32-unknown-unknown
          cache: false
          locked: always

      - name: Setup Rust (pinned nightly for threaded WASM)
        uses: ./.github/actions/setup-rust
        with:
          toolchain: nightly
          targets: wasm32-unknown-unknown
          components: rust-src
          cache: false
          locked: always

      - name: Install wasm-pack
        uses: taiki-e/install-action@v2
        with:
          tool: wasm-pack

      - name: Install wasm-opt (Binaryen)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y binaryen

      - name: Compute build metadata
        shell: bash
        env:
          TAG_INPUT: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || '' }}
          REF_INPUT: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || '' }}
        run: |
          set -euo pipefail

          echo "BUILD_TIMESTAMP=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> "$GITHUB_ENV"
          # Always derive the SHA from the checked-out ref (workflow_dispatch may override ref).
          echo "GIT_SHA=$(git rev-parse HEAD)" >> "$GITHUB_ENV"

          ref_label="${REF_INPUT}"
          if [[ -n "${ref_label}" ]]; then
            if [[ "${ref_label}" == refs/tags/* ]]; then
              ref_label="${ref_label#refs/tags/}"
            elif [[ "${ref_label}" == refs/heads/* ]]; then
              ref_label="${ref_label#refs/heads/}"
            fi
            # Keep artifact names filesystem-friendly.
            ref_label="${ref_label//\//-}"
            if [[ "${ref_label}" =~ ^[0-9a-fA-F]{40}$ ]]; then
              ref_label="${ref_label:0:12}"
            fi
          fi

          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            version="${GITHUB_REF_NAME}"
            release_tag="${GITHUB_REF_NAME}"
          elif [[ -n "${TAG_INPUT}" ]]; then
            version="${TAG_INPUT}"
            release_tag="${TAG_INPUT}"
          elif [[ -n "${ref_label}" ]]; then
            version="${ref_label}"
            release_tag=""
          else
            version="${GITHUB_REF_NAME}"
            release_tag=""
          fi

          # Keep artifact filenames safe (Git refs like "feature/foo" would otherwise create a nested path).
          version="${version//\//-}"

          echo "AERO_VERSION=${version}" >> "$GITHUB_ENV"
          echo "RELEASE_TAG=${release_tag}" >> "$GITHUB_ENV"

      - name: Build (WASM + web)
        run: npm run build:prod

      - name: Validate build output
        shell: bash
        run: |
          set -euo pipefail

          test -f dist/_headers
          test -f dist/aero.version.json

          node -e "const fs=require('fs'); const info=JSON.parse(fs.readFileSync('dist/aero.version.json','utf8')); const expected={version:process.env.AERO_VERSION,gitSha:process.env.GIT_SHA,builtAt:process.env.BUILD_TIMESTAMP}; for(const [k,v] of Object.entries(expected)){ if(!v){ console.error('Missing expected env '+k); process.exit(1);} if(info[k]!==v){ console.error('aero.version.json '+k+' mismatch: expected '+v+' got '+info[k]); process.exit(1);} }"

          # Ensure both wasm build variants were produced (threaded + single fallback).
          test -f web/src/wasm/pkg-single/aero_wasm_bg.wasm
          test -f web/src/wasm/pkg-threaded/aero_wasm_bg.wasm

          variant_count="$(find dist -name 'aero_wasm_bg*.wasm' | wc -l | tr -d '[:space:]')"
          if [[ "${variant_count}" -lt 2 ]]; then
            echo "Expected both WASM variants to be present in the dist bundle (aero_wasm_bg*.wasm). Found: ${variant_count}" >&2
            find dist -name 'aero_wasm_bg*.wasm' -print >&2 || true
            exit 1
          fi

          wasm_count="$(find dist -name '*.wasm' | wc -l | tr -d '[:space:]')"
          if [[ "${wasm_count}" -lt 2 ]]; then
            echo "Expected at least 2 .wasm files in dist (single + threaded), found: ${wasm_count}" >&2
            find dist -name '*.wasm' -print >&2 || true
            exit 1
          fi

      - name: Package dist
        id: package
        shell: bash
        run: |
          set -euo pipefail

          artifact="aero-web-${AERO_VERSION}.zip"
          (cd dist && zip -r "../${artifact}" .)
          sha256sum "${artifact}" > "${artifact}.sha256"

          echo "artifact=${artifact}" >> "$GITHUB_OUTPUT"

      - name: Upload build artifact (workflow)
        uses: actions/upload-artifact@v4
        with:
          name: aero-web-dist-${{ env.AERO_VERSION }}
          path: |
            ${{ steps.package.outputs.artifact }}
            ${{ steps.package.outputs.artifact }}.sha256
          if-no-files-found: error
          retention-days: 7

      - name: Publish GitHub Release asset
        if: env.RELEASE_TAG != ''
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          files: |
            ${{ steps.package.outputs.artifact }}
            ${{ steps.package.outputs.artifact }}.sha256
          generate_release_notes: true
