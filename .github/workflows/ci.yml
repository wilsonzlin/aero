name: CI

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:
  merge_group:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: "1"
  # PR CI should never require WebGPU.
  AERO_REQUIRE_WEBGPU: "0"
  AERO_WASM_CRATE_DIR: ${{ vars.AERO_WASM_CRATE_DIR }}

jobs:
  policy:
    name: Repo policy (fixtures & binaries)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      code_changed: ${{ steps.changes.outputs.code_changed }}
      docs_only: ${{ steps.changes.outputs.docs_only }}
    env:
      BASE_REF: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.sha || github.event_name == 'merge_group' && github.event.merge_group.base_sha || github.event.before }}
      HEAD_REF: ${{ github.event_name == 'merge_group' && github.event.merge_group.head_sha || github.sha }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect docs-only changes
        id: changes
        shell: bash
        run: |
          set -euo pipefail

          base="$BASE_REF"
          head="$HEAD_REF"

          # `github.event.before` can be all zeros in some edge cases (e.g. branch creation).
          # Fall back to full CI rather than skipping checks.
          if [[ -z "${base:-}" || "$base" == "0000000000000000000000000000000000000000" ]]; then
            echo "code_changed=true" >> "$GITHUB_OUTPUT"
            echo "docs_only=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          files="$(git diff --name-only "$base" "$head")"
          echo "Changed files:";
          echo "$files"

          code_changed=false
          while IFS= read -r file; do
            [[ -z "$file" ]] && continue
            if [[ "$file" != docs/* && "$file" != *.md ]]; then
              code_changed=true
              break
            fi
          done <<< "$files"

          echo "code_changed=$code_changed" >> "$GITHUB_OUTPUT"
          if [[ "$code_changed" == "true" ]]; then
            echo "docs_only=false" >> "$GITHUB_OUTPUT"
          else
            echo "docs_only=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Change filter summary
        if: always()
        shell: bash
        run: |
          {
            echo "### CI change filter"
            echo ""
            echo "- Docs-only: \`${{ steps.changes.outputs.docs_only }}\`"
            echo "- Code changed: \`${{ steps.changes.outputs.code_changed }}\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Check repository policy
        run: scripts/ci/check-repo-policy.sh

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc

      - name: Check security header templates
        run: node scripts/ci/check-security-headers.mjs

      - name: Check repository layout
        run: scripts/ci/check-repo-layout.sh

      - name: Check Node workflow pinning
        run: node scripts/ci/check-node-workflows.mjs

      - name: Check Rust workflow policy (setup-rust)
        run: scripts/ci/check-rust-workflows.sh

  toolchains:
    name: Toolchain policy (pinned stable + pinned nightly)
    needs: policy
    if: needs.policy.result == 'success' && needs.policy.outputs.code_changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc

      - name: Check pinned Rust toolchains
        run: node scripts/ci/check-toolchains.mjs

  wasm-threaded:
    name: WASM (threaded smoke build)
    needs: policy
    if: needs.policy.result == 'success' && needs.policy.outputs.code_changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc

      - name: Setup Rust (pinned nightly for threaded WASM)
        uses: ./.github/actions/setup-rust
        with:
          toolchain: nightly
          targets: wasm32-unknown-unknown
          components: rust-src
          locked: always

      - name: Install wasm-pack
        uses: jetli/wasm-pack-action@v0.4.0

      - name: Threaded WASM build (dev, smoke)
        run: cargo xtask wasm threaded dev

  rust:
    name: Rust (fmt, clippy, test)
    needs: policy
    if: needs.policy.result == 'success' && needs.policy.outputs.code_changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        id: setup-rust
        uses: ./.github/actions/setup-rust
        with:
          toolchain: stable
          components: rustfmt, clippy
          targets: wasm32-unknown-unknown
          locked: always

      - name: Verify Cargo.lock files are present and in sync
        run: |
          set -euo pipefail
          # Use `cargo metadata --locked` as the drift check.
          #
          # Note: `cargo generate-lockfile` is an updater (like `cargo update`) and will
          # intentionally re-resolve to the latest compatible versions. Using it with
          # `--locked` can make CI flaky when crates are published between runs.
          cargo metadata ${{ steps.setup-rust.outputs.cargo_locked_flag }} --format-version 1 >/dev/null
          cargo metadata ${{ steps.setup-rust.outputs.cargo_locked_flag }} --format-version 1 --manifest-path tools/packaging/aero_packager/Cargo.toml >/dev/null
          cargo metadata ${{ steps.setup-rust.outputs.cargo_locked_flag }} --format-version 1 --manifest-path server/disk-gateway/Cargo.toml >/dev/null

      - name: Prepare net traces dir
        run: mkdir -p target/net-traces
      - name: Generate test fixtures
        run: cargo run ${{ steps.setup-rust.outputs.cargo_locked_flag }} -p xtask -- fixtures

      - name: Ensure fixtures are checked in (determinism)
        run: git diff --exit-code -- tests/fixtures/boot

      - name: cargo fmt
        run: cargo fmt --all -- --check

      - name: cargo clippy
        run: cargo clippy ${{ steps.setup-rust.outputs.cargo_locked_flag }} --workspace --all-targets --all-features -- -D warnings

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: nextest

      - name: Prepare test-results directory
        run: mkdir -p test-results

      - name: cargo nextest (workspace)
        run: cargo nextest run ${{ steps.setup-rust.outputs.cargo_locked_flag }} --workspace --all-features --exclude aero-storage-server --junit-path test-results/rust-workspace.xml

      - name: cargo test (doc tests)
        run: cargo test ${{ steps.setup-rust.outputs.cargo_locked_flag }} --workspace --all-features --doc

      - name: cargo nextest (guest tools packager)
        run: cargo nextest run --manifest-path tools/packaging/aero_packager/Cargo.toml --locked --junit-path test-results/rust-aero-packager.xml

      - name: cargo nextest (disk-gateway reference server)
        run: cargo nextest run --manifest-path server/disk-gateway/Cargo.toml --locked --junit-path test-results/rust-disk-gateway.xml

      - name: cargo nextest (aero-storage-server)
        run: cargo nextest run ${{ steps.setup-rust.outputs.cargo_locked_flag }} -p aero-storage-server --all-features --junit-path test-results/rust-aero-storage-server.xml

      - name: Publish Rust test report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Rust tests
          path: test-results/rust-*.xml
          reporter: java-junit
          fail-on-error: false

      - name: Upload Rust test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rust-test-results
          path: test-results/rust-*.xml
          if-no-files-found: warn
          retention-days: 7

      - name: Upload net traces
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: net-traces
          path: target/net-traces
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload network captures (pcapng)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: net-captures
          path: target/nt-test-artifacts/**/*.pcapng
          if-no-files-found: ignore
          retention-days: 7

      - name: Rust job summary
        if: always()
        shell: bash
        run: |
          {
            echo "### Rust test reports"
            echo ""
            echo "- JUnit: \`test-results/rust-*.xml\`"
            echo "- Artifact: \`rust-test-results\`"
            echo ""
            echo "Network artifacts (only on failure):"
            echo "- \`net-traces\`"
            echo "- \`net-captures\`"
          } >> "$GITHUB_STEP_SUMMARY"

  acpi-iasl:
    name: ACPI (iasl)
    needs: policy
    if: needs.policy.result == 'success' && needs.policy.outputs.code_changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Install ACPICA tools (iasl)
        run: |
          sudo apt-get update
          sudo apt-get install -y acpica-tools

      - name: Validate ACPI tables (decompile + compile)
        run: bash scripts/validate-acpi.sh

  win7-virtio-portable-tests:
    name: Win7 virtio (portable tests)
    needs: policy
    if: needs.policy.result == 'success' && needs.policy.outputs.code_changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: Build + run virtio-pci cap parser tests
        run: |
          set -euo pipefail
          ./drivers/win7/virtio/tests/build_and_run.sh
          if command -v clang >/dev/null 2>&1; then
            CC=clang ./drivers/win7/virtio/tests/build_and_run.sh
          fi
  qemu-boot:
    name: QEMU boot tests (boot sector + FreeDOS)
    needs: policy
    if: needs.policy.result == 'success' && needs.policy.outputs.code_changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      AERO_REQUIRE_TEST_IMAGES: "1"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        id: setup-rust
        uses: ./.github/actions/setup-rust
        with:
          toolchain: stable
          locked: always

      - name: Install QEMU + tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86 mtools nasm unzip

      - name: Prepare open-source test images
        run: bash scripts/prepare-freedos.sh

      - name: Verify boot sector binary is up-to-date
        run: |
          bash scripts/build-bootsector.sh
          bash scripts/build-int-sanity-bootsector.sh
          git diff --exit-code

      - name: Run QEMU boot tests
        run: cargo test ${{ steps.setup-rust.outputs.cargo_locked_flag }} -p emulator --test boot_sector --test freedos_boot

  wasm:
    name: WASM (wasm-pack build + test)
    needs: policy
    if: needs.policy.result == 'success' && needs.policy.outputs.code_changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        id: setup-rust
        uses: ./.github/actions/setup-rust
        with:
          toolchain: stable
          targets: wasm32-unknown-unknown
          locked: always

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc

      - name: Resolve wasm crate
        id: wasm-crate
        uses: ./.github/actions/resolve-wasm-crate
        with:
          install-wasm-pack: "true"

      - name: wasm-pack build (single, release)
        run: cargo xtask wasm single release

      - name: wasm-pack test (node)
        run: cargo run ${{ steps.setup-rust.outputs.cargo_locked_flag }} -p xtask -- test-all --skip-rust --skip-ts --skip-e2e --wasm-crate-dir "${{ steps.wasm-crate.outputs.dir }}"

      - name: Upload wasm-pack output (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: wasm-pack-pkg
          path: |
            web/src/wasm/pkg-single/
            ${{ steps.wasm-crate.outputs.dir }}/pkg/
          if-no-files-found: ignore
          retention-days: 7

  node-unit:
    name: Node (lint, unit, build)
    needs: policy
    if: needs.policy.result == 'success' && needs.policy.outputs.code_changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node workspace
        id: node-workspace
        uses: ./.github/actions/setup-node-workspace
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"

      - name: Lint (if present)
        working-directory: ${{ steps.node-workspace.outputs.dir }}
        run: npm run lint --if-present

      - name: Unit tests
        working-directory: ${{ steps.node-workspace.outputs.dir }}
        run: npm run test:unit

      - name: Publish Node unit test report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Node unit tests
          path: ${{ steps.node-workspace.outputs.dir }}/test-results/node-junit.xml
          reporter: java-junit
          fail-on-error: false

      - name: Publish Vitest report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Vitest
          path: ${{ steps.node-workspace.outputs.dir }}/test-results/vitest-junit.xml
          reporter: java-junit
          fail-on-error: false

      - name: Upload unit test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: |
            ${{ steps.node-workspace.outputs.dir }}/test-results/node-junit.xml
            ${{ steps.node-workspace.outputs.dir }}/test-results/vitest-junit.xml
          if-no-files-found: warn
          retention-days: 7

      - name: Node unit job summary
        if: always()
        shell: bash
        run: |
          {
            echo "### Unit test reports"
            echo ""
            echo "- Node JUnit: \`${{ steps.node-workspace.outputs.dir }}/test-results/node-junit.xml\`"
            echo "- Vitest JUnit: \`${{ steps.node-workspace.outputs.dir }}/test-results/vitest-junit.xml\`"
            echo "- Artifact: \`unit-test-results\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Production build
        working-directory: ${{ steps.node-workspace.outputs.dir }}
        run: npm run build

  smoke-matrix:
    name: Smoke matrix (${{ matrix.os }})
    needs: policy
    if: needs.policy.result == 'success' && needs.policy.outputs.code_changed == 'true'
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
          - macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        id: setup-rust
        uses: ./.github/actions/setup-rust
        with:
          toolchain: stable
          locked: always

      - name: cargo build
        run: cargo build ${{ steps.setup-rust.outputs.cargo_locked_flag }} --workspace

      - name: Build offline cert injector (Windows)
        if: matrix.os == 'windows-latest'
        run: cargo build --manifest-path tools/win-offline-cert-injector/Cargo.toml --locked

      - name: Test offline cert injector (Windows)
        if: matrix.os == 'windows-latest'
        run: cargo test --manifest-path tools/win-offline-cert-injector/Cargo.toml --locked

      - name: Setup Node workspace
        id: node-workspace
        uses: ./.github/actions/setup-node-workspace
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"

      - name: Typecheck (if present)
        working-directory: ${{ steps.node-workspace.outputs.dir }}
        run: npm run typecheck --if-present

      - name: Unit tests
        working-directory: ${{ steps.node-workspace.outputs.dir }}
        run: npm run test:unit --if-present

      - name: Production build
        working-directory: ${{ steps.node-workspace.outputs.dir }}
        run: npm run build

      - name: Job summary
        if: always()
        shell: bash
        run: |
          {
            echo "### Smoke matrix (${{ matrix.os }})"
            echo ""
            echo "- Node dir: \\`${{ steps.node-workspace.outputs.dir }}\\`"
            echo "- Lockfile: \\`${{ steps.node-workspace.outputs.lockfile }}\\`"
          } >> "$GITHUB_STEP_SUMMARY"

  playwright:
    name: Playwright (browser automation)
    needs: policy
    if: needs.policy.result == 'success' && needs.policy.outputs.code_changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        id: setup-rust
        uses: ./.github/actions/setup-rust
        with:
          toolchain: stable
          targets: wasm32-unknown-unknown
          locked: always

      - name: Install wasm-pack
        uses: jetli/wasm-pack-action@v0.4.0

      - name: Setup Node workspace
        id: node-workspace
        uses: ./.github/actions/setup-node-workspace
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"

      - name: Prepare test-results directory
        working-directory: ${{ steps.node-workspace.outputs.dir }}
        run: mkdir -p test-results

      - name: Setup Playwright (cached)
        uses: ./.github/actions/setup-playwright
        with:
          browsers: chromium
          working-directory: ${{ steps.node-workspace.outputs.dir }}
          lockfile: ${{ steps.node-workspace.outputs.lockfile }}

      - name: Playwright tests (non-WebGPU)
        env:
          AERO_NODE_DIR: ${{ steps.node-workspace.outputs.dir }}
        run: cargo xtask test-all --skip-rust --skip-wasm --skip-ts --pw-project chromium

      - name: Publish E2E test report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Playwright
          path: ${{ steps.node-workspace.outputs.dir }}/test-results/junit.xml
          reporter: java-junit
          fail-on-error: false

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            ${{ steps.node-workspace.outputs.dir }}/playwright-report/
            ${{ steps.node-workspace.outputs.dir }}/test-results/
          if-no-files-found: warn
          retention-days: 7

      - name: Playwright job summary
        if: always()
        shell: bash
        run: |
          {
            echo "### Playwright reports"
            echo ""
            echo "- JUnit: \`${{ steps.node-workspace.outputs.dir }}/test-results/junit.xml\`"
            echo "- HTML report artifact: \`playwright-report\`"
          } >> "$GITHUB_STEP_SUMMARY"

  disk-streaming-browser-e2e:
    name: Disk streaming browser E2E (COOP/COEP + Range)
    needs: policy
    if: needs.policy.result == 'success' && needs.policy.outputs.code_changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          toolchain: stable
          locked: always

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Setup Playwright (cached)
        uses: ./.github/actions/setup-playwright
        with:
          browsers: chromium
          working-directory: tools/disk-streaming-browser-e2e
          lockfile: package-lock.json

      - name: Run disk streaming browser E2E tests
        run: npm -w tools/disk-streaming-browser-e2e test

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: disk-streaming-browser-e2e-report
          path: |
            tools/disk-streaming-browser-e2e/playwright-report/
            tools/disk-streaming-browser-e2e/test-results/
          if-no-files-found: warn
          retention-days: 7

  ci-gate:
    name: CI gate
    needs:
      - policy
      - toolchains
      - wasm-threaded
      - rust
      - acpi-iasl
      - win7-virtio-portable-tests
      - qemu-boot
      - wasm
      - node-unit
      - smoke-matrix
      - playwright
      - disk-streaming-browser-e2e
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Evaluate CI results
        shell: bash
        run: |
          set -euo pipefail

          echo "policy: ${{ needs.policy.result }}"
          echo "code_changed: ${{ needs.policy.outputs.code_changed }}"
          echo "docs_only: ${{ needs.policy.outputs.docs_only }}"

          if [[ "${{ needs.policy.result }}" != "success" ]]; then
            echo "::error::policy job failed"
            exit 1
          fi

          if [[ "${{ needs.policy.outputs.code_changed }}" != "true" ]]; then
            echo "Docs-only change; skipping expensive build/test jobs."
            exit 0
          fi

          failures=0

          if [[ "${{ needs.toolchains.result }}" != "success" ]]; then
            echo "::error::toolchains job result: ${{ needs.toolchains.result }}"
            failures=1
          fi

          if [[ "${{ needs['wasm-threaded'].result }}" != "success" ]]; then
            echo "::error::wasm-threaded job result: ${{ needs['wasm-threaded'].result }}"
            failures=1
          fi

          if [[ "${{ needs.rust.result }}" != "success" ]]; then
            echo "::error::rust job result: ${{ needs.rust.result }}"
            failures=1
          fi

          if [[ "${{ needs['acpi-iasl'].result }}" != "success" ]]; then
            echo "::error::acpi-iasl job result: ${{ needs['acpi-iasl'].result }}"
            failures=1
          fi

          if [[ "${{ needs['win7-virtio-portable-tests'].result }}" != "success" ]]; then
            echo "::error::win7-virtio-portable-tests job result: ${{ needs['win7-virtio-portable-tests'].result }}"
            failures=1
          fi

          if [[ "${{ needs['qemu-boot'].result }}" != "success" ]]; then
            echo "::error::qemu-boot job result: ${{ needs['qemu-boot'].result }}"
            failures=1
          fi

          if [[ "${{ needs.wasm.result }}" != "success" ]]; then
            echo "::error::wasm job result: ${{ needs.wasm.result }}"
            failures=1
          fi

          if [[ "${{ needs['node-unit'].result }}" != "success" ]]; then
            echo "::error::node-unit job result: ${{ needs['node-unit'].result }}"
            failures=1
          fi

          if [[ "${{ needs['smoke-matrix'].result }}" != "success" ]]; then
            echo "::error::smoke-matrix job result: ${{ needs['smoke-matrix'].result }}"
            failures=1
          fi

          if [[ "${{ needs.playwright.result }}" != "success" ]]; then
            echo "::error::playwright job result: ${{ needs.playwright.result }}"
            failures=1
          fi

          if [[ "${{ needs['disk-streaming-browser-e2e'].result }}" != "success" ]]; then
            echo "::error::disk-streaming-browser-e2e job result: ${{ needs['disk-streaming-browser-e2e'].result }}"
            failures=1
          fi

          exit "$failures"
