name: GPU Perf (smoke)

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths-ignore:
      - "docs/**"
      - "**/*.md"

permissions:
  contents: read

concurrency:
  group: gpu-perf-smoke-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  gpu-perf-smoke:
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    env:
      GPU_PERF_ITERATIONS: "3"
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"
    steps:
      - name: Checkout (candidate)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: head

      - name: Checkout (baseline)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.base.sha }}
          path: base

      - name: Setup Node workspace (candidate)
        id: node-workspace-head
        uses: ./base/.github/actions/setup-node-workspace
        with:
          working-directory: head

      - name: Setup Node workspace (baseline)
        id: node-workspace-base
        uses: ./base/.github/actions/setup-node-workspace
        with:
          working-directory: base

      - name: Setup Playwright (cached)
        uses: ./base/.github/actions/setup-playwright
        with:
          browsers: chromium
          working-directory: ${{ steps.node-workspace-head.outputs.dir }}
          lockfile: ${{ steps.node-workspace-head.outputs.lockfile }}

      - name: Setup Playwright (cached, baseline)
        uses: ./head/.github/actions/setup-playwright
        with:
          browsers: chromium
          working-directory: ${{ steps.node-workspace-base.outputs.dir }}
          # Use the candidate lockfile for caching so we restore once per job (the baseline
          # invocation will still install any additional browser revisions it needs).
          lockfile: ${{ steps.node-workspace-head.outputs.lockfile }}

      - name: Write scenario params
        working-directory: ${{ steps.node-workspace-head.outputs.dir }}
        run: |
          mkdir -p gpu-perf-results/{base,head,compare}
          cat > gpu-perf-results/scenario_params.json <<'JSON'
          {
            "vga_text_scroll": { "frames": 120 },
            "vbe_lfb_blit": { "frames": 60, "width": 256, "height": 256 }
          }
          JSON

      - name: Run GPU perf (baseline)
        working-directory: ${{ steps.node-workspace-base.outputs.dir }}
        run: |
          node --experimental-strip-types bench/gpu_bench.ts \
            --scenarios vga_text_scroll,vbe_lfb_blit \
            --scenario-params "$GITHUB_WORKSPACE/${{ steps.node-workspace-head.outputs.dir }}/gpu-perf-results/scenario_params.json" \
            --swiftshader true \
            --iterations ${{ env.GPU_PERF_ITERATIONS }} \
            --output "$GITHUB_WORKSPACE/${{ steps.node-workspace-head.outputs.dir }}/gpu-perf-results/base/gpu_bench.json"

      - name: Run GPU perf (candidate)
        working-directory: ${{ steps.node-workspace-head.outputs.dir }}
        run: |
          node --experimental-strip-types bench/gpu_bench.ts \
            --scenarios vga_text_scroll,vbe_lfb_blit \
            --scenario-params gpu-perf-results/scenario_params.json \
            --swiftshader true \
            --iterations ${{ env.GPU_PERF_ITERATIONS }} \
            --output gpu-perf-results/head/gpu_bench.json

      - name: Compare GPU perf (job summary)
        working-directory: ${{ steps.node-workspace-head.outputs.dir }}
        run: |
          set +e
          node --experimental-strip-types scripts/compare_gpu_benchmarks.ts \
            --baseline gpu-perf-results/base/gpu_bench.json \
            --candidate gpu-perf-results/head/gpu_bench.json \
            --out-dir gpu-perf-results/compare \
            --thresholds-file bench/perf_thresholds.json \
            --profile pr-smoke
          status=$?
          if [[ -f gpu-perf-results/compare/compare.md ]]; then
            cat gpu-perf-results/compare/compare.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No GPU perf comparison produced (compare.md missing)." >> "$GITHUB_STEP_SUMMARY"
          fi
          exit $status

      - name: Upload GPU perf artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gpu-perf-smoke-${{ github.run_id }}
          path: ${{ steps.node-workspace-head.outputs.dir }}/gpu-perf-results
          if-no-files-found: error
