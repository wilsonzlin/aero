name: GPU Perf (smoke)

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths-ignore:
      - "docs/**"
      - "**/*.md"

permissions:
  contents: read

concurrency:
  group: gpu-perf-smoke-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  gpu-perf-smoke:
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    env:
      GPU_PERF_ITERATIONS: "3"
      GPU_PERF_REGRESSION_THRESHOLD_PCT: ${{ vars.GPU_PERF_REGRESSION_THRESHOLD_PCT }}
      GPU_PERF_EXTREME_CV_THRESHOLD: ${{ vars.GPU_PERF_EXTREME_CV_THRESHOLD }}
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"
      AERO_NODE_DIR: ${{ vars.AERO_NODE_DIR }}
    steps:
      - name: Checkout (candidate)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          path: head

      - name: Checkout (baseline)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.base.sha }}
          path: base

      - name: Setup Node workspace (candidate)
        id: node-workspace-head
        uses: ./base/.github/actions/setup-node-workspace
        with:
          working-directory: head

      - name: Setup Node workspace (baseline)
        id: node-workspace-base
        uses: ./base/.github/actions/setup-node-workspace
        with:
          working-directory: base

      - name: Setup Playwright (cached)
        uses: ./base/.github/actions/setup-playwright
        with:
          browsers: chromium
          working-directory: head
          lockfile: ${{ steps.node-workspace-head.outputs.lockfile }}

      - name: Setup Playwright (cached, baseline)
        uses: ./base/.github/actions/setup-playwright
        with:
          browsers: chromium
          working-directory: base
          lockfile: ${{ steps.node-workspace-base.outputs.lockfile }}

      - name: Write scenario params
        working-directory: head
        run: |
          mkdir -p gpu-perf-results/{base,head,compare}
          cat > gpu-perf-results/scenario_params.json <<'JSON'
          {
            "vga_text_scroll": { "frames": 120 },
            "vbe_lfb_blit": { "frames": 60, "width": 256, "height": 256 }
          }
          JSON

      - name: Run GPU perf (baseline)
        working-directory: base
        run: |
          node --experimental-strip-types bench/gpu_bench.ts \
            --scenarios vga_text_scroll,vbe_lfb_blit \
            --scenario-params "$GITHUB_WORKSPACE/head/gpu-perf-results/scenario_params.json" \
            --swiftshader true \
            --iterations ${{ env.GPU_PERF_ITERATIONS }} \
            --output "$GITHUB_WORKSPACE/head/gpu-perf-results/base/gpu_bench.json"

      - name: Run GPU perf (candidate)
        working-directory: head
        run: |
          node --experimental-strip-types bench/gpu_bench.ts \
            --scenarios vga_text_scroll,vbe_lfb_blit \
            --scenario-params gpu-perf-results/scenario_params.json \
            --swiftshader true \
            --iterations ${{ env.GPU_PERF_ITERATIONS }} \
            --output gpu-perf-results/head/gpu_bench.json

      - name: Compare GPU perf (job summary)
        working-directory: head
        run: |
          set +e
          node --experimental-strip-types scripts/compare_gpu_benchmarks.ts \
            --baseline gpu-perf-results/base/gpu_bench.json \
            --candidate gpu-perf-results/head/gpu_bench.json \
            --out-dir gpu-perf-results/compare \
            --thresholds-file bench/perf_thresholds.json \
            --profile pr-smoke
          status=$?
          if [[ -f gpu-perf-results/compare/compare.md ]]; then
            cat gpu-perf-results/compare/compare.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No GPU perf comparison produced (compare.md missing)." >> "$GITHUB_STEP_SUMMARY"
          fi
          exit $status

      - name: Upload GPU perf artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gpu-perf-smoke-${{ github.run_id }}
          path: head/gpu-perf-results
          if-no-files-found: error
          retention-days: 14

  gpu-perf-comment:
    name: PR comment (gpu perf smoke)
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    needs: [gpu-perf-smoke]
    if: always() && github.event.pull_request.head.repo.full_name == github.repository
    permissions:
      actions: read
      contents: read
      issues: write
    steps:
      - name: Download GPU perf artifacts
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: gpu-perf-smoke-${{ github.run_id }}
          path: gpu-perf-results

      - name: Comment on PR (summary)
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("node:fs");
            const path = require("node:path");

            const summaryPath = path.join(process.env.GITHUB_WORKSPACE, "gpu-perf-results", "compare", "summary.json");
            if (!fs.existsSync(summaryPath)) {
              core.warning(`GPU perf summary not found at ${summaryPath}; skipping PR comment.`);
              return;
            }

            const summary = JSON.parse(fs.readFileSync(summaryPath, "utf8"));
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;

            const fmtPct = (pct) => `${pct > 0 ? "+" : ""}${(pct * 100).toFixed(1)}%`;
            const fmtDelta = (n, unit) => `${n > 0 ? "+" : ""}${n.toFixed(1)}${unit ?? ""}`;

            const lines = [];
            lines.push("<!-- aero-gpu-perf-smoke -->");
            lines.push("### GPU perf (smoke)");
            lines.push("");
            lines.push(`Report + artifacts: ${runUrl}`);
            lines.push("");
            lines.push(`Baseline: \`${summary.baselineMeta?.gitSha ?? "unknown"}\``);
            lines.push(`Candidate: \`${summary.candidateMeta?.gitSha ?? "unknown"}\``);
            lines.push(`Policy: \`${summary.profile ?? "unknown"}\` (\`${summary.thresholdsFile ?? "unknown"}\`)`);
            lines.push(`Iterations: median-of-${summary.candidateMeta?.iterations ?? "?"}`);

            if (summary.status === "unstable") {
              const unstableCount = summary.summary?.unstable ?? 0;
              const missingCount = summary.summary?.missing ?? 0;
              const reasons = [];
              if (unstableCount > 0) reasons.push("extreme variance");
              if (missingCount > 0) reasons.push("missing metrics");

              lines.push("");
              lines.push(
                `Result: **Unstable**${
                  reasons.length ? ` (${reasons.join(" / ")}; see artifacts for details)` : " (see artifacts for details)"
                }`,
              );
            } else if (summary.status === "regression") {
              lines.push("");
              lines.push("Result: **Regression**");
            } else if (summary.status === "pass") {
              lines.push("");
              lines.push("Result: **No significant regressions**");
            }

            const bullets = [];
            const take = (arr) => (Array.isArray(arr) ? arr.slice(0, 5) : []);
            for (const r of take(summary.topRegressions)) {
              const label = `${r.scenario}.${r.metric}`;
              const unit = r.unit ? ` ${r.unit}` : "";
              const suffix = r.informational ? " _(info)_" : "";
              bullets.push(`- \`${label}\`: ${fmtPct(r.deltaPct)} (${fmtDelta(r.deltaAbs, unit)})${suffix}`);
            }
            if (bullets.length) {
              lines.push("");
              lines.push("Top regressions:");
              lines.push(...bullets);
            }

            const improvements = [];
            for (const r of take(summary.topImprovements)) {
              const label = `${r.scenario}.${r.metric}`;
              const unit = r.unit ? ` ${r.unit}` : "";
              const suffix = r.informational ? " _(info)_" : "";
              improvements.push(`- \`${label}\`: ${fmtPct(r.deltaPct)} (${fmtDelta(r.deltaAbs, unit)})${suffix}`);
            }
            if (improvements.length) {
              lines.push("");
              lines.push("Top improvements:");
              lines.push(...improvements);
            }

            const body = lines.join("\\n");

            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;

            const existing = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
              per_page: 100,
            });

            const marker = "<!-- aero-gpu-perf-smoke -->";
            const botLogin = "github-actions[bot]";
            const previous = existing.find(
              (c) => c.user?.login === botLogin && typeof c.body === "string" && c.body.includes(marker),
            );

            if (previous) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: previous.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            }
