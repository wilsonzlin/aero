name: Release Win7 drivers

on:
  push:
    tags:
      - "v*"

# Needed for creating/updating GitHub Releases and uploading release assets.
permissions:
  contents: write

jobs:
  build-sign-package:
    name: Build + catalog + sign + package
    runs-on: windows-2022
    env:
      # Cache only installer/download payloads (not the installed WDK itself).
      WDK_DOWNLOAD_CACHE: C:\wdk-download-cache
    steps:
      - uses: actions/checkout@v4
        with:
          # Needed for `git describe --tags` in INF stamping/version derivation.
          fetch-depth: 0

      - name: Prepare WDK download cache directory
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          New-Item -ItemType Directory -Force -Path $env:WDK_DOWNLOAD_CACHE | Out-Null

      - name: Cache WDK downloads
        uses: actions/cache@v4
        with:
          path: ${{ env.WDK_DOWNLOAD_CACHE }}
          key: wdk-download-${{ runner.os }}-${{ hashFiles('ci/install-wdk.ps1') }}
          restore-keys: |
            wdk-download-${{ runner.os }}-

      - name: Provision WDK toolchain (ci/install-wdk.ps1)
        shell: pwsh
        run: pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci/install-wdk.ps1'

      - name: Build drivers (ci/build-drivers.ps1)
        shell: pwsh
        run: pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci/build-drivers.ps1' -ToolchainJson 'out/toolchain.json' -RequireDrivers

      - name: Generate catalogs (ci/make-catalogs.ps1)
        shell: pwsh
        run: pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci/make-catalogs.ps1' -ToolchainJson 'out/toolchain.json'

      - name: Sign drivers (ci/sign-drivers.ps1; stable when secrets exist)
        shell: pwsh
        env:
          AERO_DRIVER_PFX_BASE64: ${{ secrets.AERO_DRIVER_PFX_BASE64 }}
          AERO_DRIVER_PFX_PASSWORD: ${{ secrets.AERO_DRIVER_PFX_PASSWORD }}
        run: pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci/sign-drivers.ps1' -ToolchainJson 'out/toolchain.json' -AllowSha2CertFallback

      - name: Package artifacts (ci/package-drivers.ps1)
        shell: pwsh
        run: pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci/package-drivers.ps1' -Version '${{ github.ref_name }}'

      - name: Stage public certificate as release asset
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (!(Test-Path -LiteralPath 'out/certs/aero-test.cer')) {
            throw "Expected signing cert to exist at out/certs/aero-test.cer"
          }
          Copy-Item -LiteralPath 'out/certs/aero-test.cer' -Destination 'out/artifacts/aero-driver-public.cer' -Force

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: win7-drivers-release
          if-no-files-found: error
          path: out/artifacts/

  publish-release:
    name: Publish GitHub Release assets
    runs-on: ubuntu-latest
    needs: build-sign-package
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: win7-drivers-release
          path: artifacts

      - name: Publish GitHub Release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/*.zip
            artifacts/*.iso
            artifacts/*.cer
          generate_release_notes: true
