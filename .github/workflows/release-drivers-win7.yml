name: Release Win7 drivers

on:
  push:
    tags:
      - "v*"

# Needed for creating/updating GitHub Releases and uploading release assets.
permissions:
  contents: write

jobs:
  build-and-sign:
    name: Build + sign
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4

      - name: Prepare signing certificate (stable if secrets set, otherwise ephemeral)
        id: cert
        shell: powershell
        env:
          AERO_DRIVER_PFX_BASE64: ${{ secrets.AERO_DRIVER_PFX_BASE64 }}
          AERO_DRIVER_PFX_PASSWORD: ${{ secrets.AERO_DRIVER_PFX_PASSWORD }}
        run: |
          $ErrorActionPreference = 'Stop'

          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $cerPath = Join-Path $PWD 'dist\aero-driver-public.cer'

          $hasStablePfx = (-not [string]::IsNullOrWhiteSpace($env:AERO_DRIVER_PFX_BASE64)) -and (-not [string]::IsNullOrWhiteSpace($env:AERO_DRIVER_PFX_PASSWORD))
          if ($hasStablePfx) {
            $mode = 'stable'

            $pfxPath = Join-Path $env:RUNNER_TEMP 'aero-driver.pfx'
            $pfxB64 = ($env:AERO_DRIVER_PFX_BASE64 -replace '\s', '')
            [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($pfxB64))

            $securePwd = ConvertTo-SecureString -String $env:AERO_DRIVER_PFX_PASSWORD -AsPlainText -Force
            $imported = Import-PfxCertificate -FilePath $pfxPath -Password $securePwd -CertStoreLocation 'Cert:\CurrentUser\My'
            $cert = $imported | Where-Object { $_.HasPrivateKey } | Select-Object -First 1
            if (-not $cert) {
              throw "Imported PFX successfully, but no certificate with a private key was found."
            }
            Remove-Item -Force $pfxPath
          } else {
            $mode = 'ephemeral'
            $cert = New-SelfSignedCertificate `
              -Subject 'CN=Aero Win7 Driver Test Signing (ephemeral)' `
              -Type CodeSigningCert `
              -KeyExportPolicy Exportable `
              -HashAlgorithm SHA256 `
              -CertStoreLocation 'Cert:\CurrentUser\My' `
              -NotAfter (Get-Date).AddYears(5)
          }

          Export-Certificate -Cert $cert -FilePath $cerPath | Out-Null

          Write-Host "Signing certificate mode: $mode"
          Write-Host "Signing certificate subject: $($cert.Subject)"
          Write-Host "Signing certificate thumbprint: $($cert.Thumbprint)"

          "mode=$mode" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "subject=$($cert.Subject)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
           "thumbprint=$($cert.Thumbprint)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Provision WDK toolchain (ci/install-wdk.ps1)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (!(Test-Path -LiteralPath 'ci\install-wdk.ps1')) {
            throw "Expected script ci\\install-wdk.ps1 to exist."
          }
          pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci\install-wdk.ps1'

      - name: Build + generate catalog (x86)
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x86

      - name: Build + generate catalog (repo script if present; otherwise minimal placeholder) (x86)
        shell: powershell
        env:
          ARCH: x86
        run: |
          $ErrorActionPreference = 'Stop'

          $outDir = Join-Path $PWD "dist\$env:ARCH"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null

          $buildScript = Join-Path $PWD 'scripts\build-drivers-win7.ps1'
          $ciBuildScript = Join-Path $PWD 'ci\build-drivers.ps1'
          if (Test-Path $buildScript -PathType Leaf) {
            & $buildScript -Arch $env:ARCH -OutDir $outDir
            exit $LASTEXITCODE
          }
          if (Test-Path $ciBuildScript -PathType Leaf) {
            # Build any driver projects discovered under drivers/* and stage them under dist/<arch>/.
            # Note: this repo may not have any buildable drivers yet, so keep the workflow green.
            $platform = if ($env:ARCH -ieq 'x86') { 'Win32' } else { 'x64' }
            & $ciBuildScript -Configuration Release -Platforms $platform
            if ($LASTEXITCODE -ne 0) {
              exit $LASTEXITCODE
            }
            if (Test-Path (Join-Path $PWD 'out\drivers')) {
              Copy-Item -Path (Join-Path $PWD 'out\drivers') -Destination (Join-Path $outDir 'drivers') -Recurse -Force
              exit 0
            }
          }

          Write-Warning "No scripts/build-drivers-win7.ps1 found. Creating placeholder driver artifacts so the release workflow remains green."

          # Create a minimal PE file (signable) to smoke-test signing in CI.
          $src = Join-Path $outDir 'aero-win7-driver-placeholder.c'
          @"
          #include <windows.h>
          BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved) { return TRUE; }
          "@ | Set-Content -Path $src -Encoding ASCII

          Push-Location $outDir
          & cl.exe /nologo /LD 'aero-win7-driver-placeholder.c' /link /OUT:'aero-win7-driver-placeholder.sys'
          if ($LASTEXITCODE -ne 0) { throw "cl.exe failed (exit $LASTEXITCODE)." }
          Pop-Location

          # MakeCat is available in Windows SDK/WDK. If it isn't present, we still keep the build green.
          $makecatCmd = Get-Command makecat.exe -ErrorAction SilentlyContinue
          $makecatExe = $null
          if ($makecatCmd) {
            $makecatExe = $makecatCmd.Source
            if (-not $makecatExe) { $makecatExe = $makecatCmd.Path }
          }
          if (-not $makecatExe) {
            $makecatExe = (Get-ChildItem -Path 'C:\Program Files (x86)\Windows Kits\10\bin' -Recurse -Filter makecat.exe -ErrorAction SilentlyContinue | Select-Object -First 1).FullName
          }

          if ($makecatExe) {
            $cdf = Join-Path $outDir 'aero-win7-driver-placeholder.cdf'
            @"
          [CatalogHeader]
          Name=aero-win7-driver-placeholder.cat
          CatalogVersion=2
          HashAlgorithms=SHA256

          [CatalogFiles]
          <hash>aero-win7-driver-placeholder.sys=aero-win7-driver-placeholder.sys
          "@ | Set-Content -Path $cdf -Encoding ASCII

            Push-Location $outDir
            & $makecatExe $cdf
            if ($LASTEXITCODE -ne 0) {
              throw "makecat.exe failed (exit $LASTEXITCODE)."
            }
            Pop-Location
          } else {
            Write-Warning "makecat.exe not found; skipping catalog generation."
          }

      - name: Build + generate catalog (x64)
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Build + generate catalog (repo script if present; otherwise minimal placeholder) (x64)
        shell: powershell
        env:
          ARCH: x64
        run: |
          $ErrorActionPreference = 'Stop'

          $outDir = Join-Path $PWD "dist\$env:ARCH"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null

          $buildScript = Join-Path $PWD 'scripts\build-drivers-win7.ps1'
          $ciBuildScript = Join-Path $PWD 'ci\build-drivers.ps1'
          if (Test-Path $buildScript -PathType Leaf) {
            & $buildScript -Arch $env:ARCH -OutDir $outDir
            exit $LASTEXITCODE
          }
          if (Test-Path $ciBuildScript -PathType Leaf) {
            $platform = if ($env:ARCH -ieq 'x86') { 'Win32' } else { 'x64' }
            & $ciBuildScript -Configuration Release -Platforms $platform
            if ($LASTEXITCODE -ne 0) {
              exit $LASTEXITCODE
            }
            if (Test-Path (Join-Path $PWD 'out\drivers')) {
              Copy-Item -Path (Join-Path $PWD 'out\drivers') -Destination (Join-Path $outDir 'drivers') -Recurse -Force
              exit 0
            }
          }

          Write-Warning "No scripts/build-drivers-win7.ps1 found. Creating placeholder driver artifacts so the release workflow remains green."

          $src = Join-Path $outDir 'aero-win7-driver-placeholder.c'
          @"
          #include <windows.h>
          BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved) { return TRUE; }
          "@ | Set-Content -Path $src -Encoding ASCII

          Push-Location $outDir
          & cl.exe /nologo /LD 'aero-win7-driver-placeholder.c' /link /OUT:'aero-win7-driver-placeholder.sys'
          if ($LASTEXITCODE -ne 0) { throw "cl.exe failed (exit $LASTEXITCODE)." }
          Pop-Location

          $makecatCmd = Get-Command makecat.exe -ErrorAction SilentlyContinue
          $makecatExe = $null
          if ($makecatCmd) {
            $makecatExe = $makecatCmd.Source
            if (-not $makecatExe) { $makecatExe = $makecatCmd.Path }
          }
          if (-not $makecatExe) {
            $makecatExe = (Get-ChildItem -Path 'C:\Program Files (x86)\Windows Kits\10\bin' -Recurse -Filter makecat.exe -ErrorAction SilentlyContinue | Select-Object -First 1).FullName
          }

          if ($makecatExe) {
            $cdf = Join-Path $outDir 'aero-win7-driver-placeholder.cdf'
            @"
          [CatalogHeader]
          Name=aero-win7-driver-placeholder.cat
          CatalogVersion=2
          HashAlgorithms=SHA256

          [CatalogFiles]
          <hash>aero-win7-driver-placeholder.sys=aero-win7-driver-placeholder.sys
          "@ | Set-Content -Path $cdf -Encoding ASCII

            Push-Location $outDir
            & $makecatExe $cdf
            if ($LASTEXITCODE -ne 0) { throw "makecat.exe failed (exit $LASTEXITCODE)." }
            Pop-Location
          } else {
            Write-Warning "makecat.exe not found; skipping catalog generation."
          }

      - name: Sign drivers + catalogs
        shell: powershell
        env:
          CERT_THUMBPRINT: ${{ steps.cert.outputs.thumbprint }}
        run: |
          $ErrorActionPreference = 'Stop'

          $signtoolCmd = Get-Command signtool.exe -ErrorAction SilentlyContinue
          $signtoolExe = $null
          if ($signtoolCmd) {
            $signtoolExe = $signtoolCmd.Source
            if (-not $signtoolExe) { $signtoolExe = $signtoolCmd.Path }
          }
          if (-not $signtoolExe) {
            $signtoolExe = (Get-ChildItem -Path 'C:\Program Files (x86)\Windows Kits\10\bin' -Recurse -Filter signtool.exe -ErrorAction SilentlyContinue | Select-Object -First 1).FullName
          }
          if (-not $signtoolExe) {
            throw "signtool.exe not found on runner."
          }

          $distDir = Join-Path $PWD 'dist'
          $targets = Get-ChildItem -Path $distDir -Recurse -File -Include *.sys,*.cat,*.dll,*.exe
          if (-not $targets) {
            Write-Warning "No signable artifacts found under $distDir."
            exit 0
          }

          foreach ($t in $targets) {
            Write-Host "Signing $($t.FullName)"
            & $signtoolExe sign /v /fd SHA256 /sha1 $env:CERT_THUMBPRINT /s My $t.FullName
            if ($LASTEXITCODE -ne 0) {
              throw "signtool sign failed for $($t.FullName) (exit $LASTEXITCODE)."
            }
            & $signtoolExe verify /pa /v $t.FullName
            if ($LASTEXITCODE -ne 0) {
              throw "signtool verify failed for $($t.FullName) (exit $LASTEXITCODE)."
            }
          }

      - name: Upload signed build outputs
        uses: actions/upload-artifact@v4
        with:
          name: win7-drivers
          if-no-files-found: error
          path: |
            dist/

  package-and-release:
    name: Package + publish release assets
    runs-on: ubuntu-latest
    needs: build-and-sign
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create zips + iso
        shell: bash
        run: |
          set -euo pipefail

          tag="${GITHUB_REF_NAME}"

          mkdir -p release_root
          cp -R "artifacts/win7-drivers/dist/x86" "release_root/x86"
          cp -R "artifacts/win7-drivers/dist/x64" "release_root/x64"

          # Public cert is identical for both arch artifacts; use either if present.
          cp "artifacts/win7-drivers/dist/aero-driver-public.cer" "aero-driver-public.cer"

          (cd release_root && zip -r "../aero-win7-drivers-${tag}-x86.zip" "x86")
          (cd release_root && zip -r "../aero-win7-drivers-${tag}-x64.zip" "x64")

          sudo apt-get update
          sudo apt-get install -y xorriso
          xorriso -as mkisofs -r -J -V "AERO_WIN7" -o "aero-win7-drivers-${tag}.iso" release_root

      - name: Publish GitHub Release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            aero-win7-drivers-${{ github.ref_name }}-x86.zip
            aero-win7-drivers-${{ github.ref_name }}-x64.zip
            aero-win7-drivers-${{ github.ref_name }}.iso
            aero-driver-public.cer
          generate_release_notes: true
