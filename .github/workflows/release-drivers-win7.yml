name: Release Win7 drivers

on:
  push:
    tags:
      - "v*"

# Needed for creating/updating GitHub Releases and uploading release assets.
permissions:
  contents: write

jobs:
  build-sign-package:
    name: Build + catalog + sign + package
    runs-on: windows-2022
    env:
      # Cache only installer/download payloads (not the installed WDK itself).
      WDK_DOWNLOAD_CACHE: C:\wdk-download-cache
    steps:
      - uses: actions/checkout@v4
        with:
          # Needed for `git describe --tags` in INF stamping/version derivation.
          fetch-depth: 0
          fetch-tags: true

      - name: Prepare WDK download cache directory
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          New-Item -ItemType Directory -Force -Path $env:WDK_DOWNLOAD_CACHE | Out-Null

      - name: Cache WDK downloads
        uses: actions/cache@v5
        with:
          path: ${{ env.WDK_DOWNLOAD_CACHE }}
          key: wdk-download-${{ runner.os }}-${{ hashFiles('ci/install-wdk.ps1', 'ci/lib/Toolchain.psm1') }}
          restore-keys: |
            wdk-download-${{ runner.os }}-

      - name: Provision WDK toolchain (ci/install-wdk.ps1)
        shell: pwsh
        run: pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci/install-wdk.ps1'

      - name: Build drivers (ci/build-drivers.ps1)
        shell: pwsh
        run: pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci/build-drivers.ps1' -ToolchainJson 'out/toolchain.json' -RequireDrivers

      - name: Build AeroGPU dbgctl tool (ci/build-aerogpu-dbgctl.ps1)
        shell: pwsh
        run: pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci/build-aerogpu-dbgctl.ps1' -ToolchainJson 'out/toolchain.json'

      - name: Generate catalogs (ci/make-catalogs.ps1)
        shell: pwsh
        run: pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci/make-catalogs.ps1' -ToolchainJson 'out/toolchain.json'

      - name: Sign drivers (ci/sign-drivers.ps1; stable when secrets exist)
        shell: pwsh
        env:
          AERO_DRIVER_PFX_BASE64: ${{ secrets.AERO_DRIVER_PFX_BASE64 }}
          AERO_DRIVER_PFX_PASSWORD: ${{ secrets.AERO_DRIVER_PFX_PASSWORD }}
        run: pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci/sign-drivers.ps1' -ToolchainJson 'out/toolchain.json' -AllowSha2CertFallback

      - name: Verify signed package staging (out/packages + aero-test.cer)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          if (!(Test-Path -LiteralPath 'out/packages')) {
            throw "Expected signed driver packages to exist at out/packages."
          }
          $inf = Get-ChildItem -LiteralPath 'out/packages' -Recurse -File -Filter '*.inf' -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $inf) {
            throw "Expected at least one .inf file under out/packages after catalog/signing."
          }
          if (!(Test-Path -LiteralPath 'out/certs/aero-test.cer')) {
            throw "Expected signing certificate to exist at out/certs/aero-test.cer."
          }

      - name: Upload signed packages (out/packages + aero-test.cer)
        uses: actions/upload-artifact@v4
        with:
          name: win7-drivers-signed-packages
          path: |
            out/packages/**
            out/certs/aero-test.cer
          if-no-files-found: error

      - name: Setup Rust (for aero_packager)
        uses: ./.github/actions/setup-rust
        with:
          toolchain: stable
          cache: false
          locked: always

      - name: Package artifacts (ci/package-drivers.ps1)
        shell: pwsh
        run: pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci/package-drivers.ps1' -Version '${{ github.ref_name }}' -MakeFatImage -FatImageStrict

      - name: Stage public certificate as release asset
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (!(Test-Path -LiteralPath 'out/certs/aero-test.cer')) {
            throw "Expected signing cert to exist at out/certs/aero-test.cer"
          }
          Copy-Item -LiteralPath 'out/certs/aero-test.cer' -Destination 'out/artifacts/aero-driver-public.cer' -Force

      - name: Package Guest Tools media (ci/package-guest-tools.ps1)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (!(Test-Path -LiteralPath 'ci\package-guest-tools.ps1')) {
            throw "Expected script ci\package-guest-tools.ps1 to exist."
          }
          pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci\package-guest-tools.ps1' -SpecPath 'tools\packaging\specs\win7-signed.json' -Version '${{ github.ref_name }}'

      - name: Smoke check Guest Tools outputs (sizes)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          foreach ($name in @('aero-guest-tools.iso', 'aero-guest-tools.zip', 'manifest.json')) {
            $p = Join-Path 'out\artifacts' $name
            if (!(Test-Path -LiteralPath $p -PathType Leaf)) {
              throw "Expected Guest Tools output missing: $p"
            }
            $f = Get-Item -LiteralPath $p
            Write-Host ("{0} - {1} bytes" -f $f.Name, $f.Length)
          }

      - name: Build Win7 virtio selftest (guest tool)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $srcDir = Join-Path $env:GITHUB_WORKSPACE 'drivers/windows7/tests/guest-selftest'
          if (!(Test-Path -LiteralPath $srcDir)) {
            throw "Expected guest selftest source directory to exist at $srcDir"
          }

          if (!(Test-Path -LiteralPath 'out/artifacts')) {
            throw "Expected out/artifacts directory to exist (created by packaging step)"
          }

          cmake -S $srcDir -B build-guest-selftest-x64 -G "Visual Studio 17 2022" -A x64
          cmake --build build-guest-selftest-x64 --config Release
          if (!(Test-Path -LiteralPath 'build-guest-selftest-x64/Release/aero-virtio-selftest.exe')) {
            throw "Expected x64 selftest binary to exist at build-guest-selftest-x64/Release/aero-virtio-selftest.exe"
          }
          Copy-Item -LiteralPath 'build-guest-selftest-x64/Release/aero-virtio-selftest.exe' -Destination 'out/artifacts/aero-virtio-selftest-x64.exe' -Force

          cmake -S $srcDir -B build-guest-selftest-x86 -G "Visual Studio 17 2022" -A Win32
          cmake --build build-guest-selftest-x86 --config Release
          if (!(Test-Path -LiteralPath 'build-guest-selftest-x86/Release/aero-virtio-selftest.exe')) {
            throw "Expected x86 selftest binary to exist at build-guest-selftest-x86/Release/aero-virtio-selftest.exe"
          }
          Copy-Item -LiteralPath 'build-guest-selftest-x86/Release/aero-virtio-selftest.exe' -Destination 'out/artifacts/aero-virtio-selftest-x86.exe' -Force

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: win7-drivers-release
          if-no-files-found: error
          path: out/artifacts/

  publish-release:
    name: Publish GitHub Release assets
    runs-on: ubuntu-latest
    needs: build-sign-package
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Needed for version stamping and deterministic version derivation inside CI scripts.
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Rust (for aero_packager)
        uses: ./.github/actions/setup-rust
        with:
          toolchain: stable
          cache: false
          locked: always

      - name: Download signed packages
        uses: actions/download-artifact@v4
        with:
          name: win7-drivers-signed-packages
          # The signed-packages artifact is uploaded with `out/` as its root,
          # so it contains `packages/` + `certs/`. Download into `out/` to
          # recreate the expected `out/packages` + `out/certs` layout.
          path: out

      - name: Normalize signed package layout
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          if ((Test-Path -LiteralPath 'out/packages') -and (Test-Path -LiteralPath 'out/certs')) {
            Write-Host "Signed packages layout OK (out/packages + out/certs)."
            exit 0
          }

          if ((Test-Path -LiteralPath 'out/out/packages') -and (Test-Path -LiteralPath 'out/out/certs')) {
            Write-Host "Detected nested signed packages layout (out/out/*); normalizing..."
            Move-Item -LiteralPath 'out/out/packages' -Destination 'out/packages' -Force
            Move-Item -LiteralPath 'out/out/certs' -Destination 'out/certs' -Force
            Remove-Item -LiteralPath 'out/out' -Recurse -Force -ErrorAction SilentlyContinue
            exit 0
          }

          throw "Unexpected signed packages layout after download. Expected out/packages + out/certs (or nested out/out/*)."

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: win7-drivers-release
          path: artifacts

      - name: Package Guest Tools (ci/package-guest-tools.ps1)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          if (!(Test-Path -LiteralPath 'ci/package-guest-tools.ps1')) {
            throw "Expected script ci/package-guest-tools.ps1 to exist."
          }
          if (!(Test-Path -LiteralPath 'out/packages')) {
            throw "Expected signed driver packages at out/packages (download artifact step may have failed)."
          }
          if (!(Test-Path -LiteralPath 'out/certs/aero-test.cer')) {
            throw "Expected signing cert at out/certs/aero-test.cer (download artifact step may have failed)."
          }

           pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci/package-guest-tools.ps1' `
             -InputRoot 'out/packages' `
             -CertPath 'out/certs/aero-test.cer' `
             -SpecPath 'tools/packaging/specs/win7-signed.json' `
             -OutDir 'artifacts' `
             -Version '${{ github.ref_name }}'

          # The Guest Tools wrapper script previously emitted `aero-guest-tools.manifest.json`,
          # but now emits `manifest.json` directly. Keep both filenames available for
          # downstream tooling by copying whichever one exists to the other path.
          $manifest = 'artifacts/manifest.json'
          $manifestAlias = 'artifacts/aero-guest-tools.manifest.json'
          if (Test-Path -LiteralPath $manifest) {
            Copy-Item -LiteralPath $manifest -Destination $manifestAlias -Force
          } elseif (Test-Path -LiteralPath $manifestAlias) {
            Copy-Item -LiteralPath $manifestAlias -Destination $manifest -Force
          } else {
            throw "Missing expected Guest Tools manifest (expected either $manifest or $manifestAlias)."
          }

          foreach ($path in @(
            'artifacts/aero-guest-tools.iso',
            'artifacts/aero-guest-tools.zip',
            'artifacts/aero-guest-tools.manifest.json',
            'artifacts/manifest.json'
          )) {
            if (!(Test-Path -LiteralPath $path)) {
              throw "Missing expected Guest Tools output: $path"
            }
          }

      - name: Stage Guest Tools artifact directory
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $dst = 'out/guest-tools'
          New-Item -ItemType Directory -Force -Path $dst | Out-Null

          Copy-Item -LiteralPath 'artifacts/aero-guest-tools.iso' -Destination (Join-Path $dst 'aero-guest-tools.iso') -Force
          Copy-Item -LiteralPath 'artifacts/aero-guest-tools.zip' -Destination (Join-Path $dst 'aero-guest-tools.zip') -Force
          Copy-Item -LiteralPath 'artifacts/manifest.json' -Destination (Join-Path $dst 'manifest.json') -Force
          Copy-Item -LiteralPath 'artifacts/aero-guest-tools.manifest.json' -Destination (Join-Path $dst 'aero-guest-tools.manifest.json') -Force

      - name: Publish GitHub Release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/*.zip
            artifacts/*.iso
            artifacts/*.manifest.json
            artifacts/manifest.json
            artifacts/*.cer
            artifacts/*.vhd
            artifacts/*.exe
          generate_release_notes: true

      - name: Upload Guest Tools artifacts
        uses: actions/upload-artifact@v4
        with:
          name: aero-guest-tools
          # Upload a dedicated directory so the artifact root contains the files
          # directly (no `artifacts/` path prefix when downloaded).
          path: out/guest-tools
          if-no-files-found: error
