name: Release Win7 drivers

on:
  push:
    tags:
      - "v*"

# Needed for creating/updating GitHub Releases and uploading release assets.
permissions:
  contents: write

jobs:
  build-sign-package:
    name: Build + catalog + sign + package
    runs-on: windows-2022
    env:
      # Cache only installer/download payloads (not the installed WDK itself).
      WDK_DOWNLOAD_CACHE: C:\wdk-download-cache
    steps:
      - uses: actions/checkout@v4
        with:
          # Needed for `git describe --tags` in INF stamping/version derivation.
          fetch-depth: 0

      - name: Prepare WDK download cache directory
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          New-Item -ItemType Directory -Force -Path $env:WDK_DOWNLOAD_CACHE | Out-Null

      - name: Cache WDK downloads
        uses: actions/cache@v4
        with:
          path: ${{ env.WDK_DOWNLOAD_CACHE }}
          key: wdk-download-${{ runner.os }}-${{ hashFiles('ci/install-wdk.ps1', 'ci/lib/Toolchain.psm1') }}
          restore-keys: |
            wdk-download-${{ runner.os }}-

      - name: Provision WDK toolchain (ci/install-wdk.ps1)
        shell: pwsh
        run: pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci/install-wdk.ps1'

      - name: Build drivers (ci/build-drivers.ps1)
        shell: pwsh
        run: pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci/build-drivers.ps1' -ToolchainJson 'out/toolchain.json' -RequireDrivers

      - name: Generate catalogs (ci/make-catalogs.ps1)
        shell: pwsh
        run: pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci/make-catalogs.ps1' -ToolchainJson 'out/toolchain.json'

      - name: Sign drivers (ci/sign-drivers.ps1; stable when secrets exist)
        shell: pwsh
        env:
          AERO_DRIVER_PFX_BASE64: ${{ secrets.AERO_DRIVER_PFX_BASE64 }}
          AERO_DRIVER_PFX_PASSWORD: ${{ secrets.AERO_DRIVER_PFX_PASSWORD }}
        run: pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci/sign-drivers.ps1' -ToolchainJson 'out/toolchain.json' -AllowSha2CertFallback

      - name: Package artifacts (ci/package-drivers.ps1)
        shell: pwsh
        run: pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci/package-drivers.ps1' -Version '${{ github.ref_name }}' -MakeFatImage -FatImageStrict

      - name: Setup Rust (for aero_packager)
        uses: ./.github/actions/setup-rust
        with:
          toolchain: stable
          cache: false
          locked: auto

      - name: Package Guest Tools media (ci/package-guest-tools.ps1)
        shell: pwsh
        run: pwsh -NoProfile -ExecutionPolicy Bypass -File 'ci/package-guest-tools.ps1' -Version '${{ github.ref_name }}'

      - name: Stage public certificate as release asset
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (!(Test-Path -LiteralPath 'out/certs/aero-test.cer')) {
            throw "Expected signing cert to exist at out/certs/aero-test.cer"
          }
          Copy-Item -LiteralPath 'out/certs/aero-test.cer' -Destination 'out/artifacts/aero-driver-public.cer' -Force

      - name: Build Win7 virtio selftest (guest tool)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $srcDir = Join-Path $env:GITHUB_WORKSPACE 'drivers/windows7/tests/guest-selftest'
          if (!(Test-Path -LiteralPath $srcDir)) {
            throw "Expected guest selftest source directory to exist at $srcDir"
          }

          if (!(Test-Path -LiteralPath 'out/artifacts')) {
            throw "Expected out/artifacts directory to exist (created by packaging step)"
          }

          cmake -S $srcDir -B build-guest-selftest-x64 -G "Visual Studio 17 2022" -A x64
          cmake --build build-guest-selftest-x64 --config Release
          if (!(Test-Path -LiteralPath 'build-guest-selftest-x64/Release/aero-virtio-selftest.exe')) {
            throw "Expected x64 selftest binary to exist at build-guest-selftest-x64/Release/aero-virtio-selftest.exe"
          }
          Copy-Item -LiteralPath 'build-guest-selftest-x64/Release/aero-virtio-selftest.exe' -Destination 'out/artifacts/aero-virtio-selftest-x64.exe' -Force

          cmake -S $srcDir -B build-guest-selftest-x86 -G "Visual Studio 17 2022" -A Win32
          cmake --build build-guest-selftest-x86 --config Release
          if (!(Test-Path -LiteralPath 'build-guest-selftest-x86/Release/aero-virtio-selftest.exe')) {
            throw "Expected x86 selftest binary to exist at build-guest-selftest-x86/Release/aero-virtio-selftest.exe"
          }
          Copy-Item -LiteralPath 'build-guest-selftest-x86/Release/aero-virtio-selftest.exe' -Destination 'out/artifacts/aero-virtio-selftest-x86.exe' -Force

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: win7-drivers-release
          if-no-files-found: error
          path: out/artifacts/

  publish-release:
    name: Publish GitHub Release assets
    runs-on: ubuntu-latest
    needs: build-sign-package
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: win7-drivers-release
          path: artifacts

      - name: Publish GitHub Release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/*.zip
            artifacts/*.iso
            artifacts/aero-guest-tools.manifest.json
            artifacts/*.cer
            artifacts/*.vhd
            artifacts/*.exe
          generate_release_notes: true
