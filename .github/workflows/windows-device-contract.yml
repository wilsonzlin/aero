name: Windows device contract

on:
  pull_request:
    paths:
      - "docs/windows-device-contract*.json"
      - "docs/windows-device-contract.md"
      - "guest-tools/**"
      - "crates/devices/src/pci/profile.rs"
      - "drivers/**"
      - "emulator/protocol/aerogpu/aerogpu_pci.rs"
      - "tools/packaging/**"
      - "tools/device_contract_validator/**"
      - "scripts/generate-windows-device-contract-virtio-win.py"
      - ".github/workflows/windows-device-contract.yml"
  push:
    branches: ["main"]
    paths:
      - "docs/windows-device-contract*.json"
      - "docs/windows-device-contract.md"
      - "guest-tools/**"
      - "crates/devices/src/pci/profile.rs"
      - "drivers/**"
      - "emulator/protocol/aerogpu/aerogpu_pci.rs"
      - "tools/packaging/**"
      - "tools/device_contract_validator/**"
      - "scripts/generate-windows-device-contract-virtio-win.py"
      - ".github/workflows/windows-device-contract.yml"
  merge_group:
    paths:
      - "docs/windows-device-contract*.json"
      - "docs/windows-device-contract.md"
      - "guest-tools/**"
      - "crates/devices/src/pci/profile.rs"
      - "drivers/**"
      - "emulator/protocol/aerogpu/aerogpu_pci.rs"
      - "tools/packaging/**"
      - "tools/device_contract_validator/**"
      - "scripts/generate-windows-device-contract-virtio-win.py"
      - ".github/workflows/windows-device-contract.yml"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: device-contract-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: Validate Windows device contract
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v6

      - name: Check generated virtio-win device contract
        shell: bash
        run: |
          set -euo pipefail
          python3 scripts/generate-windows-device-contract-virtio-win.py --check

      - name: Setup Rust
        id: setup-rust
        uses: ./.github/actions/setup-rust
        with:
          toolchain: stable
          locked: always

      - name: Run device contract validator
        shell: bash
        run: |
          set -euo pipefail
          cargo run ${{ steps.setup-rust.outputs.cargo_locked_flag }} -p device-contract-validator

      - name: Run Windows device contract integration test
        shell: bash
        run: |
          set -euo pipefail
          cargo test ${{ steps.setup-rust.outputs.cargo_locked_flag }} -p aero-devices --test windows_device_contract
