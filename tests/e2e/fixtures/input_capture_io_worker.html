<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Input Capture â†’ IO worker fixture</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      canvas {
        width: 640px;
        height: 480px;
        border: 1px solid #000;
      }
    </style>
  </head>
  <body>
    <canvas id="emu" width="640" height="480"></canvas>
    <script type="module">
      import { InputCapture } from "/web/src/input/input_capture.ts";
      import { allocateSharedMemorySegments, createSharedMemoryViews, StatusIndex } from "/web/src/runtime/shared_layout.ts";

      const canvas = /** @type {HTMLCanvasElement} */ (document.getElementById("emu"));

      // Deterministic pointer lock shim for headless tests.
      let plElement = null;
      Object.defineProperty(document, "pointerLockElement", {
        configurable: true,
        get() {
          return plElement;
        },
      });

      canvas.requestPointerLock = () => {
        window.__plRequestCount = (window.__plRequestCount || 0) + 1;
        plElement = canvas;
        document.dispatchEvent(new Event("pointerlockchange"));
      };

      document.exitPointerLock = () => {
        plElement = null;
        document.dispatchEvent(new Event("pointerlockchange"));
      };

      // Create a real IO worker and expose its shared status view so Playwright can assert receipt.
      const segments = allocateSharedMemorySegments();
      const views = createSharedMemoryViews(segments);
      window.__ioStatus = views.status;
      window.__ioReadyIndex = StatusIndex.IoReady;
      window.__ioInputBatchCounterIndex = StatusIndex.IoInputBatchCounter;
      window.__ioInputEventCounterIndex = StatusIndex.IoInputEventCounter;

      const ioWorker = new Worker(new URL("/web/src/workers/io.worker.ts", import.meta.url), { type: "module" });
      ioWorker.postMessage({ kind: "init", role: "io", controlSab: segments.control, guestMemory: segments.guestMemory });

      window.__capture = new InputCapture(canvas, ioWorker, {
        flushHz: 1000,
        mouseSensitivity: 1.0,
      });

      window.__capture.start();
    </script>
  </body>
</html>
