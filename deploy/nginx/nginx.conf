# Example nginx reverse proxy for Aero (web + aero-gateway).
#
# Goals:
# - TLS + HTTP/2 for clients
# - Serve the static frontend (`web/dist`) from disk (same-origin with the gateway)
# - Proxy HTTP APIs and WebSocket upgrades (/tcp, /tcp-mux) to `backend/aero-gateway`
# - Enforce COOP/COEP/CORP + CSP at the edge for SharedArrayBuffer / WASM threads
# - Set sane caching for static assets + correct MIME type for `.wasm`
#
# This file is an nginx *http-context* snippet (i.e. it should live under `http { ... }`,
# such as `/etc/nginx/conf.d/aero.conf`). Replace `example.com` and certificate paths.

map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

upstream aero_gateway {
    # If running in Docker Compose, this can be `aero-gateway:8080`.
    server 127.0.0.1:8080;
}

server {
    listen 80;
    server_name example.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name example.com;

    ssl_certificate     /etc/letsencrypt/live/example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;

    # Cross-origin isolation + baseline security headers.
    #
    # These must be present on the top-level document and any subresources
    # (scripts/workers/wasm) for `crossOriginIsolated === true` and
    # SharedArrayBuffer/WASM threads.
    add_header Cross-Origin-Opener-Policy "same-origin" always;
    add_header Cross-Origin-Embedder-Policy "require-corp" always;
    add_header Cross-Origin-Resource-Policy "same-origin" always;
    add_header Origin-Agent-Cluster "?1" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer" always;
    add_header Permissions-Policy "camera=(), geolocation=(), microphone=(self)" always;

    # CSP: allow same-origin ESM, WASM JIT via `wasm-unsafe-eval`, and module workers.
    #
    # `aero-gateway.invalid` is a documentation-only placeholder (the `.invalid` TLD will never
    # resolve). Replace it with the exact gateway/proxy origin(s) you want to allow, or remove
    # it entirely for strict single-origin deployments.
    add_header Content-Security-Policy "default-src 'none'; base-uri 'none'; object-src 'none'; frame-ancestors 'none'; script-src 'self' 'wasm-unsafe-eval'; worker-src 'self' blob:; connect-src 'self' https://aero-gateway.invalid wss://aero-gateway.invalid; img-src 'self' data: blob:; style-src 'self'; font-src 'self'" always;

    # HSTS (disable or lower max-age while iterating on TLS; production recommended: 31536000+).
    add_header Strict-Transport-Security "max-age=0" always;

    # If you use long-lived proxied requests (WebSockets, DoH, etc.), avoid proxy timeouts.
    proxy_read_timeout  1h;
    proxy_send_timeout  1h;
    proxy_connect_timeout 30s;

    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Gateway HTTP endpoints.
    location = /healthz   { proxy_pass http://aero_gateway; }
    location = /readyz    { proxy_pass http://aero_gateway; }
    location = /version   { proxy_pass http://aero_gateway; }
    location = /session   { proxy_pass http://aero_gateway; }
    location = /dns-query { proxy_pass http://aero_gateway; }
    location = /dns-json  { proxy_pass http://aero_gateway; }
    location = /metrics   { proxy_pass http://aero_gateway; }

    # WebSocket upgrade endpoints.
    location = /tcp {
        proxy_pass http://aero_gateway;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_buffering off;
    }
    location = /tcp-mux {
        proxy_pass http://aero_gateway;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_buffering off;
    }

    # Static hosting (serve `web/dist` from this directory).
    root /srv;

    # Make sure `.wasm` is served as `application/wasm` even if your nginx mime.types lacks it.
    location ~* \.wasm$ {
        default_type application/wasm;
        expires 1y;
        try_files $uri =404;
    }

    location /assets/ {
        expires 1y;
        try_files $uri =404;
    }

    location / {
        expires -1;
        try_files $uri $uri/ /index.html;
    }
}
