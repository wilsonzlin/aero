# Fixtures & Test Assets Policy

This repository must **not** distribute proprietary operating system media (especially Microsoft Windows), BIOS/firmware dumps, proprietary drivers, or other copyrighted binaries.

In addition, large binary fixtures quickly bloat git history and slow down CI. To reduce this risk, CI enforces a repository policy check.

For local-only fixtures (downloaded OSS images, user-supplied Windows media), use the gitignored `test-images/` directory (see `test-images/README.md`).

## What is NOT allowed in-repo

Do not commit files that are (or look like) OS installation media, disk images, or Windows binaries, including (non-exhaustive):

- Disk/VM images: `.iso`, `.img`, `.vhd`, `.vhdx`, `.vmdk`, `.qcow`, `.qcow2`, `.wim`
- Windows binaries: `.exe`, `.dll`
- Anything under Windows fixture directories such as `*/test_images/windows*` or `*/fixtures/windows*`

See `docs/13-legal-considerations.md` for the broader legal rationale.

### Allowlisted tiny binary fixtures

Some binary blobs are intentionally kept in-repo because they are **our own**
small, deterministic test fixtures:

- `assets/bios.bin` (generated fixture; canonical ROM comes from `firmware::bios::build_bios_rom()`; see [`assets/README.md`](../assets/README.md); regenerate via `cargo xtask bios-rom`, verify with `cargo xtask bios-rom --check`)
- `crates/firmware/acpi/dsdt.aml` and `crates/firmware/acpi/dsdt_pcie.aml` (ACPI DSDT AML built from this repo; regenerate via `cargo xtask fixtures` (legacy-only alternative: `cargo run -p firmware --bin gen_dsdt --locked`))
- `tests/fixtures/boot/*.bin` and `tests/fixtures/boot/*.img` (boot sector + tiny disk images generated by `cargo xtask fixtures`)
- `tests/fixtures/bootsector.bin` and `tests/fixtures/realmode_vbe_test.bin` (tiny boot/test programs generated by `cargo xtask fixtures`; `.asm`/`.s` sources live alongside as documentation)
- `tests/fixtures/boot/int_sanity.bin` (tiny BIOS interrupt sanity boot sector generated by `cargo xtask fixtures`; `int_sanity.asm` is kept as documentation/reference)
- `tools/qemu_diff/boot/boot.bin` (QEMU-diff boot sector generated by `cargo xtask fixtures`; assembly source `boot.S` lives alongside as documentation; used by the `qemu-diff` Cargo package)

These paths are explicitly allowlisted by `scripts/ci/check-repo-policy.sh` and must remain small and reproducible.

In addition, a handful of **tiny text placeholders** with normally-forbidden Windows driver extensions are kept
in-repo for packaging tests:

- `tools/packaging/aero_packager/testdata/drivers/**/test.sys`
- `tools/packaging/aero_packager/testdata/drivers/**/test.dll`
- `tools/packaging/aero_packager/testdata/drivers/**/WdfCoInstaller*.dll` (KMDF coinstaller placeholder)

These are **not real Windows binaries**; CI pins their blob hashes in `scripts/ci/check-repo-policy.sh` to prevent
silent drift into proprietary artifacts.

## Size limits

New/changed blobs should generally stay **under 20MB**. If you need larger assets for tests, prefer:

- Generating fixtures at runtime (e.g., create minimal disk images during tests).
- Downloading fixtures as part of local-only setup or CI setup from an approved external source (public OSS mirror or private bucket).

If a fixture truly needs to live in-repo despite policy checks (for size or filetype), it must be explicitly allowlisted in `scripts/ci/check-repo-policy.sh` with a clear justification. Filetype exceptions should be pinned (e.g., by blob hash) so they cannot silently drift into proprietary binaries.

In addition, allowlisted disk/firmware-like blobs (the `.bin`/`.img` fixtures above) are held to a **much stricter** size limit in CI (1 MiB each).

## Golden images (synthetic, committed)

The `tests/golden/` directory contains small, synthetic golden PNGs used for graphics regression tests.

Some of these images are generated by `npm run generate:goldens`, and CI enforces that the checked-in PNGs
match the generator output (contributors must regenerate + commit when changing the underlying scene code).

## Adding permissible fixtures (open source / small)

When adding a fixture that is safe to store in-repo:

1. Ensure the asset is **open-source / redistributable** and include provenance (source URL + license).
2. Keep it small, stable, and deterministic (avoid generated blobs when a tiny textual representation is possible).
3. Prefer placing fixtures in a dedicated directory with a short README describing:
   - Where it came from
   - License
   - Hash (SHA256) for integrity

## CI enforcement

CI runs `scripts/ci/check-repo-policy.sh` on PRs and pushes. If it fails, remove the disallowed file(s) and use one of the alternatives above.

In addition, CI enforces **determinism** for the allowlisted tiny binary fixtures by running:

```bash
cargo xtask fixtures --check
```

This fails if any generated fixture is missing or out-of-date (regenerate via `cargo xtask fixtures`).
