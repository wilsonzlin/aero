# Reproducible development environment

Aero’s canonical workflows assume a small set of native tooling (pinned Rust toolchains, Node, QEMU, etc.). To make “clone → build → test” reliable, this repo ships a **VS Code / GitHub Codespaces dev container** definition.

## Option A: Dev Container (recommended)

### Prerequisites (host)

- Docker Desktop / Docker Engine
- VS Code + the “Dev Containers” extension (or GitHub Codespaces)

### Usage

1. Clone the repo.
2. Open it in VS Code.
3. Run **“Dev Containers: Reopen in Container”**.

On first launch, the dev container runs `just setup` automatically (via `postCreateCommand`). This installs Rust toolchains/targets and runs `npm ci` with Playwright browser downloads disabled.

The container image installs:

- Rust toolchains: **pinned stable + pinned nightly**
  - Stable is pinned in `rust-toolchain.toml`.
  - The threaded-WASM nightly toolchain is pinned in `scripts/toolchains.json` (`rust.nightlyWasm`).
  - `wasm32-unknown-unknown` target for both
  - `rust-src` for nightly (required for `-Z build-std` threaded/shared-memory WASM builds)
- Node.js version pinned in the repo root [`.nvmrc`](../.nvmrc) (matching CI)
- `wasm-pack`
- Binaryen (`wasm-opt`)
- QEMU + boot-test deps: `qemu-system-x86`, `mtools`, `unzip` (boot fixtures are generated by `cargo xtask fixtures`, so CI does not require an assembler; `nasm` is optional if you want to assemble/inspect legacy `.asm` sources)
- ACPICA tools: `iasl` (`acpica-tools`)
- Playwright runtime dependencies (browser binaries are installed separately; see below)

It also applies the recommended environment defaults from [`scripts/agent-env.sh`](../scripts/agent-env.sh) (job parallelism, Node heap cap, Playwright worker count) and attempts to bump `ulimit -n` to avoid “too many open files” failures.

### Validating your setup

From the repo root **inside the container**:

```bash
# (If you just created the container, this already ran via postCreateCommand,
# but it's safe to re-run.)
just setup
cargo xtask test-all --skip-e2e
# (Or use the transitional wrapper: bash ./scripts/test-all.sh --skip-e2e)
```

By default, the test runner uses the **repo root** Node workspace (`package.json` in the root) which matches CI.
In the npm-workspaces layout you typically **do not** need to override this; to run web-only scripts, prefer:

```bash
npm -w web run <script>
```

`AERO_NODE_DIR` is only needed when you specifically want `cargo xtask` to execute npm scripts from a different `package.json` (for example, `AERO_NODE_DIR=web` selects the `web/` workspace scripts, so you must skip E2E because that workspace does not define Playwright scripts).

```bash
AERO_NODE_DIR=web cargo xtask test-all --skip-e2e
```

### Running Playwright E2E tests (optional)

The container includes the native libraries Playwright needs, but it does **not** pre-download browser binaries.

If you used the dev container defaults, `npm ci` has already been run (via `just setup`). Install the browsers once:

```bash
node scripts/playwright_install.mjs chromium
```

Then run e2e:

```bash
cargo xtask test-all
```

## Option B: Nix (optional)

This repo currently does not ship a Nix flake. If you’d like to contribute one, it should provide a `devShell` with the same toolchain as the dev container and document the equivalent validation steps (`just setup` + `cargo xtask test-all --skip-e2e`).
