# Environment variables (canonical)

This repository uses environment variables to configure build/test/dev tooling and a few runtime components.
To reduce drift, **prefer the canonical `AERO_*` variables** listed here and avoid legacy aliases.

## Precedence rules

1. **CLI flags** (when available) override environment variables.
2. **Canonical env vars** (e.g. `AERO_NODE_DIR`) override legacy aliases.
3. **Legacy aliases** are accepted for one compatibility cycle and emit a warning to stderr.
4. If nothing is set, tooling uses a **repo-default auto-detected** value when possible.

## Validation / normalization helper

Many scripts share the same “where is the Node workspace / wasm crate?” questions. Use:

```bash
node scripts/env/resolve.mjs --format json
```

It validates and normalizes inputs (paths, booleans, URLs) and uses the same path
resolution logic as CI (`scripts/ci/detect-node-dir.mjs`, `scripts/ci/detect-wasm-crate.mjs`).

It also normalizes a few commonly-propagated boolean knobs (e.g. `AERO_REQUIRE_WEBGPU`,
`AERO_DISABLE_WGPU_TEXTURE_COMPRESSION`, `VITE_DISABLE_COOP_COEP`) to `0`/`1`.

It can also print shell assignments:

```bash
eval "$(node scripts/env/resolve.mjs --format bash --require-node-dir --require-wasm-crate-dir)"
```

## Canonical variables

| Variable | Meaning | Default | Consumed by | Examples |
| --- | --- | --- | --- | --- |
| `AERO_NODE_DIR` | Path (relative to repo root or absolute) to the **Node workspace entrypoint** directory containing `package.json`. In the npm-workspaces layout this should usually stay at `.` (repo root); use `npm -w <path> …` to run scripts in other workspaces. | Auto-detected: prefer `.` then `frontend/` then `web/` | `cargo xtask test-all`, `cargo xtask input`, GitHub Actions CI, `.github/actions/setup-playwright`, `justfile` | `AERO_NODE_DIR=.`, `AERO_NODE_DIR=web` |
| `AERO_WASM_CRATE_DIR` | Path (relative to repo root or absolute) to the **wasm-pack Rust crate** (must contain `Cargo.toml` and declare a `cdylib`). | Auto-detected via `scripts/ci/detect-wasm-crate.mjs` (prefers `crates/aero-wasm`; otherwise uses `cargo metadata` only when the `cdylib` crate is unambiguous; fails if ambiguous). | `cargo xtask test-all`, GitHub Actions CI | `AERO_WASM_CRATE_DIR=crates/aero-wasm` |
| `AERO_WASM_PACKAGES` | Comma-separated list of WASM package IDs to build when running `web/scripts/build_wasm.mjs` (and scripts that call it, like `npm -w web run wasm:build`). Known IDs: `core`, `gpu`, `d3d11`, `jit`. | *(unset)* (build all packages) | `web/scripts/build_wasm.mjs`, `cargo xtask input --e2e` | `AERO_WASM_PACKAGES=core npm -w web run wasm:build` |
| `AERO_REQUIRE_WEBGPU` | When true, WebGPU-tagged browser tests **must fail** if WebGPU is unavailable (instead of skipping). Accepts `1/0/true/false/yes/no/on/off`. | `0` | `cargo xtask test-all`, Playwright specs (`tests/**`) | `AERO_REQUIRE_WEBGPU=1 npm run test:e2e` |
| `AERO_DISABLE_WGPU_TEXTURE_COMPRESSION` | When true, Aero will **not request GPU texture compression features** (BC/ETC2/ASTC) even if the adapter supports them. This forces Aero to treat texture compression support as unavailable (enabling CPU decompression fallbacks where implemented). Note: Aero also avoids requesting these compression features on the **wgpu GL backend** by default due to correctness issues; this env var is an additional opt-out for other backends. Accepts `1/0/true/false/yes/no/on/off`. | `0` | wgpu device feature negotiation (`crates/aero-webgpu`, `crates/aero-gpu`, `crates/aero-d3d9`, etc.) and env normalization (`scripts/env/resolve.mjs`) | `AERO_DISABLE_WGPU_TEXTURE_COMPRESSION=1 cargo test -p aero-webgpu --locked`, `eval "$(node scripts/env/resolve.mjs --format bash --disable-wgpu-texture-compression)"` |
| `AERO_ALLOW_UNSUPPORTED_NODE` | If set to `1/true/yes/on`, `scripts/check-node-version.mjs` will **warn but exit 0** when the current Node.js version does not match the repo's pinned `.nvmrc`. Intended for constrained environments where you cannot install the pinned Node version. Note: `scripts/agent-env.sh` may auto-enable this when it detects a Node major mismatch. | *(unset)* | `scripts/check-node-version.mjs` (and therefore anything that calls it, like `cargo xtask`/`just`) | `AERO_ALLOW_UNSUPPORTED_NODE=1 cargo xtask test-all --skip-e2e` |
| `AERO_NODE_VERSION_OVERRIDE` | Test-only override for `scripts/check-node-version.mjs`. When set, the script will treat it as the “detected” Node.js version instead of `process.versions.node` (useful for hermetic tooling/tests). | *(unset)* | `scripts/check-node-version.mjs` | `AERO_NODE_VERSION_OVERRIDE=22.11.0 node scripts/check-node-version.mjs` |
| `AERO_ISOLATE_CARGO_HOME` | Controls Cargo home isolation for agent sandboxes. If set to `1/true/yes/on`, agent helper scripts override `CARGO_HOME` to a **repo-local** `./.cargo-home` to avoid global Cargo registry lock contention on shared hosts. If set to any other non-false value, it is treated as a path (supports `~/` expansion; non-absolute paths are relative to repo root) and used as `CARGO_HOME`. Note: `scripts/safe-run.sh` will also auto-use an existing `./.cargo-home` when `AERO_ISOLATE_CARGO_HOME` is unset and `CARGO_HOME` is unset/default. | *(unset)* | `scripts/agent-env.sh`, `scripts/safe-run.sh`, Node test harnesses that spawn `cargo` (`tools/rust_l2_proxy.js`) | `AERO_ISOLATE_CARGO_HOME=1 source ./scripts/agent-env.sh` / `AERO_ISOLATE_CARGO_HOME=/tmp/aero-cargo-home bash ./scripts/safe-run.sh cargo build --locked` |
| `AERO_DISABLE_RUSTC_WRAPPER` | If set to `1/true/yes/on`, agent helper scripts will **force-disable** rustc wrappers by exporting empty wrapper env vars (which overrides global Cargo config). When unset, helper scripts still clear **environment-based sccache** wrappers by default for reliability, but preserve other wrappers like `ccache`. | *(unset)* | `scripts/agent-env.sh`, `scripts/safe-run.sh` | `AERO_DISABLE_RUSTC_WRAPPER=1 source ./scripts/agent-env.sh` / `AERO_DISABLE_RUSTC_WRAPPER=1 bash ./scripts/safe-run.sh cargo test --locked` |
| `AERO_CARGO_BUILD_JOBS` | Positive integer. If set, agent helper scripts will use this for Cargo parallelism (`CARGO_BUILD_JOBS`). Useful for tuning parallelism in agent sandboxes where high parallelism can cause `rustc` OS-resource panics (e.g. `failed to spawn helper thread (WouldBlock)` or `called Result::unwrap() on an Err value: Os { code: 11, kind: WouldBlock, message: "Resource temporarily unavailable" }`). | `1` (agent default) | `scripts/agent-env.sh`, `scripts/safe-run.sh` | `AERO_CARGO_BUILD_JOBS=2 source ./scripts/agent-env.sh` |
| `RUSTC_WORKER_THREADS` | Positive integer. Controls rustc's internal worker pool size. Agent helper scripts default/sanitize it to `CARGO_BUILD_JOBS` for reliability under tight thread limits. | *(unset)* (agent default: `CARGO_BUILD_JOBS`) | rustc, `scripts/agent-env.sh`, `scripts/safe-run.sh` | `RUSTC_WORKER_THREADS=1 bash ./scripts/safe-run.sh cargo build --locked` |
| `RAYON_NUM_THREADS` | Positive integer. Controls Rayon global thread pool size (used by rustc and other crates). Agent helper scripts default/sanitize it to `CARGO_BUILD_JOBS` for reliability under tight thread limits. | *(unset)* (agent default: `CARGO_BUILD_JOBS`) | Rayon, `scripts/agent-env.sh`, `scripts/safe-run.sh` | `RAYON_NUM_THREADS=1 bash ./scripts/safe-run.sh cargo build --locked` |
| `RUST_TEST_THREADS` | Positive integer. Controls Rust's built-in test harness parallelism (libtest). Agent helper scripts default it to `CARGO_BUILD_JOBS` for reliability under tight thread limits. | *(unset)* (libtest default: `num_cpus`; agent default: `CARGO_BUILD_JOBS`) | libtest (`cargo test`), `scripts/agent-env.sh`, `scripts/safe-run.sh` | `RUST_TEST_THREADS=1 bash ./scripts/safe-run.sh cargo test --locked` |
| `NEXTEST_TEST_THREADS` | Positive integer (or `num-cpus`). Controls `cargo nextest run` test concurrency (`--test-threads`). Agent helper scripts default/sanitize it to `CARGO_BUILD_JOBS` for reliability under tight thread limits. | *(unset)* (nextest default: `num-cpus`; agent default: `CARGO_BUILD_JOBS`) | cargo-nextest, `scripts/agent-env.sh`, `scripts/safe-run.sh` | `NEXTEST_TEST_THREADS=1 bash ./scripts/safe-run.sh cargo nextest run --locked --workspace` |
| `AERO_TOKIO_WORKER_THREADS` | Positive integer. When set, supported Aero binaries will size their Tokio multi-thread runtime worker pool to this value (instead of Tokio's default `num_cpus`). Agent helper scripts default/sanitize it to `CARGO_BUILD_JOBS` for reliability under tight thread limits. | *(unset)* (agent default: `CARGO_BUILD_JOBS`) | `aero-l2-proxy`, `aero-storage-server`, `disk-gateway`, `tools/aero-gateway-rs`, `tools/image-chunker`, `scripts/agent-env.sh`, `scripts/safe-run.sh` | `AERO_TOKIO_WORKER_THREADS=1 bash ./scripts/safe-run.sh cargo run --locked --bin disk-gateway` |
| `AERO_RUST_CODEGEN_UNITS` | Optional positive integer. If set, agent helper scripts will add `-C codegen-units=<n>` to `RUSTFLAGS` when running Cargo commands (unless `RUSTFLAGS` already contains a `codegen-units=` setting). This can reduce per-crate thread usage and improve reliability under tight thread/PID limits. Alias: `AERO_CODEGEN_UNITS`. | *(unset)* | `scripts/agent-env.sh`, `scripts/safe-run.sh` | `AERO_RUST_CODEGEN_UNITS=1 bash ./scripts/safe-run.sh cargo test --locked` / `AERO_CODEGEN_UNITS=1 source ./scripts/agent-env.sh` |
| `AERO_SAFE_RUN_RUSTC_RETRIES` | Positive integer (attempt count, including the first run). Controls how many times `scripts/safe-run.sh` will retry Rust build/test commands (Cargo and common wrappers like `npm`/`wasm-pack`) when it detects transient OS resource-limit failures during thread/process spawn (EAGAIN/WouldBlock), e.g. `failed to spawn helper thread (WouldBlock)`, `called Result::unwrap() on an Err value: Os { code: 11, kind: WouldBlock, message: "Resource temporarily unavailable" }`, or `fork: retry: Resource temporarily unavailable`. Set to `1` to disable retries. | `3` | `scripts/safe-run.sh` | `AERO_SAFE_RUN_RUSTC_RETRIES=1 bash ./scripts/safe-run.sh cargo test --locked` |
| `AERO_TIMEOUT` | Timeout in seconds used by `scripts/safe-run.sh` (wraps commands via `with-timeout.sh`). | `600` | `scripts/safe-run.sh` | `AERO_TIMEOUT=1200 bash ./scripts/safe-run.sh cargo test --locked` |
| `AERO_MEM_LIMIT` | Virtual address space (RLIMIT_AS) limit used by `scripts/safe-run.sh` (passed through to `run_limited.sh`). | `12G` | `scripts/safe-run.sh` | `AERO_MEM_LIMIT=32G bash ./scripts/safe-run.sh npm -w web run test:unit` |
| `AERO_NODE_TEST_MEM_LIMIT` | Fallback RLIMIT_AS limit used by `scripts/safe-run.sh` for **WASM-heavy Node test runners** when `AERO_MEM_LIMIT` is unset (helps under RLIMIT_AS). Applies to `node --test ...` and common wrappers like `npm run test:*` / Vitest and `wasm-pack test --node`. | `256G` | `scripts/safe-run.sh` | `AERO_NODE_TEST_MEM_LIMIT=24G bash ./scripts/safe-run.sh node --test tests/*.test.js` |
| `AERO_PLAYWRIGHT_MEM_LIMIT` | Fallback RLIMIT_AS limit used by `scripts/safe-run.sh` for **Playwright/browser E2E runs** when `AERO_MEM_LIMIT` is unset. Chromium/WebAssembly can reserve huge *virtual* address space; too-low RLIMIT_AS can crash Chromium or break `WebAssembly.Memory()` allocations. Applies to `npm run test:e2e`, `npx playwright ...`, and `cargo xtask ... --e2e`. | `256G` | `scripts/safe-run.sh` | `AERO_PLAYWRIGHT_MEM_LIMIT=128G bash ./scripts/safe-run.sh npm run test:e2e` |
| `AERO_PLAYWRIGHT_TIMEOUT` | Fallback timeout (seconds) used by `scripts/safe-run.sh` for Playwright/browser E2E runs when `AERO_TIMEOUT` is unset. E2E runs often trigger a WebAssembly build step (`npm -w web run wasm:build`) which can exceed the default 10-minute timeout on cold caches. | `1800` | `scripts/safe-run.sh` | `AERO_PLAYWRIGHT_TIMEOUT=2400 bash ./scripts/safe-run.sh cargo xtask input --e2e` |
| `AERO_BENCH_COMPARE_PROFILE` | Optional perf-threshold profile name for benchmark comparison reports (e.g. `pr-smoke`, `nightly`). | Auto-detected by `scripts/compare-benchmarks.sh` based on input layout | `scripts/compare-benchmarks.sh` | `AERO_BENCH_COMPARE_PROFILE=pr-smoke bash ./scripts/compare-benchmarks.sh` |
| `AERO_BENCH_THRESHOLDS_FILE` | Path (relative to repo root or absolute) to the benchmark regression thresholds JSON file. | `bench/perf_thresholds.json` | `scripts/compare-benchmarks.sh` | `AERO_BENCH_THRESHOLDS_FILE=bench/perf_thresholds.json bash ./scripts/compare-benchmarks.sh` |
| `AERO_BENCH_COMPARE_MARKDOWN_OUT` | Output path for the generated benchmark comparison markdown report. | `bench_reports/compare.md` | `scripts/compare-benchmarks.sh` | `AERO_BENCH_COMPARE_MARKDOWN_OUT=/tmp/compare.md bash ./scripts/compare-benchmarks.sh` |
| `AERO_BENCH_COMPARE_JSON_OUT` | Output path for the generated benchmark comparison JSON artifact. | `bench_reports/compare.json` | `scripts/compare-benchmarks.sh` | `AERO_BENCH_COMPARE_JSON_OUT=/tmp/compare.json bash ./scripts/compare-benchmarks.sh` |
| `AERO_QEMU` | Path to a QEMU binary for Rust QEMU boot tests (`qemu-system-i386` / `qemu-system-x86_64`). | Auto-detected (`qemu-system-i386`, else `qemu-system-x86_64`) | Rust QEMU harness (`tests/harness/mod.rs`) | `AERO_QEMU=/usr/bin/qemu-system-i386 cargo test -p aero-boot-tests --test boot_sector --locked` |
| `AERO_ARTIFACT_DIR` | Output directory for failing test artifacts (e.g. screenshots/diffs). | `target/aero-test-artifacts` | Rust QEMU harness (`tests/harness/mod.rs`) | `AERO_ARTIFACT_DIR=/tmp/aero-artifacts cargo test -p aero-boot-tests --test windows7_boot --locked -- --ignored` |
| `AERO_REQUIRE_TEST_IMAGES` | When set (to any value), missing test fixture assets are treated as **hard errors** instead of skips. | *(unset)* | Rust QEMU harness (`tests/harness/mod.rs`) | `AERO_REQUIRE_TEST_IMAGES=1 cargo test -p aero-boot-tests --test freedos_boot --locked` |
| `AERO_UPDATE_TRACE_FIXTURES` | When set (to any value), GPU trace fixture tests will overwrite/regenerate the committed fixture files instead of asserting stability. | *(unset)* | `crates/aero-gpu-trace` tests, `crates/aero-gpu-trace-replay` tests | `AERO_UPDATE_TRACE_FIXTURES=1 cargo test -p aero-gpu-trace --locked` |
| `AERO_CONFORMANCE_CASES` | Number of instruction test cases to run in the differential conformance harness (`crates/conformance`). | `512` | `crates/conformance` | `AERO_CONFORMANCE_CASES=4096 cargo xtask conformance -- --nocapture` |
| `AERO_CONFORMANCE_SEED` | RNG seed for generating conformance test cases (to reproduce failures). Accepts decimal or `0x...` hex; `_` separators allowed. | `0x_52c6_71d9_a4f2_31b9` | `crates/conformance` | `AERO_CONFORMANCE_SEED=0x52c671d9a4f231b9 cargo xtask conformance -- --nocapture` |
| `AERO_CONFORMANCE_FILTER` | Filter string to select a subset of instruction templates/corpus entries (matches template `coverage_key` or substring of template name). | *(unset)* | `crates/conformance` | `AERO_CONFORMANCE_FILTER=add AERO_CONFORMANCE_CASES=4096 cargo xtask conformance -- --nocapture` |
| `AERO_CONFORMANCE_REFERENCE` | Select the reference backend for the instruction conformance harness. Set to `qemu` to compare against QEMU (requires the `conformance` crate built with `--features qemu-reference` and a `qemu-system-*` binary). Any other value/unset uses the native host reference backend (x86_64 unix). | *(unset)* (host) | `crates/conformance` | `AERO_CONFORMANCE_REFERENCE=qemu AERO_CONFORMANCE_CASES=16 cargo test -p conformance --features qemu-reference --test cpu_instruction_conformance instruction_conformance_host_reference --locked` |
| `AERO_CONFORMANCE_REPORT_PATH` | Optional output path for a JSON conformance report (written on failure; also written on success when set). | *(unset)* | `crates/conformance` | `AERO_CONFORMANCE_REPORT_PATH=target/conformance.json cargo xtask conformance -- --nocapture` |
| `AERO_CONFORMANCE_REFERENCE_ISOLATE` | When set to `0`, run the native host reference backend without `fork()` isolation (useful in sandboxed environments). | `1` | `crates/conformance` | `AERO_CONFORMANCE_REFERENCE_ISOLATE=0 cargo xtask conformance -- --nocapture` |
| `AERO_WINDOWS7_IMAGE` | Path to a user-supplied Windows 7 disk image for the gated/ignored `windows7_boot` test. | `test-images/local/windows7.img` (gitignored; not provided by repo) | `tests/windows7_boot.rs`, `scripts/prepare-windows7.sh` | `AERO_WINDOWS7_IMAGE=/path/to/windows7.img cargo test -p aero-boot-tests --test windows7_boot --locked -- --ignored` |
| `AERO_WINDOWS7_GOLDEN` | Path to an expected “golden” Windows 7 framebuffer screenshot to compare against for the gated/ignored `windows7_boot` test. | `test-images/local/windows7_login.png` (gitignored) | `tests/windows7_boot.rs`, `scripts/prepare-windows7.sh` | `AERO_WINDOWS7_GOLDEN=/path/to/windows7_login.png cargo test -p aero-boot-tests --test windows7_boot --locked -- --ignored` |
| `AERO_WIN7_ISO` | Path to a user-supplied Windows 7 install ISO used by the optional `aero-win7-slipstream` integration test. If unset, the test is skipped. | *(unset)* | `tools/win7-slipstream/tests/integration.rs` | `AERO_WIN7_ISO=/path/to/win7.iso AERO_WIN7_DRIVERS=/path/to/aero-drivers cargo test -p aero-win7-slipstream --locked` |
| `AERO_WIN7_DRIVERS` | Path to an Aero driver pack directory used by the optional `aero-win7-slipstream` integration test. If unset, the test is skipped. | *(unset)* | `tools/win7-slipstream/tests/integration.rs` | `AERO_WIN7_ISO=/path/to/win7.iso AERO_WIN7_DRIVERS=/path/to/aero-drivers cargo test -p aero-win7-slipstream --locked` |
| `AERO_WIN7_SLIPSTREAM_IMAGE` | Container image name for `tools/win7-slipstream/scripts/slipstream-in-container.{sh,ps1}`. | `aero/win7-slipstream` | `tools/win7-slipstream/scripts/slipstream-in-container.*` | `AERO_WIN7_SLIPSTREAM_IMAGE=aero/win7-slipstream tools/win7-slipstream/scripts/slipstream-in-container.sh deps` |
| `AERO_MAKE_FAT_IMAGE` | When set to `1/true/yes/on`, `ci/package-drivers.ps1` will attempt to create an additional FAT32 VHD driver install media artifact (`*-fat.vhd`) alongside the normal ZIP/ISO outputs. This requires Windows + admin privileges; by default it is skipped with a warning if unavailable unless `-FatImageStrict` is passed. | *(unset)* | `ci/package-drivers.ps1` | `AERO_MAKE_FAT_IMAGE=1 pwsh ci/package-drivers.ps1` |
| `AERO_DRIVER_PFX_BASE64` | Base64-encoded PFX bytes used by `ci/sign-drivers.ps1` to sign Windows drivers. | *(unset)* | `ci/sign-drivers.ps1` | `AERO_DRIVER_PFX_BASE64=<base64> AERO_DRIVER_PFX_PASSWORD=<password> pwsh ci/sign-drivers.ps1` |
| `AERO_DRIVER_PFX_PASSWORD` | Password for the PFX provided via `AERO_DRIVER_PFX_BASE64` when signing Windows drivers. | *(unset)* | `ci/sign-drivers.ps1` | `AERO_DRIVER_PFX_BASE64=<base64> AERO_DRIVER_PFX_PASSWORD=<password> pwsh ci/sign-drivers.ps1` |
| `AERO_PLAYWRIGHT_REUSE_SERVER` | When set to `1/true`, Playwright will reuse already-running harness/preview/CSP servers instead of starting new ones. Disabled on CI. | `0` | `playwright.config.ts`, `playwright.gpu.config.ts` | `AERO_PLAYWRIGHT_REUSE_SERVER=1 npm run test:e2e` |
| `AERO_PLAYWRIGHT_EXPOSE_GC` | When set to `1`, Playwright will pass `--expose-gc` to Chromium (via `--js-flags=--expose-gc`) for tests that need manual GC. | `0` | `playwright.config.ts`, `playwright.gpu.config.ts` | `AERO_PLAYWRIGHT_EXPOSE_GC=1 npm run test:e2e -- --project chromium` |
| `AERO_PLAYWRIGHT_DEV_PORT` | TCP port for the Playwright dev harness server (`npm run dev:harness`). | Auto-detected free port starting at `5173` | `playwright.config.ts`, `playwright.gpu.config.ts` | `AERO_PLAYWRIGHT_DEV_PORT=5174 npm run test:e2e` |
| `AERO_PLAYWRIGHT_DEV_ORIGIN` | Origin (URL, must include explicit port) for the Playwright dev harness server. When set, it overrides `AERO_PLAYWRIGHT_DEV_PORT` and is exported back into the environment for tests that need the resolved origin. | Auto: `http://127.0.0.1:<devPort>` | `playwright.config.ts`, `playwright.gpu.config.ts` | `AERO_PLAYWRIGHT_DEV_ORIGIN=http://127.0.0.1:5174 npm run test:e2e` |
| `AERO_PLAYWRIGHT_PREVIEW_PORT` | TCP port for the Playwright COI preview server (`npm run serve:coi:harness`). | Auto-detected free port starting at `4173` | `playwright.config.ts`, `playwright.gpu.config.ts` | `AERO_PLAYWRIGHT_PREVIEW_PORT=4174 npm run test:e2e` |
| `AERO_PLAYWRIGHT_PREVIEW_ORIGIN` | Origin (URL, must include explicit port) for the Playwright COI preview server. When set, it overrides `AERO_PLAYWRIGHT_PREVIEW_PORT` and is exported back into the environment for tests that need the resolved origin. | Auto: `http://127.0.0.1:<previewPort>` | `playwright.config.ts`, `playwright.gpu.config.ts` | `AERO_PLAYWRIGHT_PREVIEW_ORIGIN=http://127.0.0.1:4174 npm run test:e2e` |
| `AERO_PLAYWRIGHT_CSP_PORT` | TCP port for the Playwright CSP test server (`node server/poc-server.mjs`). | Auto-detected free port starting at `4180` | `playwright.config.ts`, `playwright.gpu.config.ts` | `AERO_PLAYWRIGHT_CSP_PORT=4181 npm run test:e2e` |
| `AERO_PLAYWRIGHT_CSP_ORIGIN` | Origin (URL, must include explicit port) for the Playwright CSP test server. When set, it overrides `AERO_PLAYWRIGHT_CSP_PORT` and is exported back into the environment for tests that need the resolved origin. | Auto: `http://127.0.0.1:<cspPort>` | `playwright.config.ts`, `playwright.gpu.config.ts` | `AERO_PLAYWRIGHT_CSP_ORIGIN=http://127.0.0.1:4181 npm run test:e2e` |
| `VITE_DISABLE_COOP_COEP` | Disable COOP/COEP response headers on dev/preview servers (useful for validating the non-`SharedArrayBuffer` fallback). Accepts `1/0/true/false/yes/no/on/off`. | `0` | `vite.harness.config.ts`, `web/vite.config.ts`, `web/scripts/serve.cjs`, `server/poc-server.mjs` | `VITE_DISABLE_COOP_COEP=1 npm run dev` |

## Backend / proxy URL variables (used by networking tooling)

These are not required for the core build/test pipeline, but are common when running local networking relays.

| Variable | Meaning | Default | Consumed by | Examples |
| --- | --- | --- | --- | --- |
| `UDP_RELAY_BASE_URL` | Base URL of the UDP relay service (`proxy/webrtc-udp-relay`) used by `backend/aero-gateway` to return `udpRelay` connection metadata in `POST /session`. Accepts `http(s)://` or `ws(s)://`. Browser clients must normalize between HTTP and WebSocket schemes when calling relay endpoints (e.g. `fetch()` does not support `ws(s)://`). | *(unset)* | `backend/aero-gateway` | `UDP_RELAY_BASE_URL=https://relay.example.com`, `UDP_RELAY_BASE_URL=wss://relay.example.com` |
| `UDP_RELAY_AUTH_MODE` | Relay auth mode used by `backend/aero-gateway` when minting `udpRelay.token` (`none`, `api_key`, `jwt`). | `none` | `backend/aero-gateway` | `UDP_RELAY_AUTH_MODE=jwt` |
| `UDP_RELAY_API_KEY` | API key to return when `UDP_RELAY_AUTH_MODE=api_key` (intended for local/dev only). | *(unset)* | `backend/aero-gateway` | `UDP_RELAY_API_KEY=dev-key` |
| `UDP_RELAY_JWT_SECRET` | HS256 secret used when `UDP_RELAY_AUTH_MODE=jwt` (gateway mints short-lived JWTs for the relay). | *(unset)* | `backend/aero-gateway` | `UDP_RELAY_JWT_SECRET=...` |
| `UDP_RELAY_TOKEN_TTL_SECONDS` | Token lifetime in seconds for gateway-minted relay credentials. | `300` | `backend/aero-gateway` | `UDP_RELAY_TOKEN_TTL_SECONDS=300` |
| `UDP_RELAY_AUDIENCE` | Optional JWT `aud` claim when `UDP_RELAY_AUTH_MODE=jwt`. | *(unset)* | `backend/aero-gateway` | `UDP_RELAY_AUDIENCE=relay` |
| `UDP_RELAY_ISSUER` | Optional JWT `iss` claim when `UDP_RELAY_AUTH_MODE=jwt`. | *(unset)* | `backend/aero-gateway` | `UDP_RELAY_ISSUER=aero-gateway` |
| `AERO_WEBRTC_UDP_RELAY_PUBLIC_BASE_URL` | Public base URL for the WebRTC UDP relay (logging only). Must be a valid URL. | *(unset)* | `proxy/webrtc-udp-relay` | `AERO_WEBRTC_UDP_RELAY_PUBLIC_BASE_URL=https://relay.example.com` |
| `AERO_STUN_URLS` | Comma-separated STUN URLs (e.g. `stun:stun.l.google.com:19302`). | *(unset)* | `proxy/webrtc-udp-relay` | `AERO_STUN_URLS=stun:stun.l.google.com:19302` |
| `AERO_TURN_URLS` | Comma-separated TURN URLs. | *(unset)* | `proxy/webrtc-udp-relay` | `AERO_TURN_URLS=turn:turn.example.com:3478?transport=udp` |
| `UDP_BINDING_IDLE_TIMEOUT` | Close idle UDP port bindings after this duration (Go duration, e.g. `60s`). | `60s` | `proxy/webrtc-udp-relay` | `UDP_BINDING_IDLE_TIMEOUT=30s` |
| `UDP_INBOUND_FILTER_MODE` | Inbound UDP filtering mode (`address_and_port` or `any`). `any` behaves like full-cone NAT and is less safe. | `address_and_port` | `proxy/webrtc-udp-relay` | `UDP_INBOUND_FILTER_MODE=address_and_port` / `UDP_INBOUND_FILTER_MODE=any` |
| `UDP_REMOTE_ALLOWLIST_IDLE_TIMEOUT` | Expire inactive remote allowlist entries after this duration (only applies when `UDP_INBOUND_FILTER_MODE=address_and_port`). | Defaults to `UDP_BINDING_IDLE_TIMEOUT` | `proxy/webrtc-udp-relay` | `UDP_REMOTE_ALLOWLIST_IDLE_TIMEOUT=30s` |
| `MAX_ALLOWED_REMOTES_PER_BINDING` | Cap the number of remote endpoints tracked per UDP binding allowlist (DoS hardening). | `1024` | `proxy/webrtc-udp-relay` | `MAX_ALLOWED_REMOTES_PER_BINDING=1024` |
| `WEBRTC_DATACHANNEL_MAX_MESSAGE_BYTES` | Advertised WebRTC DataChannel max message size (`a=max-message-size`). Best-effort guardrail for compliant peers (0 = auto). | Auto: `max(MAX_DATAGRAM_PAYLOAD_BYTES+24, L2_MAX_MESSAGE_BYTES)+256` (`24` is the v2 IPv6 UDP relay frame overhead; see `proxy/webrtc-udp-relay/internal/udpproto.MaxFrameOverheadBytes`) | `proxy/webrtc-udp-relay` | `WEBRTC_DATACHANNEL_MAX_MESSAGE_BYTES=65536` |
| `WEBRTC_SCTP_MAX_RECEIVE_BUFFER_BYTES` | Hard cap on SCTP receive buffering before `DataChannel.OnMessage` runs (0 = auto; must be ≥ `WEBRTC_DATACHANNEL_MAX_MESSAGE_BYTES` and ≥ `1500`). | Auto: `max(1048576, 2*WEBRTC_DATACHANNEL_MAX_MESSAGE_BYTES)` | `proxy/webrtc-udp-relay` | `WEBRTC_SCTP_MAX_RECEIVE_BUFFER_BYTES=1048576` |
| `WEBRTC_SESSION_CONNECT_TIMEOUT` | Close server-side WebRTC sessions that fail to reach `PeerConnectionStateConnected` within this duration (prevents session leaks; Go duration). | `30s` | `proxy/webrtc-udp-relay` | `WEBRTC_SESSION_CONNECT_TIMEOUT=30s` |

## L2 tunnel proxy variables (`crates/aero-l2-proxy`)

These variables configure the L2 tunnel termination proxy used by the “Option C” networking path (see [`docs/l2-tunnel-runbook.md`](./l2-tunnel-runbook.md) for a practical guide).

This table is **not exhaustive** (there are additional stack tuning and observability knobs); it covers the most commonly-used and security-sensitive options.

| Variable | Meaning | Default | Consumed by | Examples |
| --- | --- | --- | --- | --- |
| `AERO_L2_PROXY_LISTEN_ADDR` | Socket address to listen on for the proxy’s HTTP/WebSocket endpoints (including `/l2` and legacy alias `/eth`, plus `/metrics`, `/healthz`). Alias: `AERO_L2_PROXY_BIND_ADDR`. | `0.0.0.0:8090` | `crates/aero-l2-proxy` | `AERO_L2_PROXY_LISTEN_ADDR=127.0.0.1:8090 cargo run --locked -p aero-l2-proxy` |
| `AERO_L2_ALLOWED_ORIGINS` | Comma-separated allowlist of normalized Origin values allowed to upgrade to `/l2` (and legacy alias `/eth`). Supports `"*"` to allow any valid Origin (but still requires the header unless `AERO_L2_OPEN=1`). Legacy alias: `ALLOWED_ORIGINS`. | Same-host only (empty allowlist) | `crates/aero-l2-proxy` | `AERO_L2_ALLOWED_ORIGINS=http://localhost:5173 cargo run --locked -p aero-l2-proxy` |
| `AERO_L2_ALLOWED_ORIGINS_EXTRA` | Additional comma-separated Origin entries appended to the base allowlist (useful when `ALLOWED_ORIGINS` is shared across services). | *(unset)* | `crates/aero-l2-proxy` | `ALLOWED_ORIGINS=https://example.com AERO_L2_ALLOWED_ORIGINS_EXTRA=,http://localhost:5173 cargo run --locked -p aero-l2-proxy` |
| `AERO_L2_ALLOWED_HOSTS` | Comma-separated allowlist of Host header values accepted at WebSocket upgrade time. When unset/empty, Host validation is disabled. | *(unset)* | `crates/aero-l2-proxy` | `AERO_L2_ALLOWED_HOSTS=proxy.example.com` |
| `AERO_L2_TRUST_PROXY_HOST` | When true, prefer proxy-provided host headers (`Forwarded: host=` / `X-Forwarded-Host`) over `Host` when validating `AERO_L2_ALLOWED_HOSTS`. Only enable behind a trusted reverse proxy. | `0` | `crates/aero-l2-proxy` | `AERO_L2_TRUST_PROXY_HOST=1` |
| `AERO_L2_OPEN` | Security escape hatch: when set to exactly `1`, disable Origin enforcement (trusted local development only). Note: this does **not** automatically disable authentication. | `0` | `crates/aero-l2-proxy` | `AERO_L2_OPEN=1 AERO_L2_AUTH_MODE=none cargo run --locked -p aero-l2-proxy` |
| `AERO_L2_INSECURE_ALLOW_NO_AUTH` | When set to exactly `1` alongside `AERO_L2_OPEN=1`, allow the proxy to start with no auth configured (explicit unauthenticated mode). | `0` | `crates/aero-l2-proxy` | `AERO_L2_OPEN=1 AERO_L2_INSECURE_ALLOW_NO_AUTH=1 cargo run --locked -p aero-l2-proxy` |
| `AERO_L2_AUTH_MODE` | Authentication mode for `/l2` upgrades (and legacy alias `/eth`) (`none`, `token`, `session`, `session_or_token`, `session_and_token`, `jwt`, `cookie_or_jwt`, …). | Auto-detected (may fail if no auth is configured) | `crates/aero-l2-proxy` | `AERO_L2_AUTH_MODE=jwt AERO_L2_JWT_SECRET=... cargo run --locked -p aero-l2-proxy` |
| `AERO_L2_API_KEY` | Static API key used when token auth is enabled. Legacy alias: `AERO_L2_TOKEN`. | *(unset)* | `crates/aero-l2-proxy` | `AERO_L2_AUTH_MODE=token AERO_L2_API_KEY=sekrit cargo run --locked -p aero-l2-proxy` |
| `AERO_L2_SESSION_SECRET` | HMAC secret used to verify the `aero_session` cookie when session/cookie auth is enabled. Also accepts shared `SESSION_SECRET` / `AERO_GATEWAY_SESSION_SECRET`. | *(unset)* | `crates/aero-l2-proxy` | `AERO_L2_AUTH_MODE=session AERO_L2_SESSION_SECRET=sekrit cargo run --locked -p aero-l2-proxy` |
| `AERO_L2_JWT_SECRET` | HMAC secret used to verify JWTs when JWT auth is enabled. | *(unset)* | `crates/aero-l2-proxy` | `AERO_L2_AUTH_MODE=jwt AERO_L2_JWT_SECRET=sekrit cargo run --locked -p aero-l2-proxy` |
| `AERO_L2_JWT_AUDIENCE` | Optional expected JWT `aud` claim (JWT auth modes). | *(unset)* | `crates/aero-l2-proxy` | `AERO_L2_JWT_AUDIENCE=aero` |
| `AERO_L2_JWT_ISSUER` | Optional expected JWT `iss` claim (JWT auth modes). | *(unset)* | `crates/aero-l2-proxy` | `AERO_L2_JWT_ISSUER=aero-gateway` |
| `AERO_L2_MAX_CONNECTIONS` | Process-wide concurrent tunnel cap (`0` disables). | `64` | `crates/aero-l2-proxy` | `AERO_L2_MAX_CONNECTIONS=128` |
| `AERO_L2_MAX_CONNECTIONS_PER_SESSION` | Concurrent tunnel cap per authenticated session principal (`0` disables). Legacy alias: `AERO_L2_MAX_TUNNELS_PER_SESSION`. | `0` | `crates/aero-l2-proxy` | `AERO_L2_MAX_CONNECTIONS_PER_SESSION=4` |
| `AERO_L2_MAX_CONNECTIONS_PER_IP` | Concurrent tunnel cap per client IP (`0` disables). Note: only meaningful when the proxy can determine a stable client IP (see `AERO_L2_TRUST_PROXY`). | `0` | `crates/aero-l2-proxy` | `AERO_L2_MAX_CONNECTIONS_PER_IP=8` |
| `AERO_L2_TRUST_PROXY` | When true, trust proxy-provided client IP headers (`Forwarded` / `X-Forwarded-For`) for per-IP limits and logging. Only enable behind a trusted reverse proxy. | `0` | `crates/aero-l2-proxy` | `AERO_L2_TRUST_PROXY=1` |
| `AERO_L2_MAX_BYTES_PER_CONNECTION` | Total bytes per connection (rx + tx, `0` disables). | `0` | `crates/aero-l2-proxy` | `AERO_L2_MAX_BYTES_PER_CONNECTION=100000000` |
| `AERO_L2_MAX_FRAMES_PER_SECOND` | Inbound messages per second per connection (`0` disables). | `0` | `crates/aero-l2-proxy` | `AERO_L2_MAX_FRAMES_PER_SECOND=1000` |
| `AERO_L2_MAX_FRAME_PAYLOAD` | Max `FRAME` payload bytes for the L2 tunnel protocol (defense in depth). Legacy alias: `AERO_L2_MAX_FRAME_SIZE`. Values must be positive integers; `0`/blank are treated as unset (defaults apply). | `2048` | `crates/aero-l2-proxy`, `backend/aero-gateway` (surfaced via `POST /session`) | `AERO_L2_MAX_FRAME_PAYLOAD=2048` |
| `AERO_L2_MAX_CONTROL_PAYLOAD` | Max control payload bytes for the L2 tunnel protocol (PING/PONG/ERROR; defense in depth). Values must be positive integers; `0`/blank are treated as unset (defaults apply). | `256` | `crates/aero-l2-proxy`, `backend/aero-gateway` (surfaced via `POST /session`) | `AERO_L2_MAX_CONTROL_PAYLOAD=256` |
| `AERO_L2_CAPTURE_DIR` | When set, write a per-tunnel PCAPNG capture file into this directory. | *(unset)* | `crates/aero-l2-proxy` | `AERO_L2_CAPTURE_DIR=/tmp/aero-l2-captures` |
| `AERO_L2_CAPTURE_MAX_BYTES` | Maximum **capture file size** written per tunnel session (includes PCAPNG container overhead, not just Ethernet payload). `0` disables the cap. | `67108864` (64 MiB) | `crates/aero-l2-proxy` | `AERO_L2_CAPTURE_MAX_BYTES=67108864` |
| `AERO_L2_CAPTURE_FLUSH_INTERVAL_MS` | Flush interval for capture writers. `0` disables periodic flushing (capture is flushed on close). | `1000` | `crates/aero-l2-proxy` | `AERO_L2_CAPTURE_FLUSH_INTERVAL_MS=1000` |
| `AERO_L2_PING_INTERVAL_MS` | When set to a positive integer, the proxy will send protocol-level PINGs at this interval and record RTT metrics. | *(unset)* | `crates/aero-l2-proxy` | `AERO_L2_PING_INTERVAL_MS=1000` |
| `AERO_L2_IDLE_TIMEOUT_MS` | When set to a positive integer, close the tunnel if no inbound messages are received for this duration. | *(unset)* | `crates/aero-l2-proxy` | `AERO_L2_IDLE_TIMEOUT_MS=30000` |
| `AERO_L2_ALLOW_PRIVATE_IPS` | When true, allow egress to RFC1918/private/reserved IPv4 ranges (dev-only; production should keep this off). | `0` | `crates/aero-l2-proxy` | `AERO_L2_ALLOW_PRIVATE_IPS=1` |
| `AERO_L2_ALLOWED_TCP_PORTS` | Comma-separated TCP destination port allowlist. When set, TCP egress is denied by default unless the port is listed. | Allow all | `crates/aero-l2-proxy` | `AERO_L2_ALLOWED_TCP_PORTS=80,443` |
| `AERO_L2_ALLOWED_UDP_PORTS` | Comma-separated UDP destination port allowlist. When set, UDP egress is denied by default unless the port is listed. | Allow all | `crates/aero-l2-proxy` | `AERO_L2_ALLOWED_UDP_PORTS=53,3478` |
| `AERO_L2_ALLOWED_DOMAINS` | Comma-separated DNS name suffix allowlist. When non-empty, outbound DNS/TCP destinations must match at least one suffix. | Allow all | `crates/aero-l2-proxy` | `AERO_L2_ALLOWED_DOMAINS=example.com,example.org` |
| `AERO_L2_BLOCKED_DOMAINS` | Comma-separated DNS name suffix denylist (applied before `AERO_L2_ALLOWED_DOMAINS`). | *(unset)* | `crates/aero-l2-proxy` | `AERO_L2_BLOCKED_DOMAINS=metadata.google.internal` |

## Deprecated aliases (will be removed)

These names are still accepted but emit warnings. Prefer the canonical variables above.

| Deprecated | Use instead |
| --- | --- |
| `AERO_WEB_DIR` | `AERO_NODE_DIR` |
| `WEB_DIR` | `AERO_NODE_DIR` |
| `AERO_WASM_DIR` | `AERO_WASM_CRATE_DIR` |
| `WASM_CRATE_DIR` | `AERO_WASM_CRATE_DIR` |
