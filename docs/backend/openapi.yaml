openapi: 3.1.0
info:
  title: Aero Gateway HTTP API
  version: 1.0.0
  description: |
    HTTP endpoints provided by the Aero networking gateway.

    Notes:
    - WebSocket endpoints are intentionally not modeled as OpenAPI operations:
      - `/tcp` and `/tcp-mux` are documented in `docs/backend/01-aero-gateway-api.md`.
      - `/l2` is served by `aero-l2-proxy` behind the same reverse proxy origin and
        is documented in `docs/l2-tunnel-protocol.md`.
servers:
  - url: http://localhost:8080
    description: Local development (example)
  - url: https://example.com
    description: Production (example)
  - url: https://gateway.example.com
    description: Production alternative (example)
  - url: https://gateway.example.com/aero
    description: Production behind a base path (example)
tags:
  - name: session
    description: Session bootstrap and cookies
  - name: udpRelay
    description: UDP relay token minting (WebRTC UDP proxy)
  - name: dns
    description: DNS-over-HTTPS (RFC 8484)
paths:
  /session:
    post:
      tags: [session]
      summary: Create or refresh a gateway session
      description: |
        Issues (or refreshes) a gateway session cookie (`aero_session`) used
        by authenticated endpoints such as `/dns-query` and the `/tcp`
        WebSocket upgrade.

        Clients should call this during startup with `credentials: include`
        so the browser stores the cookie.
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSessionRequest'
            examples:
              empty:
                summary: Minimal request
                value: {}
      responses:
        '201':
          description: Session created. Cookie is returned in `Set-Cookie`.
          headers:
            Set-Cookie:
              description: Session cookie (opaque).
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateSessionResponse'
              examples:
                example:
                  value:
                    session:
                      expiresAt: '2026-01-10T00:00:00Z'
                    endpoints:
                      tcp: /tcp
                      tcpMux: /tcp-mux
                      dnsQuery: /dns-query
                      dnsJson: /dns-json
                      l2: /l2
                      udpRelayToken: /udp-relay/token
                    udpRelay:
                      baseUrl: https://relay.example.com
                      authMode: jwt
                      endpoints:
                        webrtcSignal: /webrtc/signal
                        webrtcOffer: /webrtc/offer
                        udp: /udp
                        webrtcIce: /webrtc/ice
                      token: '<jwt>'
                      expiresAt: '2026-01-10T00:05:00Z'
                    limits:
                      tcp:
                        maxConnections: 64
                        maxMessageBytes: 1048576
                        connectTimeoutMs: 10000
                        idleTimeoutMs: 300000
                      dns:
                        maxQueryBytes: 4096
                      l2:
                        maxFramePayloadBytes: 2048
                        maxControlPayloadBytes: 256
                basePathExample:
                  summary: Example when the gateway is served behind a base path
                  value:
                    session:
                      expiresAt: '2026-01-10T00:00:00Z'
                    endpoints:
                      tcp: /aero/tcp
                      tcpMux: /aero/tcp-mux
                      dnsQuery: /aero/dns-query
                      dnsJson: /aero/dns-json
                      l2: /aero/l2
                      udpRelayToken: /aero/udp-relay/token
                    limits:
                      tcp:
                        maxConnections: 64
                        maxMessageBytes: 1048576
                        connectTimeoutMs: 10000
                        idleTimeoutMs: 300000
                      dns:
                        maxQueryBytes: 4096
                      l2:
                        maxFramePayloadBytes: 2048
                        maxControlPayloadBytes: 256
        '400':
          $ref: '#/components/responses/ErrorResponse'

  /udp-relay/token:
    post:
      tags: [udpRelay]
      summary: Mint a fresh UDP relay token for the current session
      description: |
        Returns a short-lived credential for the configured UDP relay, bound
        to the caller's `aero_session` cookie.

        This endpoint is optional and only available when the gateway is
        configured with `UDP_RELAY_BASE_URL`.
      security:
        - aeroSession: []
      responses:
        '200':
          description: Token minted (or authMode=none).
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UdpRelayTokenResponse'
        '401':
          $ref: '#/components/responses/ErrorResponse'
        '403':
          $ref: '#/components/responses/ErrorResponse'
        '404':
          $ref: '#/components/responses/ErrorResponse'
        '429':
          $ref: '#/components/responses/ErrorResponse'

  /dns-query:
    get:
      tags: [dns]
      summary: DNS-over-HTTPS (GET)
      description: |
        RFC 8484 DoH GET.

        The query is passed via the `dns` query parameter as base64url without
        padding, containing a DNS message in wire format.
      security:
        - aeroSession: []
      parameters:
        - name: dns
          in: query
          required: true
          description: Base64url-encoded DNS query message (RFC 8484).
          schema:
            type: string
            minLength: 1
      responses:
        '200':
          description: DNS response message (wire format).
          content:
            application/dns-message:
              schema:
                type: string
                format: binary
        '400':
          $ref: '#/components/responses/ErrorResponse'
        '401':
          $ref: '#/components/responses/ErrorResponse'
        '403':
          $ref: '#/components/responses/ErrorResponse'
        '429':
          $ref: '#/components/responses/ErrorResponse'
        '500':
          $ref: '#/components/responses/ErrorResponse'

    post:
      tags: [dns]
      summary: DNS-over-HTTPS (POST)
      description: |
        RFC 8484 DoH POST.

        The request body is a DNS query message in wire format with
        `Content-Type: application/dns-message`.
      security:
        - aeroSession: []
      requestBody:
        required: true
        content:
          application/dns-message:
            schema:
              type: string
              format: binary
      responses:
        '200':
          description: DNS response message (wire format).
          content:
            application/dns-message:
              schema:
                type: string
                format: binary
        '400':
          $ref: '#/components/responses/ErrorResponse'
        '401':
          $ref: '#/components/responses/ErrorResponse'
        '403':
          $ref: '#/components/responses/ErrorResponse'
        '429':
          $ref: '#/components/responses/ErrorResponse'
        '500':
          $ref: '#/components/responses/ErrorResponse'

components:
  securitySchemes:
    aeroSession:
      type: apiKey
      in: cookie
      name: aero_session

  responses:
    ErrorResponse:
      description: Error response (shape is stable; messages are not).
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  schemas:
    CreateSessionRequest:
      type: object
      additionalProperties: false
      properties:
        origin:
          type: string
          description: |
            Optional explicit origin string for debugging/telemetry. Gateways
            should prefer the HTTP `Origin` header when present.
        clientVersion:
          type: string
          description: Optional client version string.

    CreateSessionResponse:
      type: object
      additionalProperties: false
      required: [session, endpoints, limits]
      properties:
        session:
          type: object
          additionalProperties: false
          required: [expiresAt]
          properties:
            expiresAt:
              type: string
              format: date-time
              description: UTC timestamp after which a new session is required.
        endpoints:
          type: object
          additionalProperties: false
          description: |
            Discovered gateway endpoint paths (absolute paths).

            Values are rooted at the gateway's configured public base path (the
            `.pathname` of `PUBLIC_BASE_URL`). For example, if
            `PUBLIC_BASE_URL=https://gateway.example.com/aero`, then `tcp` is
            `/aero/tcp` and `l2` is `/aero/l2`.
          required: [tcp, tcpMux, dnsQuery, dnsJson, l2, udpRelayToken]
          properties:
            tcp:
              type: string
              description: Path for the TCP WebSocket endpoint (upgrade).
              example: /tcp
            tcpMux:
              type: string
              description: Path for the multiplexed TCP WebSocket endpoint (upgrade).
              example: /tcp-mux
            dnsQuery:
              type: string
              description: Path for DNS-over-HTTPS.
              example: /dns-query
            dnsJson:
              type: string
              description: Path for the DNS JSON convenience endpoint.
              example: /dns-json
            l2:
              type: string
              description: |
                Path for the L2 tunnel WebSocket endpoint (`aero-l2-tunnel-v1`).

                This endpoint is served by `aero-l2-proxy` behind the edge proxy,
                not by the `aero-gateway` Node.js process.
              example: /l2
            udpRelayToken:
              type: string
              description: |
                Path for the UDP relay token refresh endpoint.

                This endpoint may return 404 when the gateway is not configured
                with `UDP_RELAY_BASE_URL`.
              example: /udp-relay/token
        udpRelay:
          $ref: '#/components/schemas/UdpRelayInfo'
          description: |
            Optional UDP relay configuration. Present when the gateway is
            configured with `UDP_RELAY_BASE_URL`.
        limits:
          type: object
          additionalProperties: false
          required: [tcp, dns, l2]
          properties:
            tcp:
              type: object
              additionalProperties: false
              required: [maxConnections, maxMessageBytes, connectTimeoutMs, idleTimeoutMs]
              properties:
                maxConnections:
                  type: integer
                  minimum: 1
                  description: |
                    Maximum concurrent TCP proxy connections for this session.
                    `/tcp-mux` streams count as connections.
                maxMessageBytes:
                  type: integer
                  minimum: 1
                  description: |
                    Maximum size in bytes of a single WebSocket message payload.
                    Clients should chunk outgoing writes accordingly.
                connectTimeoutMs:
                  type: integer
                  minimum: 1
                  description: TCP connect timeout in milliseconds.
                idleTimeoutMs:
                  type: integer
                  minimum: 1
                  description: |
                    Idle timeout in milliseconds after which inactive TCP proxy
                    connections may be closed.
            dns:
              type: object
              additionalProperties: false
              required: [maxQueryBytes]
              properties:
                maxQueryBytes:
                  type: integer
                  minimum: 1
                  description: Maximum accepted DNS query message size in bytes.
            l2:
              type: object
              additionalProperties: false
              required: [maxFramePayloadBytes, maxControlPayloadBytes]
              properties:
                maxFramePayloadBytes:
                  type: integer
                  minimum: 1
                  description: Maximum payload size for L2 tunnel FRAME messages in bytes.
                maxControlPayloadBytes:
                  type: integer
                  minimum: 1
                  description: Maximum payload size for L2 tunnel control messages (PING/PONG/ERROR) in bytes.

    UdpRelayEndpoints:
      type: object
      additionalProperties: false
      required: [webrtcSignal, webrtcOffer, udp, webrtcIce]
      properties:
        webrtcSignal:
          type: string
          description: Path for WebRTC signaling over WebSocket (trickle ICE).
          example: /webrtc/signal
        webrtcOffer:
          type: string
          description: Path for HTTP offer/answer signaling (non-trickle ICE fallback).
          example: /webrtc/offer
        udp:
          type: string
          description: Path for WebSocket UDP fallback (non-WebRTC).
          example: /udp
        webrtcIce:
          type: string
          description: Path for ICE server discovery.
          example: /webrtc/ice

    UdpRelayInfo:
      type: object
      additionalProperties: false
      required: [baseUrl, authMode, endpoints]
      properties:
        baseUrl:
          type: string
          description: |
            Base URL for the UDP relay service.

            May be an `http(s)://` or `ws(s)://` URL (the gateway accepts
            `http:`, `https:`, `ws:`, `wss:`).

            Clients must normalize schemes depending on the endpoint transport:

            - HTTP endpoints (`/webrtc/ice`, `/webrtc/offer`) require `http(s)://`
              (`ws://` → `http://`, `wss://` → `https://`).
            - WebSocket endpoints (`/webrtc/signal`, `/udp`) require `ws(s)://`
              (`http://` → `ws://`, `https://` → `wss://`).

            Note: browser `fetch()` does not support `ws://` or `wss://` URLs.
          example: https://relay.example.com
        authMode:
          type: string
          enum: [none, api_key, jwt]
          description: |
            Authentication mode for the UDP relay.

            `token` and `expiresAt` are omitted when `authMode=none`.
        endpoints:
          $ref: '#/components/schemas/UdpRelayEndpoints'
        token:
          type: string
          description: |
            Short-lived relay credential (api key or JWT), depending on auth mode.
        expiresAt:
          type: string
          format: date-time
          description: UTC expiration timestamp for `token`.

    UdpRelayTokenResponse:
      type: object
      additionalProperties: false
      required: [authMode]
      properties:
        authMode:
          type: string
          enum: [none, api_key, jwt]
        token:
          type: string
        expiresAt:
          type: string
          format: date-time

    ErrorResponse:
      type: object
      additionalProperties: false
      required: [error]
      properties:
        error:
          type: string
          description: Stable, machine-readable error identifier.
        message:
          type: string
          description: Optional human-readable message (not stable).
        retryable:
          type: boolean
          description: Whether the client should retry automatically.
