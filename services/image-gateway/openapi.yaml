openapi: 3.0.3
info:
  title: image-gateway
  version: 0.1.0
  description: |
    Reference API for uploading disk images to S3 via multipart upload and streaming them securely via CloudFront signed cookies/URLs.

servers:
  - url: http://localhost:3000

components:
  parameters:
    XUserId:
      name: X-User-Id
      in: header
      required: false
      schema:
        type: string
      description: |
        Dev auth stub caller identity. Required when AUTH_MODE=dev.
  schemas:
    ApiError:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
          required: [code, message]
      required: [error]

    CreateImageResponse:
      type: object
      properties:
        imageId:
          type: string
        uploadId:
          type: string
        partSize:
          type: integer
          format: int64
      required: [imageId, uploadId, partSize]

    UploadUrlRequest:
      type: object
      properties:
        uploadId:
          type: string
        partNumber:
          type: integer
          format: int32
          minimum: 1
          maximum: 10000
      required: [uploadId, partNumber]

    UploadUrlResponse:
      type: object
      properties:
        url:
          type: string
      required: [url]

    CompleteImageRequest:
      type: object
      properties:
        uploadId:
          type: string
        parts:
          type: array
          items:
            type: object
            properties:
              partNumber:
                type: integer
                format: int32
                minimum: 1
                maximum: 10000
              etag:
                type: string
            required: [partNumber, etag]
      required: [uploadId, parts]

    CompleteImageResponse:
      type: object
      properties:
        ok:
          type: boolean
        size:
          type: integer
          format: int64
          nullable: true
        etag:
          type: string
          nullable: true
        lastModified:
          type: string
          format: date-time
          nullable: true
      required: [ok]

    ImageMetadataResponse:
      type: object
      properties:
        size:
          type: integer
          format: int64
          nullable: true
        etag:
          type: string
          nullable: true
        lastModified:
          type: string
          format: date-time
          nullable: true
        url:
          type: string
      required: [url]

    SignedCookie:
      type: object
      properties:
        name:
          type: string
        value:
          type: string
        attributes:
          type: array
          items:
            type: string
      required: [name, value, attributes]

    StreamAuth:
      oneOf:
        - type: object
          properties:
            type:
              type: string
              enum: ["cookie"]
            expiresAt:
              type: string
              format: date-time
            cookies:
              type: array
              items:
                $ref: "#/components/schemas/SignedCookie"
          required: [type, expiresAt, cookies]
        - type: object
          properties:
            type:
              type: string
              enum: ["url"]
            expiresAt:
              type: string
              format: date-time
          required: [type, expiresAt]
        - type: object
          properties:
            type:
              type: string
              enum: ["none"]
          required: [type]

    StreamUrlResponse:
      type: object
      properties:
        url:
          type: string
        auth:
          $ref: "#/components/schemas/StreamAuth"
        size:
          type: integer
          format: int64
          nullable: true
        etag:
          type: string
          nullable: true
      required: [url, auth]

paths:
  /health:
    get:
      summary: Liveness check
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                required: [ok]

  /healthz:
    get:
      summary: Liveness check (alias)
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                required: [ok]

  /readyz:
    get:
      summary: Readiness check (verifies S3 bucket connectivity)
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                required: [ok]
        default:
          description: Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /v1/images:
    post:
      summary: Create a new image record and start an S3 multipart upload
      parameters:
        - $ref: "#/components/parameters/XUserId"
      responses:
        "200":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateImageResponse"
        default:
          description: Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /v1/images/{imageId}/upload-url:
    post:
      summary: Get a presigned URL for uploading a multipart part to S3
      parameters:
        - $ref: "#/components/parameters/XUserId"
        - name: imageId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UploadUrlRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UploadUrlResponse"
        default:
          description: Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /v1/images/{imageId}/complete:
    post:
      summary: Complete an S3 multipart upload and store resulting object metadata
      parameters:
        - $ref: "#/components/parameters/XUserId"
        - name: imageId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CompleteImageRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompleteImageResponse"
        default:
          description: Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /v1/images/{imageId}/metadata:
    get:
      summary: Fetch stored metadata for an image
      parameters:
        - $ref: "#/components/parameters/XUserId"
        - name: imageId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ImageMetadataResponse"
        default:
          description: Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /v1/images/{imageId}/stream-url:
    get:
      summary: Obtain a stable streaming URL plus CloudFront auth material (cookies or signed URL)
      parameters:
        - $ref: "#/components/parameters/XUserId"
        - name: imageId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StreamUrlResponse"
        default:
          description: Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /v1/images/{imageId}/range:
    get:
      summary: Range proxy fallback (streams bytes from S3 using GetObject + Range)
      description: |
        Development-only fallback that proxies bytes through the service.
        Only single-range `Range: bytes=start-end` requests are supported.
        When `If-Range` is provided, the service returns `412 Precondition Failed` instead of
        falling back to a full-body `200` response.
      parameters:
        - $ref: "#/components/parameters/XUserId"
        - name: imageId
          in: path
          required: true
          schema:
            type: string
        - name: Range
          in: header
          required: false
          schema:
            type: string
          description: Standard HTTP Range header (e.g. "bytes=0-1048575")
        - name: If-Range
          in: header
          required: false
          schema:
            type: string
          description: |
            ETag validator for a ranged request. When supplied alongside `Range`, the service
            returns `412 Precondition Failed` if the current image ETag does not match.
      responses:
        "200":
          description: Full object
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        "206":
          description: Partial content
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        "412":
          description: Precondition Failed (If-Range did not match current ETag)
          headers:
            ETag:
              schema:
                type: string
              description: Current ETag for the image object
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        default:
          description: Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

    head:
      summary: Range proxy metadata (HEAD)
      parameters:
        - $ref: "#/components/parameters/XUserId"
        - name: imageId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
        default:
          description: Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
