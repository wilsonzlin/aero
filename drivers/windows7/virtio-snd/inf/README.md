<!-- SPDX-License-Identifier: MIT OR Apache-2.0 -->

# `inf/` - driver package staging directory

This folder is intended to be the **exact directory you point Windows to** during installation:

- Device Manager → **Have Disk…** → select the desired `*.inf`
- `pnputil -i -a <path-to-inf>` (Windows 7)

In a finished package, this directory contains the driver package payload:

- One or more driver binaries (built output; copied in manually from the build output):
  - `aero_virtio_snd.sys` (Aero contract v1 build; also used for the DebugLogs/DBG=1 build when staged)
  - `virtiosnd_legacy.sys` (optional transitional/QEMU build)
  - `virtiosnd_ioport.sys` (optional legacy virtio-pci I/O-port build; bring-up only)
- Installable INF(s):
  - `aero_virtio_snd.inf` (primary INF; strict `AERO-W7-VIRTIO` v1 binding: `PCI\VEN_1AF4&DEV_1059&REV_01`; recommended; installs service `aero_virtio_snd`)
  - `aero-virtio-snd-legacy.inf` (optional QEMU compatibility package; binds the transitional virtio-snd PCI ID `PCI\VEN_1AF4&DEV_1018`; installs `virtiosnd_legacy.sys` + service `aeroviosnd_legacy`)
  - `aero-virtio-snd-ioport.inf` (optional legacy virtio-pci I/O-port transport package; binds `PCI\VEN_1AF4&DEV_1018&REV_00`; installs `virtiosnd_ioport.sys` + service `aeroviosnd_ioport`)
  - (Optional) `virtio-snd.inf` legacy filename alias (rename `virtio-snd.inf.disabled` back to `virtio-snd.inf` to enable; kept for compatibility with older tooling/workflows; installs the same driver/service as `aero_virtio_snd.inf` and matches the same contract-v1 HWIDs, but uses `CatalogFile = aero_virtio_snd.cat`)
- Catalog(s) (generated by `Inf2Cat` and then signed):
  - `aero_virtio_snd.cat`
  - `aero-virtio-snd-legacy.cat`
  - `aero-virtio-snd-ioport.cat` (if `aero-virtio-snd-ioport.inf` is used)

> `Inf2Cat` hashes every file referenced by each INF. That means the referenced `*.sys` must exist in this folder before running `..\scripts\make-cat.cmd`.

## Notes

- `..\scripts\make-cat.cmd` and `..\scripts\sign-driver.cmd` default to the **contract v1** package
  (`aero_virtio_snd.sys` + `aero_virtio_snd.inf`). Pass `legacy` to target the transitional/QEMU package
  (`virtiosnd_legacy.sys` + `aero-virtio-snd-legacy.inf`, service `aeroviosnd_legacy`).
- The MSBuild DebugLogs configuration outputs `aero_virtio_snd_dbg.sys`, but the canonical INF references
  `aero_virtio_snd.sys`. Stage it into this folder as the canonical name with:
  - `powershell -ExecutionPolicy Bypass -File ..\scripts\stage-built-sys.ps1 -Arch <x86|amd64> -Variant debuglogs -InputDir <msbuild-out>`
- The legacy I/O-port bring-up package (`aero-virtio-snd-ioport.inf`, service `aeroviosnd_ioport`) is opt-in and not currently covered by the helper scripts.
- The legacy alias INF is checked in as `virtio-snd.inf.disabled` to avoid accidentally shipping/installing **two**
  INFs that match the same HWIDs.

## Bring-up toggles (registry)

The **contract v1** and **transitional/QEMU** virtio-snd INFs create per-device registry values with safe defaults (`0`):

- `HKLM\SYSTEM\CurrentControlSet\Enum\<DeviceInstancePath>\Device Parameters\Parameters\ForceNullBackend` (`REG_DWORD`)
  - `0` (default): use virtio backend
  - `1`: force the silent null backend (also allows bring-up without a working virtio transport)
- `HKLM\SYSTEM\CurrentControlSet\Enum\<DeviceInstancePath>\Device Parameters\Parameters\AllowPollingOnly` (`REG_DWORD`)
  - `0` (default): interrupt-driven (fail `START_DEVICE` if no usable interrupt resource can be discovered/connected — neither MSI/MSI-X nor INTx)
  - `1`: allow polling-only mode when no usable interrupt can be discovered/connected

Note: for backwards compatibility with older installs, the driver also checks the per-device driver registry key
(`IoOpenDeviceRegistryKey(..., PLUGPLAY_REGKEY_DRIVER, ...)`) if the values are not present under `Device Parameters`.

## MSI/MSI-X (message-signaled interrupts)

The contract v1 and transitional/QEMU packages both opt into message-signaled interrupts on Windows 7 via:

`HKR\Interrupt Management\MessageSignaledInterruptProperties`

with:

- `MSISupported = 1`
- `MessageNumberLimit = 8` (requests enough vectors for config + 4 queues, with a small buffer for future growth)

The legacy **I/O-port** bring-up package (`aero-virtio-snd-ioport.inf` / `virtiosnd_ioport.sys`) does **not** currently opt
into MSI/MSI-X.

The legacy **I/O-port** bring-up package (`aero-virtio-snd-ioport.inf` / `virtiosnd_ioport.sys`) currently creates/uses
`ForceNullBackend` only.

You can find `<DeviceInstancePath>` via **Device Manager → device → Details → “Device instance path”**.

After changing a toggle value, reboot the guest or disable/enable the device so Windows re-runs `START_DEVICE`.

- **Keep `virtio-snd.inf.disabled` in sync:** the alias INF must remain **byte-for-byte identical** to
  `aero_virtio_snd.inf` in all functional content (everything from `[Version]` onward). Only the filename and the
  leading comment/header block should differ.
  - Full package/INF invariants (recommended, from `drivers/windows7/virtio-snd/`):
    - `./scripts/lint-inf.sh`
  - Alias-only check (from the repo root):
    - `python3 drivers/windows7/virtio-snd/scripts/check-inf-alias.py`
