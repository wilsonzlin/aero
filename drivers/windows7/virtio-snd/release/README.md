<!-- SPDX-License-Identifier: MIT OR Apache-2.0 -->

# Aero virtio-snd (Windows 7) release packaging

`../scripts/package-release.ps1` stages an installable driver folder (and can optionally create a deterministic zip) from the payload files in `../inf/`.

The intent is that `inf/` contains **exactly what you would provide to Device Manager (“Have Disk…”)**:

- `aero_virtio_snd.inf`
- `aero_virtio_snd.sys` (built output; copied into `inf/`, then signed)
- `aero_virtio_snd.cat` (optional; generated by `Inf2Cat`, then signed)
- `aero-virtio-snd-legacy.inf` (optional; transitional/QEMU INF)
- `aero-virtio-snd-legacy.cat` (optional; generated by `Inf2Cat`, then signed)
- `virtiosnd_legacy.sys` (optional; transitional/QEMU build output; copied into `inf/`, then signed)
- `virtio-snd.inf.disabled` (optional; legacy filename alias; rename to `virtio-snd.inf` to enable; do not ship alongside `aero_virtio_snd.inf`)
- Any additional driver package payload files you add later (for example, coinstallers)

## Output layout

The default (contract v1) staging output is:

```text
release\<arch>\virtio-snd\
```

Where `<arch>` is auto-detected from `aero_virtio_snd.sys` (`x86` or `amd64`).

The transitional/QEMU variant stages into:

```text
release\<arch>\virtio-snd-legacy\
```

Where `<arch>` is auto-detected from `virtiosnd_legacy.sys`.

## Usage

From the repository root:

```powershell
# Stage into release\<arch>\virtio-snd\
powershell -ExecutionPolicy Bypass -File drivers/windows7/virtio-snd/scripts/package-release.ps1

# Force an arch label (and validate aero_virtio_snd.sys matches it)
powershell -ExecutionPolicy Bypass -File drivers/windows7/virtio-snd/scripts/package-release.ps1 -Arch amd64

# Stage the transitional/QEMU package into release\<arch>\virtio-snd-legacy\
powershell -ExecutionPolicy Bypass -File drivers/windows7/virtio-snd/scripts/package-release.ps1 -Variant legacy
```

## Producing both x86 + amd64 packages

Because the driver binary name is the same on both architectures (`aero_virtio_snd.sys`), you cannot keep both builds in `inf/` at the same time.

To produce both `release/x86/virtio-snd/` and `release/amd64/virtio-snd/`:

1. Stage the **x86** `aero_virtio_snd.sys` into `inf/`, generate catalogs, sign, and package:

   ```powershell
   powershell -ExecutionPolicy Bypass -File drivers/windows7/virtio-snd/scripts/stage-built-sys.ps1 -Arch x86 -InputDir <build-output-root>
   .\drivers\windows7\virtio-snd\scripts\make-cat.cmd
   .\drivers\windows7\virtio-snd\scripts\sign-driver.cmd
   powershell -ExecutionPolicy Bypass -File drivers/windows7/virtio-snd/scripts/package-release.ps1
   ```

2. Repeat for **amd64**:

   ```powershell
   powershell -ExecutionPolicy Bypass -File drivers/windows7/virtio-snd/scripts/stage-built-sys.ps1 -Arch amd64 -InputDir <build-output-root>
   .\drivers\windows7\virtio-snd\scripts\make-cat.cmd
   .\drivers\windows7\virtio-snd\scripts\sign-driver.cmd
    powershell -ExecutionPolicy Bypass -File drivers/windows7/virtio-snd/scripts/package-release.ps1
    ```

> Catalogs must be regenerated per-architecture because `Inf2Cat` hashes the staged `aero_virtio_snd.sys` / `virtiosnd_legacy.sys`.

### One-shot helper (both architectures)

The same sequence can be run by a wrapper script:

```powershell
# Contract v1 (default):
powershell -ExecutionPolicy Bypass -File drivers/windows7/virtio-snd/scripts/build-release.ps1 -Arch both -InputDir <build-output-root>

# Transitional/QEMU:
powershell -ExecutionPolicy Bypass -File drivers/windows7/virtio-snd/scripts/build-release.ps1 -Arch both -Variant legacy -InputDir <build-output-root>
```

Add `-Zip` to also create deterministic `release/out/*.zip` bundles.

### Optional: deterministic zip bundle

To also emit a deterministic zip into `release/out/`:

```powershell
powershell -ExecutionPolicy Bypass -File drivers/windows7/virtio-snd/scripts/package-release.ps1 -Zip `
  -OutDir drivers/windows7/virtio-snd/release/out
```

Generated `release/x86/`, `release/amd64/`, `release/out/`, and `*.zip` files are ignored by git (see `release/.gitignore`).
